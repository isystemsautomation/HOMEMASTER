<section style="font-family:'Segoe UI',sans-serif;padding:2rem;max-width:960px;margin:auto;">
  <div style="text-align:center;margin-bottom:2rem;">
    <img src="https://www.home-master.eu/web/image/product.image/14/image_1024/Untitled-2.webp?unique=1d6564f" alt="WLD-521-R1" style="max-width:300px;border-radius:8px;" loading="lazy">
    <h2>WLD‑521‑R1 Module Configuration</h2>
    <p>
      Configure Modbus address, baud rate, <strong>digital inputs (5)</strong>,
      <strong>relays (2)</strong>, and monitor live state via Web Serial.
      <em>1‑Wire (GPIO16) is initialized in firmware; add readings later if needed.</em>
    </p>
  </div>

  <div style="background:#f1f1f1;padding:1rem 1.5rem;margin-bottom:2rem;border-radius:6px;border-left:4px solid #007bff;">
    <strong>Active Modbus Configuration</strong><br>
    Address: <span id="live-address" style="font-weight:600;">--</span> |
    Baud Rate: <span id="live-baud" style="font-weight:600;">--</span>
  </div>

  <form id="modbus-config" style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:2rem;">
    <div>
      <label for="modbus-address"><strong>Modbus Address</strong></label>
      <select id="modbus-address" style="width:100%;padding:10px;border-radius:4px;"></select>
    </div>
    <div>
      <label for="modbus-baud"><strong>Baud Rate</strong></label>
      <select id="modbus-baud" style="width:100%;padding:10px;border-radius:4px;">
        <option>9600</option><option>19200</option><option>38400</option><option>57600</option><option>115200</option>
      </select>
    </div>
    <div style="grid-column:span 2;text-align:right;">
      <button id="connect-button" type="button" style="padding:10px 20px;background:#007bff;color:#fff;border:none;border-radius:4px;">Connect</button>
      <button id="reset-button" type="button" style="padding:10px 20px;background:#dc3545;color:#fff;border:none;border-radius:4px;margin-left:0.75rem;" disabled="">Reset Device</button>
    </div>
  </form>

  <dialog id="reset-dialog" style="border:none;border-radius:10px;padding:0;max-width:420px;width:90%;box-shadow:0 10px 30px rgba(0,0,0,.2);">
    <form id="reset-form" method="dialog" style="padding:1rem 1.25rem;">
      <h3 style="margin:.25rem 0 .5rem;">Confirm reset</h3>
      <p style="margin:.25rem 0 1rem;color:#444;">Are you sure you want to reset the module? The serial connection will be temporarily interrupted.</p>
      <div style="display:flex;justify-content:flex-end;gap:.5rem;">
        <button id="dlg-cancel" value="cancel" style="padding:.5rem .9rem;border-radius:6px;border:1px solid #ccc;background:#fff;">Cancel</button>
        <button id="dlg-confirm" value="confirm" style="padding:.5rem .9rem;border:none;border-radius:6px;background:#dc3545;color:#fff;">Reset</button>
      </div>
    </form>
  </dialog>

  <div id="log-line" style="margin-bottom:1.5rem;padding:1rem;background:#f9f9f9;border:1px solid #ccc;border-radius:6px;font-size:0.9rem;color:#333;font-family:monospace;">
    <strong>Serial Log:</strong>
    <div id="log-content" style="white-space:pre-wrap;"></div>
  </div>

  <section>
    <h2 style="font-size:1.2rem;">Digital Inputs (5)</h2>
    <div id="inputs-config" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;"></div>
  </section>

  <section>
    <h2 style="font-size:1.2rem;">Relays (2)</h2>
    <div id="relays-config" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;"></div>
  </section>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://unpkg.com/simple-web-serial@latest/dist/simple-web-serial.min.js"></script>
  <script>
    (function () {
      // ---------- Constants ----------
      const LOG_MAX = 3;
      const logBuffer = [];
      const $ = (id) => document.getElementById(id);
      const NUM_DI = 5, NUM_RLY = 2;

      // ---------- Helpers ----------
      function appendLog(label, data) {
        const logEl = $("log-content"); if (!logEl) return;
        const time = new Date().toLocaleTimeString();
        const str  = typeof data === 'string' ? data : JSON.stringify(data);
        const line = `[${time}] ${label}: ${str}`;
        logBuffer.unshift(line); if (logBuffer.length > LOG_MAX) logBuffer.pop();
        logEl.innerText = logBuffer.join('\\n');
      }

      // Populate Modbus address dropdown 1..255
      (function populateAddresses() {
        const addrSelect = $('modbus-address'); if (!addrSelect) return;
        for (let i = 1; i <= 255; i++) {
          const opt = document.createElement('option');
          opt.value = i; opt.textContent = i;
          addrSelect.appendChild(opt);
        }
      })();

      // ---------- Web Serial ----------
      const connection = SimpleWebSerial.setupSerialConnection({
        requestAccessOnPageLoad: false,
        requestElement: 'connect-button'
      });

      function isPortOpen() {
        try { return typeof connection.isOpen === 'function' ? connection.isOpen() : !!connection.port; }
        catch { return false; }
      }
      function updateResetEnabled() {
        const btn = $('reset-button'); if (btn) btn.disabled = !isPortOpen();
      }

      connection.on('status', (modbus) => {
        $('live-address').textContent = (modbus && 'address' in modbus) ? modbus.address : '--';
        $('live-baud').textContent    = (modbus && 'baud' in modbus)    ? modbus.baud    : '--';
        if (modbus && modbus.address) $('modbus-address').value = modbus.address;
        if (modbus && modbus.baud)    $('modbus-baud').value    = String(modbus.baud);
        updateResetEnabled();
      });
      connection.on('open',  updateResetEnabled);
      connection.on('close', updateResetEnabled);
      connection.on('message', (msg) => appendLog("WLD-521-R1", msg));

      // ---------- Modbus value changes ----------
      $('modbus-address').addEventListener('input', updateModbus);
      $('modbus-baud').addEventListener('input', updateModbus);
      async function updateModbus() {
        const mb_address = parseInt($('modbus-address').value || "1", 10);
        const mb_baud = parseInt($('modbus-baud').value || "19200", 10);
        try { await connection.send("values", { mb_address, mb_baud }); }
        catch (e) { appendLog("Error", "Failed to send Modbus values"); }
      }

      // ---------- Reset Dialog ----------
      const resetBtn   = $('reset-button');
      const dlg        = $('reset-dialog');
      const dlgCancel  = $('dlg-cancel');
      const dlgConfirm = $('dlg-confirm');
      updateResetEnabled();

      resetBtn.addEventListener('click', () => {
        updateResetEnabled();
        if (resetBtn.disabled) { appendLog("System", "Connect to the device before resetting."); return; }
        if (dlg && typeof dlg.showModal === 'function') { if (!dlg.open) dlg.showModal(); }
        else if (confirm("Are you sure you want to reset the module?")) { doReset(); }
      });

      dlgCancel && dlgCancel.addEventListener('click', (e) => { e.preventDefault(); if (dlg.open) dlg.close('cancel'); });
      dlgConfirm && dlgConfirm.addEventListener('click', async (e) => {
        e.preventDefault(); if (dlg.open) dlg.close('confirm'); await doReset();
      });

      dlg && dlg.addEventListener('click', (ev) => {
        const r = dlg.getBoundingClientRect();
        const inside = ev.clientX >= r.left && ev.clientX <= r.right && ev.clientY >= r.top && ev.clientY <= r.bottom;
        if (!inside && dlg.open) dlg.close('backdrop');
      });

      async function doReset() {
        try { await connection.send("command", { action: "reset" }); appendLog("System", "Reset command sent"); resetBtn.disabled = true; setTimeout(updateResetEnabled, 3000); }
        catch (err) { appendLog("Error", `Failed to send reset: ${err && err.message ? err.message : err}`); }
      }

      // ---------- Build dynamic UI (Inputs / Relays) ----------
      // Inputs (5) with Action (None/Toggle/Pulse) and Control Target (None/All/R1/R2)
      (function buildInputs() {
        const container = $('inputs-config'); if (!container) return;
        const ACTIONS = [
          { value: 0, label: 'None'   },
          { value: 1, label: 'Toggle' },
          { value: 2, label: 'Pulse'  },
        ];
        const TARGETS = [
          { value: 4, label: 'None' },
          { value: 0, label: 'Control all' },
          { value: 1, label: 'Control relay 1' },
          { value: 2, label: 'Control relay 2' },
        ];
        for (let i = 1; i <= NUM_DI; i++) {
          const actionOptions = ACTIONS.map(a => `<option value="${a.value}">${a.label}</option>`).join('');
          const targetOptions = TARGETS.map(t => `<option value="${t.value}">${t.label}</option>`).join('');
          const card = document.createElement('div');
          card.innerHTML = `
            <div style="border:1px solid #ccc;border-radius:6px;background:#e6f7e8;padding:1rem;">
              <div style="display:flex;justify-content:space-between;font-weight:600;">
                IN${i}
                <span id="state-in${i}" style="width:12px;height:12px;background:#ccc;border-radius:50%;display:inline-block;"></span>
              </div>
              <label><input type="checkbox" id="enable-in${i}"> Enabled</label><br>
              <label><input type="checkbox" id="invert-in${i}"> Inverted</label><br>
              <label>Action:
                <select id="action-in${i}" style="width:100%;padding:6px;border-radius:4px;">
                  ${actionOptions}
                </select>
              </label><br>
              <label>Control target:
                <select id="target-in${i}" style="width:100%;padding:6px;border-radius:4px;">
                  ${targetOptions}
                </select>
              </label>
            </div>`;
          container.appendChild(card);
        }
      })();

      // Relays (2)
      (function buildRelays() {
        const container = $('relays-config'); if (!container) return;
        for (let i = 1; i <= NUM_RLY; i++) {
          const card = document.createElement('div');
          card.innerHTML = `
            <div style="border:1px solid #ccc;border-radius:6px;background:#f1f1f1;padding:1rem;">
              <div style="font-weight:600;">
                Relay ${i}
                <span style="float:right;">
                  <input type="checkbox" id="state-relay${i}" disabled>
                </span>
              </div>
              <label><input type="checkbox" id="enable-relay${i}"> Enabled</label><br>
              <label><input type="checkbox" id="invert-relay${i}"> Inverted</label>
            </div>`;
          container.appendChild(card);
        }
      })();

      // ---------- RECEIVE: update UI from device ----------
      // Inputs
      connection.on('inputs', (list) => {
        (list || []).forEach((v, i) => {
          const dot = $('state-in' + (i + 1));
          if (dot) dot.style.background = v ? '#4caf50' : '#ccc';
        });
      });
      connection.on('enableList', (list) => (list || []).forEach((v, i) => {
        const el = $('enable-in' + (i + 1)); if (el) el.checked = !!v;
      }));
      connection.on('invertList', (list) => (list || []).forEach((v, i) => {
        const el = $('invert-in' + (i + 1)); if (el) el.checked = !!v;
      }));
      connection.on('inputActionList', (list) => (list || []).forEach((v, i) => {
        const el = $('action-in' + (i + 1)); if (el) el.value = String(v || 0);
      }));
      // 4=None, 0=All, 1=R1, 2=R2
      connection.on('inputTargetList', (list) => (list || []).forEach((v, i) => {
        const el = $('target-in' + (i + 1)); if (el) el.value = String(typeof v === 'number' ? v : 0);
      }));

      // Relays
      connection.on('relayStateList', (list) => (list || []).forEach((v, i) => {
        const el = $('state-relay' + (i + 1)); if (el) el.checked = !!v;
      }));
      connection.on('relayEnableList', (list) => (list || []).forEach((v, i) => {
        const el = $('enable-relay' + (i + 1)); if (el) el.checked = !!v;
      }));
      connection.on('relayInvertList', (list) => (list || []).forEach((v, i) => {
        const el = $('invert-relay' + (i + 1)); if (el) el.checked = !!v;
      }));

      // ---------- CHANGE HANDLERS -> send config ----------
      // Inputs
      for (let i = 1; i <= NUM_DI; i++) {
        $('enable-in' + i).addEventListener('change', sendInputEnable);
        $('invert-in' + i).addEventListener('change', sendInputInvert);
        $('action-in' + i).addEventListener('change',  sendInputAction);
        $('target-in' + i).addEventListener('change',  sendInputTarget);
      }
      async function sendInputEnable() {
        const list = []; for (let i = 1; i <= NUM_DI; i++) list.push(!!$('enable-in' + i).checked);
        await connection.send("Config", { t: "inputEnable", list });
      }
      async function sendInputInvert() {
        const list = []; for (let i = 1; i <= NUM_DI; i++) list.push(!!$('invert-in' + i).checked);
        await connection.send("Config", { t: "inputInvert", list });
      }
      async function sendInputAction() {
        const list = []; for (let i = 1; i <= NUM_DI; i++) list.push(parseInt($('action-in' + i).value || "0", 10));
        await connection.send("Config", { t: "inputAction", list });
      }
      async function sendInputTarget() {
        const list = []; for (let i = 1; i <= NUM_DI; i++) list.push(parseInt($('target-in' + i).value || "0", 10));
        await connection.send("Config", { t: "inputTarget", list });
      }

      // Relays
      for (let i = 1; i <= NUM_RLY; i++) {
        $('enable-relay' + i).addEventListener('change', sendRelayConfig);
        $('invert-relay' + i).addEventListener('change', sendRelayConfig);
      }
      async function sendRelayConfig() {
        const list = [];
        for (let i = 1; i <= NUM_RLY; i++) {
          list.push({ enabled: $('enable-relay' + i).checked, inverted: $('invert-relay' + i).checked });
        }
        await connection.send("Config", { t: "relays", list });
      }
    })();
  </script>
</section>