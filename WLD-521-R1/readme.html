<!-- Set base so relative image paths resolve to your GitHub repo -->
<base href="https://raw.githubusercontent.com/isystemsautomation/HOMEMASTER/main/WLD-521-R1/">

<!-- HomeMaster Docs — Global Design System Styles (same as ALM example) -->
<style>
/* Force same visual size/weight for common screenshots */
img[src*="webconfig2.png"],
img[src*="ALM_24Vdc_PowerSupply.png"] {
  width: 420px;
  max-width: 100%;
  height: auto;
  display: block;
  margin: 0 auto;
  border: 1px solid var(--color-border-primary, #d0d7de);
  border-radius: 8px;
  box-shadow: 0 1px 0 rgba(27,31,36,.04);
  background: #fff;
}
/* Ensure general Images folder screenshots are consistent too */
img[src*="Images/"] {
  max-width: 100%;
  height: auto;
}
</style>

<style>
  :root {
    /* Primary Colors */
    --color-text-primary: #24292f;
    --color-text-secondary: #656d76;
    --color-text-tertiary: #57606a;
    --color-border-primary: #d0d7de;
    --color-border-secondary: #d8dee4;
    --color-bg-primary: #ffffff;
    --color-bg-secondary: #f6f8fa;
    --color-bg-tertiary: #fafbfc;

    /* Brand Colors */
    --color-accent: #0969da;
    --color-accent-hover: #0550ae;

    /* Status Colors */
    --color-success: #1a7f37;
    --color-warning: #9a6700;
    --color-danger: #cf222e;

    /* Typography */
    --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    --font-family-code: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;

    /* Font Sizes */
    --font-size-xs: 12px;
    --font-size-sm: 13px;
    --font-size-base: 14px;
    --font-size-lg: 16px;
    --font-size-xl: 18px;
    --font-size-2xl: 20px;
    --font-size-3xl: 24px;
    --font-size-4xl: 32px;

    /* Font Weights */
    --font-weight-normal: 400;
    --font-weight-medium: 500;
    --font-weight-semibold: 600;
    --font-weight-bold: 700;

    /* Spacing & Layout */
    --spacing-xs: 4px;
    --spacing-sm: 8px;
    --spacing-md: 16px;
    --spacing-lg: 24px;
    --spacing-xl: 32px;

    /* Border Radius */
    --border-radius-sm: 3px;
    --border-radius: 6px;
    --border-radius-lg: 8px;

    /* Layout */
    --container-max-width: 1920px;
    --sidebar-width: 260px;
    --content-max-width: 1600px;
    --mobile-breakpoint: 768px;

    --image-max-width: 900px;
  }

  /* Base wrapper */
  .hm-wrap {
    text-align: left;
    font-family: var(--font-family);
    font-size: var(--font-size-base);
    line-height: 1.55;
    color: var(--color-text-primary);
    background: var(--color-bg-primary);
    max-width: var(--content-max-width);
    margin: 0 auto;
    padding: var(--spacing-lg) var(--spacing-md);
  }
  .hm-wrap p { margin: 0 0 var(--spacing-md); }
  .hm-wrap ul, .hm-wrap ol { margin: 0 0 var(--spacing-md) var(--spacing-lg); }
  .hm-wrap li { margin-bottom: var(--spacing-xs); }
  .hm-wrap hr { border: 0; border-top: 1px solid var(--color-border-primary); margin: var(--spacing-xl) 0; }
  .muted { color: var(--color-text-secondary); }

  /* Typography */
  .hm-wrap h1, .hm-wrap h2, .hm-wrap h3, .hm-wrap h4, .hm-wrap h5, .hm-wrap h6 {
    color: var(--color-text-primary);
    font-weight: var(--font-weight-semibold);
    margin: var(--spacing-xl) 0 var(--spacing-sm);
    line-height: 1.25;
  }
  .hm-wrap h4 { font-size: var(--font-size-3xl); }
  .hm-wrap h5 { font-size: var(--font-size-lg); }
  .hm-wrap h6 { font-size: var(--font-size-base); letter-spacing: .2px; color: var(--color-text-tertiary); }

  /* Links */
  .hm-wrap a { color: var(--color-accent); text-decoration: none; }
  .hm-wrap a:hover { color: var(--color-accent-hover); text-decoration: underline; }

  /* Table styles */
  .table-container { overflow-x: auto; }
  .hm-wrap table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--font-size-sm);
    margin: var(--spacing-md) 0;
  }
  .hm-wrap th, .hm-wrap td {
    border: 1px solid var(--color-border-primary);
    padding: var(--spacing-sm) var(--spacing-md);
    text-align: left;
    vertical-align: top;
    color: var(--color-text-primary);
  }
  .hm-wrap thead th {
    background: var(--color-bg-secondary);
    font-weight: var(--font-weight-semibold);
  }
  .hm-wrap tr:nth-child(even) { background: var(--color-bg-tertiary); }
  .hm-wrap tr:hover { background: var(--color-bg-secondary); }

  /* Alerts */
  .note, .tip, .warn {
    padding: var(--spacing-md);
    border-radius: var(--border-radius);
    margin: var(--spacing-md) 0;
  }
  .note { border-left:4px solid var(--color-warning); background:#fff8c5; }
  .tip  { border-left:4px solid var(--color-success); background:#dafbe1; }
  .warn { border-left:4px solid var(--color-danger);  background:#ffebe9; }

  /* Badges */
  .badges img {
    display:inline-block;
    vertical-align:middle;
    margin-right:8px;
    max-width:none;
    height:20px;
    border:0;
  }
  .kpi { display:inline-block; padding:.25em .5em; border-radius:6px; background:#eef2ff; color:#3730a3; font-weight:600; }

  /* Code */
  code {
    background: var(--color-bg-secondary);
    border-radius: var(--border-radius-sm);
    padding: 0.2em 0.4em;
    font-size: var(--font-size-sm);
    font-family: var(--font-family-code);
    color: var(--color-text-primary);
  }
  pre {
    background: #0b1020;
    color: #e5e7eb;
    border: 1px solid var(--color-border-primary);
    border-radius: var(--border-radius);
    padding: var(--spacing-md);
    overflow-x: auto;
    margin: var(--spacing-md) 0;
    font-size: var(--font-size-sm);
    line-height: 1.45;
  }
  pre code { background: none; padding: 0; border: 0; }

  /* Images */
  .hm-wrap img {
    max-width: min(100%, var(--image-max-width));
    height: auto;
    border-radius: var(--border-radius);
    border: 1px solid var(--color-border-primary);
  }
  .img-center { text-align: center; margin: var(--spacing-md) 0; }
  .img-center img { max-width: 100%; height: auto; }
  .img-caption { margin-top: var(--spacing-sm); font-size: var(--font-size-xs); color: var(--color-text-secondary); font-style: italic; text-align: center; }
  .float-right { float: right; margin: 0 0 var(--spacing-md) var(--spacing-md); border: 1px solid var(--color-border-primary); }
  .clear { clear: both; }

  /* ToC */
  .toc a { text-decoration: none; color: var(--color-accent); }
  .toc a:hover { color: var(--color-accent-hover); text-decoration: underline; }

  /* Responsive */
  @media (max-width: 768px) {
    .hm-wrap { padding: var(--spacing-md); }
    .float-right { float: none; display: block; margin: 0 auto var(--spacing-md); }
    h1 { font-size: var(--font-size-4xl); }
    h2 { font-size: var(--font-size-3xl); }
    .table-container { overflow-x: auto; }
  }
</style>

<div class="hm-wrap">

  <p><span class="kpi">Firmware Version: 2025-10 snapshot</span></p>

  <p class="badges">
    <img alt="Firmware Version" src="https://img.shields.io/badge/Firmware-2025--10-blue" loading="lazy">
    <img alt="Modbus" src="https://img.shields.io/badge/Protocol-Modbus%20RTU-brightgreen" loading="lazy">
    <img alt="License" src="https://img.shields.io/badge/License-GPLv3%20%2F%20CERN--OHL--W-blue" loading="lazy">
  </p>

  <h4 id="wld-title">WLD-521-R1 — Water Meter &amp; Leak Detection Module</h4>
  <p><strong>HOMEMASTER – Modular control. Custom logic.</strong></p>

  <img class="float-right" width="440" alt="WLD-521-R1 module photo" src="Images/photo1.png" loading="lazy">

  <h5>Module Description</h5>
  <p>
    The <strong>WLD-521-R1</strong> is a configurable smart I/O module designed for <strong>leak detection</strong>, <strong>water flow metering</strong>, <strong>heat energy monitoring</strong>, and <strong>local irrigation control</strong>.<br>
    It includes <strong>5 opto-isolated digital inputs</strong>, <strong>2 SPDT relays</strong>, and optional <strong>4 buttons and 4 LEDs</strong> for manual control and local status indication. Configuration is performed via the
    <strong>WebConfig interface</strong> over <strong>USB-C (Web Serial)</strong>.<br>
    The module connects over <strong>RS-485 (Modbus RTU)</strong> to a <strong>MicroPLC or MiniPLC</strong>, enabling deployment in <strong>water management</strong>, <strong>hydronic heating</strong>, <strong>garden irrigation</strong>, and <strong>safety automation systems</strong>.
  </p>

  <div class="clear"></div>
  <hr>

  <h5 id="table-of-contents">Table of Contents</h5>
  <ul class="toc">
    <li><a href="#1-introduction">1. Introduction</a></li>
    <li><a href="#2-use-cases">2. Use Cases</a></li>
    <li><a href="#3-safety-information">3. Safety Information</a></li>
    <li><a href="#4-installation-quick-start">4. Installation &amp; Quick Start</a></li>
    <li><a href="#5-module-code--technical-specification">5. WLD-521-R1 — Technical Specification</a></li>
    <li><a href="#6-modbus-rtu-communication">6. Modbus RTU Communication</a></li>
    <li><a href="#7-esphome-integration-guide">7. ESPHome Integration Guide (if applicable)</a></li>
    <li><a href="#8-programming--customization">8. Programming &amp; Customization</a></li>
    <li><a href="#9-maintenance--troubleshooting">9. Maintenance &amp; Troubleshooting</a></li>
    <li><a href="#10-open-source--licensing">10. Open Source &amp; Licensing</a></li>
    <li><a href="#11-downloads">11. Downloads</a></li>
    <li><a href="#12-support">12. Support</a></li>
  </ul>

  <hr>

  <a id="1-introduction"></a>
  <h4>1. Introduction</h4>

  <h5>1.1 Overview of the WLD-521-R1</h5>
  <p>
    The <strong>WLD-521-R1</strong> is a DIN‑rail smart I/O module for <strong>leak detection</strong>, <strong>pulse water metering</strong>, <strong>ΔT heat monitoring</strong>, and <strong>local irrigation control</strong>.
    It exposes <strong>5 opto‑isolated digital inputs</strong>, <strong>2 SPDT relays</strong>, <strong>4 user buttons</strong>, and <strong>4 status LEDs</strong> and is serviced over <strong>USB‑C</strong>.
  </p>
  <p>
    It integrates with a <strong>MiniPLC/MicroPLC</strong> (or other PLC/SCADA/HA controllers) via <strong>Modbus RTU over RS‑485</strong>.
    Configuration is done in a browser using the <strong>WebConfig</strong> tool (Web Serial over USB‑C): set Modbus params, choose per‑input modes (sensor/counter), link 1‑Wire temperature sensors,
    and enable autonomous irrigation/flow‑safety logic.<br>
    <strong>In one line:</strong> a resilient water‑safety/flow module with local logic that still plays perfectly with your PLC and Home Assistant stack.
  </p>

  <h5>1.2 Features &amp; Architecture</h5>
  <table>
    <thead><tr><th>Subsystem</th><th>Qty</th><th>Description</th></tr></thead>
    <tbody>
      <tr><td><strong>Digital Inputs</strong></td><td>5</td><td>Opto‑isolated inputs with MOSFET front‑ends, debouncing, and isolated return (<strong>GND_ISO</strong>); suitable for dry contacts or pulse flowmeters.</td></tr>
      <tr><td><strong>Analog Outputs</strong></td><td>0</td><td>—</td></tr>
      <tr><td><strong>Relays</strong></td><td>2</td><td>SPDT dry contacts (~3 A @ 250 VAC); driven via opto‑isolated stages and RC/snubber‑protected. Terminals NO/COM/NC exposed.</td></tr>
      <tr><td><strong>1‑Wire Bus</strong></td><td>1</td><td>Protected 3‑pin header (+5 V / DATA / GND) with level shifting and ESD protection; supports DS18B20 sensors.</td></tr>
      <tr><td><strong>LEDs</strong></td><td>4 user + status</td><td>4 user LEDs controlled via transistor drivers; additional LEDs for power and RS‑485 TX/RX activity.</td></tr>
      <tr><td><strong>Buttons</strong></td><td>4</td><td>Front‑panel tactile buttons for relay override, irrigation control, and test functions.</td></tr>
      <tr><td><strong>Modbus RTU</strong></td><td>Yes</td><td>RS‑485 transceiver with surge/bias/ESD protection and DE/RE control. Typical config: 19200 baud, 8N1.</td></tr>
      <tr><td><strong>USB‑C</strong></td><td>Yes</td><td>Type‑C port with ESD protection and Web Serial interface; used for configuration via WebConfig.</td></tr>
      <tr><td><strong>Power</strong></td><td>24 VDC</td><td>Fused, reverse‑protected input. Internal buck regulator provides +5 V and +3.3 V. Isolated +5 V and +12 V rails available for sensor power.</td></tr>
      <tr><td><strong>MCU</strong></td><td>RP2350A</td><td>Dual-core MCU with QSPI flash and 12 MHz crystal; SWD debug header available.</td></tr>
      <tr><td><strong>Protection</strong></td><td>TVS, PTC, ESD</td><td>Multi-stage protection on RS‑485 and USB lines; isolated sensor rails; opto‑isolated inputs; snubbers on relays.</td></tr>
    </tbody>
  </table>
  <p class="note"><strong>Optional:</strong> <strong>1‑Wire bus</strong> for DS18B20 sensors (e.g. supply/return temperatures for heat energy monitoring).</p>

  <h5>1.3 System Role &amp; Communication 💧</h5>
  <p>
    The <strong>WLD-521-R1</strong> is a smart Modbus RTU slave. It can operate autonomously for leak/flow/irrigation safety logic, while exposing its I/O and sensors to a PLC, ESPHome controller, or SCADA system.
  </p>
  <table>
    <tbody>
      <tr><td><strong>System Position</strong></td><td>Expansion module on RS‑485 trunk</td></tr>
      <tr><td><strong>Master Controller</strong></td><td>MiniPLC / MicroPLC or any third‑party Modbus RTU master</td></tr>
      <tr><td><strong>Address / Baud</strong></td><td>Configurable via WebConfig (1–255, 9600–115200 baud)</td></tr>
      <tr><td><strong>Bus Type</strong></td><td>RS‑485 multi‑drop (A/B/COM terminals)</td></tr>
      <tr><td><strong>USB‑C Port</strong></td><td>For configuration/diagnostics using Web Serial (Chrome/Edge)</td></tr>
      <tr><td><strong>Default Modbus ID</strong></td><td><code>3</code> (user‑changeable per module)</td></tr>
      <tr><td><strong>Daisy‑Chaining</strong></td><td>Multiple modules supported; assign unique IDs to each device</td></tr>
    </tbody>
  </table>
  <div class="warn"><strong>⚠️ Note:</strong> If multiple WLD modules are connected to the same RS‑485 segment, make sure to assign <strong>unique Modbus addresses</strong> using WebConfig.</div>

  <hr>

  <a id="2-use-cases"></a>
  <h4>2. Use Cases</h4>
  <p>The <strong>WLD-521-R1</strong> supports a range of real-world applications in leak detection, flow metering, hydronic energy monitoring, and irrigation control. Below are practical scenarios with step-by-step configuration.</p>

  <h5>💧 1) Basement Leak Alarm + Auto Shut-off</h5>
  <p><strong>Goal:</strong> Detect water leaks and immediately shut off the water supply using a relay-controlled valve.</p>
  <ul>
    <li>Set <strong>DI1</strong> as <strong>Water sensor</strong></li>
    <li>Enable DI1 and set <strong>Action = Toggle</strong></li>
    <li>Set <strong>Control target = Relay 1</strong></li>
    <li>Wire a <strong>motorized shut-off valve</strong> (normally open) to <strong>R1</strong></li>
    <li>(Optional) Assign <strong>LED1</strong> to blink on <strong>DI1</strong> or <strong>R1</strong></li>
  </ul>

  <h5>🌿 2) Garden Irrigation with Flow Supervision</h5>
  <p><strong>Goal:</strong> Automate watering safely with flow monitoring and environmental interlocks.</p>
  <ul>
    <li>Go to <strong>Irrigation → Zone 1</strong></li>
    <li>Set <strong>Valve relay = Relay 2</strong>, <strong>Flow DI = DI2</strong></li>
    <li>Enable <strong>Use flow supervision</strong></li>
    <li>Configure:
      <ul>
        <li><strong>Min rate = 0.2 L/min</strong></li>
        <li><strong>Grace = 8 s</strong></li>
        <li><strong>Timeout = 1200 s</strong></li>
        <li><strong>Target liters = 50</strong></li>
      </ul>
    </li>
    <li>Add interlocks:
      <ul>
        <li><strong>DI_moist = DI3</strong> (dry = run)</li>
        <li><strong>DI_rain = DI4</strong> (rain = block)</li>
        <li><strong>R_pump = Relay 1</strong> (pump ON when watering)</li>
      </ul>
    </li>
    <li>Enable <strong>Window: 06:00–08:00</strong> with <strong>Auto-start</strong></li>
  </ul>

  <h5>📈 3) Water Consumption Metering (Billing)</h5>
  <p><strong>Goal:</strong> Track water usage in liters using pulse flow meters.</p>
  <ul>
    <li>Set <strong>DI2</strong> to <strong>Water counter</strong></li>
    <li>Enter <strong>Pulses per liter = 450</strong> (typical)</li>
    <li>Adjust <strong>Rate × / Total ×</strong> as needed for calibration</li>
    <li>Use <strong>Reset total</strong> to baseline reading</li>
    <li>Use <strong>Calc from external</strong> after external validation</li>
    <li>View <strong>Live rate (L/min)</strong> and <strong>Total (L)</strong> in WebConfig</li>
  </ul>

  <h5>🔥 4) Heat Energy Monitoring (Hydronic ΔT Loops)</h5>
  <p><strong>Goal:</strong> Measure heat power and energy from flow and temperature sensors.</p>
  <ul>
    <li>Set <strong>DI3 = Water counter</strong></li>
    <li>Enable <strong>Heat</strong> on DI3</li>
    <li>Assign <strong>Sensor A = #1 (supply)</strong>, <strong>Sensor B = #2 (return)</strong></li>
    <li>Set thermal constants:
      <ul>
        <li><strong>cp = 4186 J/kg·°C</strong></li>
        <li><strong>ρ = 1.0 kg/L</strong></li>
      </ul>
    </li>
    <li>Adjust <strong>Calibration ×</strong> if needed</li>
    <li>View <strong>TA</strong>, <strong>TB</strong>, <strong>ΔT</strong>, <strong>Power (W)</strong>, <strong>Energy (J/kWh)</strong></li>
    <li>Use <strong>Reset energy</strong> to zero counters</li>
  </ul>

  <hr>

  <a id="3-safety-information"></a>
  <h4>3. Safety Information</h4>
  <p>These safety instructions apply to the <strong>WLD‑521‑R1</strong> module. Improper handling or wiring can cause <strong>equipment damage</strong>, <strong>system failure</strong>, or <strong>personal injury</strong>.</p>
  <div class="warn"><strong>⚠️ SELV only</strong> — This device operates on <strong>Safety Extra Low Voltage (24 VDC only)</strong>. Never apply AC mains or high-voltage sources.</div>

  <h5>3.1 General Requirements</h5>
  <table>
    <thead><tr><th>Requirement</th><th>Detail</th></tr></thead>
    <tbody>
      <tr><td><strong>Qualified Personnel</strong></td><td>Only trained installers or technicians may handle wiring and system integration.</td></tr>
      <tr><td><strong>Power Isolation</strong></td><td>Disconnect <strong>24 VDC</strong> power before modifying terminals or servicing the device.</td></tr>
      <tr><td><strong>Environmental Limits</strong></td><td>Install inside a <strong>dry, clean DIN enclosure</strong>. Avoid condensation, dust, or vibration.</td></tr>
      <tr><td><strong>Grounding</strong></td><td>Connect <strong>0 V</strong>, <strong>RS-485 COM</strong>, and <strong>GND_ISO</strong> appropriately. Maintain logic and sensor isolation.</td></tr>
      <tr><td><strong>Voltage Compliance</strong></td><td>Observe electrical ratings: <strong>24 VDC supply</strong>, <strong>5/12 V sensor outputs</strong>, <strong>max 3 A relay load</strong>.</td></tr>
    </tbody>
  </table>

  <h5>3.2 Installation Practices</h5>
  <table>
    <thead><tr><th>Task</th><th>Guidance</th></tr></thead>
    <tbody>
      <tr><td><strong>DIN Mounting</strong></td><td>Secure module on <strong>35 mm DIN rail</strong>. Apply strain relief to all wiring.</td></tr>
      <tr><td><strong>ESD Precaution</strong></td><td>Use anti-static strap and handle boards by casing only.</td></tr>
      <tr><td><strong>Power Wiring</strong></td><td>Connect regulated <strong>24 VDC</strong> to <code>V+ / 0V</code> terminals. Fuse upstream.</td></tr>
      <tr><td><strong>Relay Wiring</strong></td><td>Use <code>NO / COM / NC</code> terminals for each relay. Relays are <strong>dry contact SPDT</strong> only. External loads must have their own power.</td></tr>
      <tr><td><strong>Digital Inputs</strong></td><td>Connect dry-contact sensors or open-collector devices to <code>I1–I5</code>, with return to <strong>GND_ISO</strong> (not 0V).</td></tr>
      <tr><td><strong>Sensor Power</strong></td><td>Use <strong>+5 V</strong> or <strong>+12 V</strong> outputs (right-side terminals) for low-power field sensors only.</td></tr>
      <tr><td><strong>GND Domains</strong></td><td>Keep <strong>GND_ISO</strong> (inputs) and <strong>0 V / GND (logic)</strong> isolated unless explicitly bridged.</td></tr>
      <tr><td><strong>RS-485 Wiring</strong></td><td>Wire <code>A/B/COM</code> to RS‑485 master. Maintain A↔A, B↔B polarity. COM = signal reference. Terminate both ends with ~120 Ω.</td></tr>
      <tr><td><strong>Commissioning</strong></td><td>Before applying power: verify polarity, relay contact wiring, RS‑485 line, and ensure sensor loads are within spec.</td></tr>
    </tbody>
  </table>

  <h5>3.3 I/O &amp; Interface Warnings</h5>

  <h6>🔌 Power</h6>
  <table>
    <thead><tr><th>Interface</th><th>Warning</th></tr></thead>
    <tbody>
      <tr><td><strong>V+ / 0V (Top-left)</strong></td><td>Connect only regulated <strong>24 VDC</strong>. Reverse protected. Never exceed 30 V.</td></tr>
      <tr><td><strong>+5 V / +12 V (Bottom-right)</strong></td><td>Isolated sensor supply. Use for dry-contact sensors only. Protected by DC-DC and fuses. Not for powering relays or actuators.</td></tr>
    </tbody>
  </table>

  <h6>⏸ Inputs &amp; Relays</h6>
  <table>
    <thead><tr><th>Interface</th><th>Warning</th></tr></thead>
    <tbody>
      <tr><td><strong>Inputs I1–I5 (Top row)</strong></td><td>Opto-isolated channels. Connect only dry-contact or open-collector sources. Return via <strong>GND (top right)</strong> (this is <strong>GND_ISO</strong>, not logic ground).</td></tr>
      <tr><td><strong>Relays (Bottom row)</strong></td><td><code>NC / COM / NO</code> per relay. Dry contact only. Max: <strong>3 A @ 250 VAC / 30 VDC</strong>. Use snubbers for inductive loads (e.g. pumps, valves).</td></tr>
      <tr><td><strong>Relay Power</strong></td><td>Relay contacts are <strong>not powered</strong>. External load must have its own power source.</td></tr>
    </tbody>
  </table>

  <h6>🔗 Communication &amp; USB</h6>
  <table>
    <thead><tr><th>Interface</th><th>Warning</th></tr></thead>
    <tbody>
      <tr><td><strong>RS‑485 A/B/COM (Bottom left)</strong></td><td>Use twisted pair for A/B. COM is signal ground. Protect against surges. Not suitable for long unshielded runs or outdoor wiring.</td></tr>
      <tr><td><strong>USB‑C (Front panel)</strong></td><td>For <strong>setup only</strong> using Web Serial in Chrome/Edge. ESD protected. Not for field use or runtime connection. Disconnect after configuration.</td></tr>
    </tbody>
  </table>

  <h6>🔘 User Interface</h6>
  <table>
    <thead><tr><th>Element</th><th>Notes</th></tr></thead>
    <tbody>
      <tr><td><strong>Buttons (U1–U4)</strong></td><td>Configurable: relay override, irrigation start/stop. Button press may override Modbus or automation logic.</td></tr>
      <tr><td><strong>LEDs (U1–U4)</strong></td><td>Configurable for DI, Relay, or Irrigation indication. Driven from MCU via transistors.</td></tr>
    </tbody>
  </table>

  <h6>🛡 Shielding &amp; EMC</h6>
  <table>
    <thead><tr><th>Area</th><th>Recommendation</th></tr></thead>
    <tbody>
      <tr><td><strong>Cable Shielding</strong></td><td>Use shielded cable for RS‑485 and sensor lines. Terminate shield at controller end only. Avoid routing near motors/VFDs.</td></tr>
      <tr><td><strong>Inductive Loads</strong></td><td>Use RC snubbers or TVS across relay contacts for solenoids, pumps, or coils.</td></tr>
    </tbody>
  </table>

  <hr>

  <a id="4-installation-quick-start"></a>
  <h4>4. Installation &amp; Quick Start</h4>

  <h5>4.1 What You Need</h5>
  <table>
    <thead><tr><th>Category</th><th>Item</th><th>Details</th></tr></thead>
    <tbody>
      <tr><td><strong>Hardware</strong></td><td><strong>WLD‑521‑R1</strong></td><td>DIN‑rail module with <strong>5 opto DIs</strong>, <strong>2 SPDT relays</strong>, <strong>4 buttons</strong>, <strong>4 LEDs</strong>, <strong>RS‑485</strong>, <strong>USB‑C</strong>, <strong>1‑Wire</strong>, and <strong>isolated +5 V / +12 V sensor rails</strong>.</td></tr>
      <tr><td></td><td><strong>Controller (master)</strong></td><td>HomeMaster MiniPLC/MicroPLC or any Modbus RTU master device.</td></tr>
      <tr><td></td><td><strong>24 VDC PSU (SELV)</strong></td><td>Regulated <strong>24 VDC</strong> supply to <strong>V+ / 0V</strong>; size to include module + sensors.</td></tr>
      <tr><td></td><td><strong>RS‑485 cable</strong></td><td>Shielded twisted pair for <strong>A/B + COM (GND)</strong>; use <strong>120 Ω termination</strong> at both bus ends.</td></tr>
      <tr><td></td><td><strong>USB‑C cable</strong></td><td>Used for setup/config via <strong>WebConfig</strong> in Chromium browser.</td></tr>
      <tr><td></td><td><strong>DIN enclosure</strong></td><td>Dry, clean cabinet with DIN rail; provide strain relief and shield grounding.</td></tr>
      <tr><td><strong>Software</strong></td><td><strong>WebConfig (browser)</strong></td><td>Configure <strong>Address / Baud</strong>, assign <strong>Inputs / Relays / Buttons / LEDs</strong>, irrigation zones, sensors, etc.</td></tr>
      <tr><td></td><td><strong>ESPHome (optional)</strong></td><td>On controller: polls Modbus, exposes WLD sensors and relays to Home Assistant.</td></tr>
      <tr><td><strong>Field I/O</strong></td><td><strong>Dry contacts</strong></td><td>Inputs DI1…DI5 return to <strong>GND_ISO</strong>; supports leak probes, flow meters, or buttons.</td></tr>
      <tr><td></td><td><strong>Relay loads</strong></td><td>RLY1/RLY2: <strong>COM/NO/NC</strong> dry contacts; up to <strong>3 A @ 250 VAC</strong>. Use RC/TVS snubbers for inductive loads.</td></tr>
      <tr><td></td><td><strong>Sensor power (isolated)</strong></td><td>Bottom-right <strong>+12 V / +5 V ISO</strong> terminals for <strong>low-power sensors only</strong>. Not for actuators.</td></tr>
      <tr><td><strong>Tools</strong></td><td><strong>Screwdrivers, ferrules, meter</strong></td><td>Verify terminal torque, polarity, and RS‑485 A/B wiring. Use <strong>120 Ω</strong> resistors and surge protectors if needed.</td></tr>
    </tbody>
  </table>
  <p class="muted"><strong>Status LEDs:</strong> • <strong>PWR</strong> – steady ON when powered • <strong>TX/RX</strong> – blink on RS‑485 activity • <strong>USB</strong> – active when connected for WebConfig</p>

  <h5>4.2 Power</h5>
  <p>The WLD‑521‑R1 operates from a <strong>regulated 24 VDC supply</strong> connected to the top terminals labeled <code>V+</code> and <code>0V</code>. The power supply should be SELV-rated and appropriately sized.</p>

  <h6>Power Supply Notes</h6>
  <ul>
    <li><strong>Input:</strong> 24 VDC, reverse‑protected and fused onboard</li>
    <li><strong>Internal regulation:</strong>
      <ul>
        <li><strong>5 V logic</strong> (buck regulated via AP64501)</li>
        <li><strong>3.3 V logic</strong> (via AMS1117-3.3)</li>
        <li><strong>+12 V ISO</strong> (for field sensors via B2412S‑2WR3)</li>
        <li><strong>+5 V ISO</strong> (via B2405S‑2WR3)</li>
      </ul>
    </li>
  </ul>

  <h6>Power Budget (Estimates)</h6>
  <table>
    <thead><tr><th>Load</th><th>Typical Current</th></tr></thead>
    <tbody>
      <tr><td>Base logic + LEDs</td><td>~50 mA</td></tr>
      <tr><td>Each relay (coil)</td><td>~40–60 mA</td></tr>
      <tr><td>Sensor rails (total)</td><td>≤150 mA (shared between +5 V ISO / +12 V ISO)</td></tr>
    </tbody>
  </table>
  <p><strong>Recommended PSU:</strong> ≥300 mA per module (with 30% headroom).</p>
  <p class="warn"><strong>⚠️</strong> Only use the <strong>sensor rails</strong> for <strong>low-power sensors</strong> like leak probes and flow meters. Never power relays, valves, or actuators from the module’s +5 V / +12 V outputs.</p>

  <h5>4.3 Communication</h5>
  <p>The WLD‑521‑R1 uses <strong>Modbus RTU</strong> over RS‑485 for all runtime communication, and <strong>USB‑C</strong> for setup via browser.</p>

  <h6>RS‑485 Pinout (Bottom Left Terminals)</h6>
  <table>
    <thead><tr><th>Terminal</th><th>Function</th></tr></thead>
    <tbody>
      <tr><td><strong>A</strong></td><td>RS‑485 A (Data +)</td></tr>
      <tr><td><strong>B</strong></td><td>RS‑485 B (Data –)</td></tr>
      <tr><td><strong>COM</strong></td><td>RS‑485 reference ground (connect to controller GND)</td></tr>
    </tbody>
  </table>
  <ul>
    <li>Wire <strong>A → A</strong>, <strong>B → B</strong>, <strong>COM → COM</strong></li>
    <li>Use <strong>twisted‑pair</strong> cable and <strong>terminate</strong> at both ends (120 Ω)</li>
    <li>Avoid star topologies; keep stubs short</li>
    <li>Shielded cable is recommended for EMI immunity</li>
  </ul>

  <h6>Modbus Settings</h6>
  <table>
    <thead><tr><th>Parameter</th><th>Default</th><th>Range</th></tr></thead>
    <tbody>
      <tr><td><strong>Address</strong></td><td>3</td><td>1–255 (set via WebConfig)</td></tr>
      <tr><td><strong>Baudrate</strong></td><td>19200</td><td>9600–115200 (WebConfig)</td></tr>
      <tr><td><strong>Format</strong></td><td>8N1</td><td>8 data bits, no parity, 1 stop bit</td></tr>
    </tbody>
  </table>
  <p class="note">WebConfig allows you to set the <strong>Modbus address</strong> and <strong>baudrate</strong> via USB‑C before connecting to a PLC or ESPHome controller.</p>

  <a id="installation-wiring"></a>
  <h5>4.4 Installation &amp; Wiring</h5>
  <p>Use diagrams and explain:
    <ul>
      <li>Inputs</li>
      <li>Relays</li>
      <li>Sensor rails (12/5V)</li>
      <li>RS‑485 terminals</li>
      <li>USB port</li>
    </ul>
  </p>

  <a id="software-ui-configuration"></a>
  <h5>4.5 Software &amp; UI Configuration</h5>
  <p>The WLD‑521‑R1 is configured using <strong>WebConfig</strong> — a driverless USB‑C interface that runs in Chrome/Edge via Web Serial. All settings apply immediately and are saved to the module's flash.</p>

  <h6>🔌 WebConfig Setup</h6>
  <ol>
    <li>Connect the module to your PC using a <strong>USB-C</strong> cable.</li>
    <li>Open <strong>https://www.home-master.eu/configtool-wld-521-r1</strong> in Chrome or Edge.</li>
    <li>Click <strong>“Connect”</strong> and select the serial device.</li>
    <li>The header will show the <strong>Active Modbus Configuration</strong> (Address, Baudrate).</li>
  </ol>
  <p class="note">You can safely reset or update Modbus settings at any time.</p>

  <h6>🧩 Modbus Address &amp; Baudrate</h6>
  <ul>
    <li><strong>Set Address (1–255)</strong>: each module must have a unique address.</li>
    <li><strong>Set Baudrate</strong>: choose between <strong>9600–115200</strong> (default: 19200).</li>
    <li>Confirm the updated settings in the banner and <strong>Serial Log</strong>.</li>
  </ul>
  <p class="img-center"><img alt="WebConfig – Modbus" src="Images/webconfig1.png" width="420"></p>

  <h6>🔁 Input Configuration (DI1–DI5)</h6>
  <p>Each DI has:</p>
  <ul>
    <li><strong>Enable / Invert</strong></li>
    <li><strong>Type</strong>: <code>Water sensor</code>, <code>Soil moisture</code>, <code>Water counter</code></li>
  </ul>
  <h6>For <code>Water sensor</code> / <code>Soil moisture</code>:</h6>
  <ul>
    <li><strong>Action</strong>: <code>None</code>, <code>Toggle</code>, or <code>Pulse</code></li>
    <li><strong>Control Target</strong>: <code>All</code>, <code>Relay 1</code>, <code>Relay 2</code>, <code>None</code></li>
  </ul>
  <h6>For <code>Water counter</code>:</h6>
  <ul>
    <li><strong>Pulses per Liter (PPL)</strong> (e.g., 450)</li>
    <li><strong>Rate × / Total ×</strong> calibration</li>
    <li><strong>Live Flow</strong>: <em>Rate (L/min)</em>, <em>Total (L)</em></li>
    <li><strong>Reset Total / Reset Pulses</strong></li>
    <li><strong>Calc from External</strong> to align totals with an external meter</li>
  </ul>
  <p class="img-center"><img alt="WebConfig – Inputs" src="Images/webconfig3.png" width="420"></p>

  <h6>🔥 Heat Energy Calculation (Optional on Counter DIs)</h6>
  <p>Enable <strong>Heat</strong> on a DI to calculate:</p>
  <ul>
    <li><strong>ΔT</strong> from 1‑Wire <code>Sensor A</code> – <code>Sensor B</code></li>
    <li><strong>Power (W)</strong> and <strong>Energy (J / kWh)</strong> using:
      <ul>
        <li><strong>cp</strong> (J/kg·°C), <strong>ρ</strong> (kg/L), <strong>Calibration ×</strong></li>
      </ul>
    </li>
  </ul>
  <p>Formula:<br><code>Power = cp × ρ × ΔT × FlowRate</code><br><code>Energy = ∑ Power × Δt</code></p>
  <p>You can view <strong>TA</strong>, <strong>TB</strong>, <strong>ΔT</strong>, <strong>Power</strong>, <strong>Energy</strong> and reset energy counters.</p>
  <p class="img-center"><img alt="WebConfig – Heat Panel" src="Images/webconfig4.png" width="420"></p>

  <h6>⚙️ Relay Logic Configuration (Relay 1 &amp; 2)</h6>
  <ul>
    <li><strong>Enable / Invert</strong></li>
    <li><strong>Control Source</strong>: <code>Modbus</code>, <code>Local Logic</code>, or <code>None</code></li>
    <li><strong>Manual Override</strong>: ON/OFF, with <strong>Latch</strong> option</li>
  </ul>
  <p class="tip"><strong>Relays</strong> are dry contact. Wire loads to <code>NO / NC / COM</code>.</p>
  <p class="img-center"><img alt="WebConfig – Relays" src="Images/webconfig5.png" width="420"></p>

  <h6>🔵 LED Mapping (LED1–LED4)</h6>
  <ul>
    <li><strong>Mode</strong>: <code>Solid</code> or <code>Blink</code></li>
    <li><strong>Source</strong>: <code>DI1–DI5</code>, <code>Relay 1/2</code>, <code>Irrig 1/2</code>, <code>Override R1/R2</code></li>
  </ul>
  <p class="img-center"><img alt="WebConfig – LEDs" src="Images/webconfig6.png" width="420"></p>

  <h6>🔘 Button Configuration (BTN1–BTN4)</h6>
  <ul>
    <li><strong>Relays</strong>: <code>Toggle R1/R2</code>, <code>Pulse R1/R2</code></li>
    <li><strong>Irrigation</strong>: <code>Start/Stop Zone 1/2</code></li>
    <li><strong>Manual Override</strong>: <code>R1/R2 Override Toggle</code></li>
  </ul>
  <p><strong>Button Press Behavior:</strong> Short press = toggle; Long press (~3s) = enter/exit override (relay ignores Modbus/logic while overridden).</p>
  <p class="img-center"><img alt="WebConfig – Buttons" src="Images/webconfig6.png" width="420"></p>

  <h6>🧪 Testing &amp; Diagnostics</h6>
  <ul>
    <li><strong>Serial Log</strong> to watch live changes</li>
    <li><strong>Status pills</strong> on component cards for DI/relay/button states</li>
    <li><strong>Reset Device</strong> for safe module reboot</li>
  </ul>

  <h6>⏰ Clock &amp; Home Assistant Sync</h6>
  <ul>
    <li>Use <strong>coil 360</strong> = <code>CMD_TIME_MIDNIGHT</code> to sync at 00:00</li>
    <li>Optionally set <strong>Minute of day</strong> (<code>HREG 1100</code>) and <strong>Day index</strong> (<code>HREG 1101</code>)</li>
  </ul>
  <p class="note">Ensures irrigation windows behave predictably and counters roll over cleanly.</p>
  <p><strong>WebConfig</strong> saves changes immediately to flash. Disconnect USB‑C after setup — the device runs autonomously and responds to Modbus polling.</p>

  <a id="4-6-getting-started"></a>
  <h5>4.6 Getting Started</h5>
  <ol>
    <li><strong>Wiring</strong> — Power, RS‑485, Inputs/Relays, sensor rails</li>
    <li><strong>Configuration</strong> — WebConfig: address/baud, inputs/relays/buttons/LEDs, irrigation &amp; heat if used</li>
    <li><strong>Integration</strong> — PLC/ESPHome polling and dashboards</li>
  </ol>

  <hr>

  <a id="5-module-code--technical-specification"></a>
  <h4>5. WLD‑521‑R1 — Technical Specification</h4>
  <p><em>This section consolidates diagrams, I/O, electrical limits, firmware behavior, connector map, mechanics, and compliance for quick reference.</em></p>

  <h5>5.1 Diagrams &amp; Pinouts</h5>
  <div class="img-center">
    <table style="width:auto; margin-left:auto; margin-right:auto;">
      <tbody>
        <tr>
          <td style="text-align:center;">
            <strong>System Block Diagram</strong><br>
            <img src="Images/WLD_Diagram.png" alt="System Diagram" width="360">
          </td>
          <td style="text-align:center;">
            <strong>Terminal Map</strong><br>
            <img src="Images/photo1.png" alt="Module Photo and Terminal Map" width="360">
          </td>
        </tr>
        <tr>
          <td style="text-align:center;">
            <strong>Field Board Layout</strong><br>
            <img src="Images/FieldBoard_Diagram.png" alt="Field Board" width="360">
          </td>
          <td style="text-align:center;">
            <strong>MCU Board Layout</strong><br>
            <img src="Images/MCUBoard_Diagram.png" alt="MCU Board" width="360">
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <h5>5.2 I/O Summary</h5>
  <table>
    <thead><tr><th>Interface</th><th>Qty</th><th>Description</th></tr></thead>
    <tbody>
      <tr><td><strong>Digital Inputs</strong></td><td>5</td><td>Opto‑isolated DI (dry contact / open‑collector / pulse for flow meters); isolated return (GND_ISO).</td></tr>
      <tr><td><strong>Relay Outputs</strong></td><td>2</td><td>SPDT dry contact (NO/C/NC); snubbered; local/Modbus/logic control.</td></tr>
      <tr><td><strong>User LEDs</strong></td><td>4</td><td>Configurable (Solid/Blink) for DI/Relay/Irrigation/Override feedback.</td></tr>
      <tr><td><strong>User Buttons</strong></td><td>4</td><td>Assignable actions (Relay toggle/pulse, Override, Irrigation start/stop).</td></tr>
      <tr><td><strong>RS‑485 (Modbus)</strong></td><td>1</td><td>Half‑duplex multi‑drop; A/B/COM terminals; fail‑safe &amp; surge‑protected.</td></tr>
      <tr><td><strong>USB‑C</strong></td><td>1</td><td>Service/setup via WebConfig (Web Serial).</td></tr>
      <tr><td><strong>1‑Wire Bus</strong></td><td>1</td><td>+5 V / DATA / GND (logic domain) for DS18B20 sensors.</td></tr>
      <tr><td><strong>Sensor Power</strong></td><td>2</td><td>Isolated +12 V / +5 V rails for <strong>low‑power sensors only</strong> (fused, filtered).</td></tr>
    </tbody>
  </table>

  <h5>5.3 Electrical Specifications</h5>

  <h6>Power &amp; Rails</h6>
  <table>
    <thead><tr><th>Parameter</th><th>Min</th><th>Typ</th><th>Max</th><th>Notes</th></tr></thead>
    <tbody>
      <tr><td><strong>Supply voltage (V+)</strong></td><td>20 V</td><td>24 V</td><td>30 V</td><td>SELV; reverse/surge protected input.</td></tr>
      <tr><td><strong>Power consumption</strong></td><td>—</td><td>1.85 W</td><td>3.0 W</td><td>Module only (no external loads).</td></tr>
      <tr><td><strong>Logic rails</strong></td><td>—</td><td>5 V / 3.3 V</td><td>—</td><td>Buck + LDO derived.</td></tr>
      <tr><td><strong>Isolated sensor rails</strong></td><td>—</td><td>+12 V ISO / +5 V ISO</td><td>—</td><td>Fused, LC‑filtered; for sensors only (≤ ~150 mA shared).</td></tr>
      <tr><td><strong>1‑Wire bus power</strong></td><td>—</td><td>+5 V (logic)</td><td>—</td><td>Non‑isolated, for 1‑Wire devices only.</td></tr>
    </tbody>
  </table>

  <h6>Digital Inputs (DI1…DI5)</h6>
  <table>
    <thead><tr><th>Parameter</th><th>Value / Behavior</th></tr></thead>
    <tbody>
      <tr><td>Type</td><td>Opto‑isolated; dry contact / open‑collector / pulse.</td></tr>
      <tr><td>Threshold</td><td>Low‑voltage, sensor‑level (use GND_ISO return).</td></tr>
      <tr><td>Debounce</td><td>Firmware‑controlled.</td></tr>
      <tr><td>Pulse rate (counter)</td><td>~ up to 9–10 Hz practical for flow meters.</td></tr>
      <tr><td>Isolation</td><td>Field domain to logic via opto barrier.</td></tr>
    </tbody>
  </table>

  <h6>Relay Outputs (R1, R2)</h6>
  <table>
    <thead><tr><th>Parameter</th><th>Value / Behavior</th></tr></thead>
    <tbody>
      <tr><td>Type</td><td>SPDT, dry contact (NO/C/NC).</td></tr>
      <tr><td>Ratings (contacts)</td><td><strong>250 VAC 16 A</strong> (cosφ=1), <strong>250 VAC 9 A</strong> (cosφ=0.4), <strong>30 VDC 10 A</strong>.</td></tr>
      <tr><td>Protection</td><td>RC / varistor snubbers for inductive loads.</td></tr>
      <tr><td>Recommendation</td><td>Use coupling relays for inductive or &gt;5 A continuous loads.</td></tr>
    </tbody>
  </table>

  <h6>Communications</h6>
  <table>
    <thead><tr><th>Interface</th><th>Details</th></tr></thead>
    <tbody>
      <tr><td><strong>RS‑485</strong></td><td>Modbus RTU, half‑duplex; 9600–115200 bps (default <strong>19200</strong>, <strong>8N1</strong>); fail‑safe, short‑circuit limited, surge‑protected.</td></tr>
      <tr><td><strong>USB‑C</strong></td><td>USB 2.0 device for WebConfig (setup only); ESD‑protected; CP2102N bridge.</td></tr>
    </tbody>
  </table>

  <h6>Environment &amp; Compliance</h6>
  <table>
    <thead><tr><th>Parameter</th><th>Value</th></tr></thead>
    <tbody>
      <tr><td>Operating temperature</td><td>0…40 °C</td></tr>
      <tr><td>Humidity</td><td>≤95 % RH, non‑condensing</td></tr>
      <tr><td>Ingress / Safety class</td><td>IP20; Operation Type 1</td></tr>
      <tr><td>Rated impulse (outputs)</td><td>2.5 kV</td></tr>
      <tr><td>Max altitude / pollution</td><td>2000 m / Degree 2</td></tr>
    </tbody>
  </table>

  <h5>5.4 Firmware Behavior</h5>
  <h6>Input → Action &amp; Alarm Logic</h6>
  <ul>
    <li><strong>DI Types:</strong> <em>Water sensor</em>, <em>Soil moisture</em>, <em>Water counter</em> (flow).</li>
    <li><strong>Enable / Invert</strong> per channel; debounce configurable.</li>
    <li><strong>Non‑counter actions:</strong> <code>None</code>, <code>Toggle</code>, <code>Pulse</code> with <strong>Control Target</strong> (<code>Relay 1</code>, <code>Relay 2</code>, <code>All</code>, <code>None</code>).</li>
    <li><strong>Counter channels:</strong> set <strong>PPL</strong>, <strong>Rate× / Total×</strong> calibration; expose <strong>Rate (L/min)</strong> &amp; <strong>Total (L)</strong>.</li>
    <li><strong>Heat energy (optional):</strong> enable on a counter; assign 1‑Wire <strong>Sensor A/B</strong>; set <strong>cp</strong>, <strong>ρ</strong>, <strong>Calibration×</strong>.
      <br><code>Power = cp × ρ × ΔT × FlowRate</code> • <code>Energy = ∑ Power × Δt</code>
    </li>
  </ul>

  <h6>Relay Ownership &amp; Overrides</h6>
  <ul>
    <li><strong>Control Source</strong> per relay: <code>Modbus</code> (default), <code>Local Logic</code> (e.g., irrigation), or <code>None</code>.</li>
    <li><strong>Override:</strong> immediate ON/OFF with <strong>Latch</strong> option; <em>override supersedes</em> Modbus and local logic until cleared.</li>
    <li><strong>Safety:</strong> relays are dry contact; external loads must be powered from a separate supply.</li>
  </ul>

  <h6>LEDs &amp; Buttons</h6>
  <ul>
    <li><strong>LEDs (4):</strong> map to DI, Relays, Irrigation Zones, or Override; <strong>Solid</strong> or <strong>Blink</strong> modes.</li>
    <li><strong>Buttons (4):</strong> assign <code>Toggle/Pulse R1/R2</code>, <code>Override Toggle R1/R2</code>, <code>Irrigation Zone 1/2 Start/Stop</code>.
      <br>Short press = toggle/pulse; Long press (~3 s) = override mode.
    </li>
  </ul>

  <h6>Modbus Defaults &amp; Persistence</h6>
  <ul>
    <li><strong>Defaults:</strong> Address <code>3</code>, Baud <code>19200</code>, <strong>8N1</strong>.</li>
    <li><strong>WebConfig:</strong> changes apply live and are <strong>persisted to flash</strong>.</li>
    <li><strong>Daily sync:</strong> optional midnight sync (<strong>coil 360</strong>) for counters/windows with Home Assistant.</li>
  </ul>

  <h5>5.5 Absolute Electrical Specifications</h5>
  <table>
    <thead><tr><th>Parameter</th><th>Min</th><th>Typ</th><th>Max</th><th>Notes</th></tr></thead>
    <tbody>
      <tr><td><strong>Supply voltage (V+)</strong></td><td>20 V</td><td>24 V</td><td>30 V</td><td>SELV; reverse/surge protected input.</td></tr>
      <tr><td><strong>Power consumption</strong></td><td>—</td><td>1.85 W</td><td>3.0 W</td><td>Module only (no external loads).</td></tr>
      <tr><td><strong>Logic rails</strong></td><td>—</td><td>5 V / 3.3 V</td><td>—</td><td>Buck + LDO derived.</td></tr>
      <tr><td><strong>Isolated sensor rails</strong></td><td>—</td><td>+12 V ISO / +5 V ISO</td><td>—</td><td>Fused &amp; LC‑filtered; specify budget per install.</td></tr>
      <tr><td><strong>Digital inputs</strong></td><td>—</td><td>—</td><td>—</td><td>Opto‑isolated; per‑channel surge protection.</td></tr>
      <tr><td><strong>Relay contacts (R1–R2)</strong></td><td>—</td><td>—</td><td>250 VAC 16 A / 30 VDC 10 A</td><td>Use external snubbers; derate for inductive loads.</td></tr>
      <tr><td><strong>RS‑485 interface</strong></td><td>—</td><td>115200 bps</td><td>—</td><td>Half‑duplex; fail‑safe; surge‑protected.</td></tr>
      <tr><td><strong>USB‑C</strong></td><td>5 V</td><td>—</td><td>—</td><td>USB 2.0 device; ESD‑protected; setup only.</td></tr>
      <tr><td><strong>Operating temperature</strong></td><td>0 °C</td><td>—</td><td>40 °C</td><td>≤95% RH, non‑condensing.</td></tr>
    </tbody>
  </table>

  <h5>5.6 Connector / Terminal Map (Field Side)</h5>
  <p class="muted">External terminals are 5.08 mm pitch pluggable blocks (300 V / 20 A, 26–12 AWG, torque 0.5–0.6 Nm).</p>
  <table>
    <thead><tr><th>Block / Label</th><th>Pin(s) (left → right)</th><th>Function / Signal</th><th>Limits / Notes</th></tr></thead>
    <tbody>
      <tr><td><strong>POWER</strong></td><td><code>V+</code>, <code>0V</code></td><td>24 VDC SELV input</td><td>Reverse &amp; surge protected; <strong>fuse upstream</strong>.</td></tr>
      <tr><td><strong>DIGITAL INPUTS – TOP</strong></td><td><code>I1…I5</code>, <code>GND</code> (ISO)</td><td>DI1…DI5 with isolated return</td><td>Keep returns on GND_ISO; dry‑contact/open‑collector only.</td></tr>
      <tr><td><strong>RELAY1</strong></td><td><code>NO</code>, <code>C</code>, <code>NC</code></td><td>SPDT dry contact</td><td>Follow front label order.</td></tr>
      <tr><td><strong>RELAY2</strong></td><td><code>NO</code>, <code>C</code>, <code>NC</code></td><td>SPDT dry contact</td><td>Follow front label order.</td></tr>
      <tr><td><strong>RS‑485 (bottom left)</strong></td><td><code>B</code>, <code>A</code>, <code>COM</code></td><td>Modbus RTU bus</td><td>Match A/B polarity; COM = reference GND; terminate bus ends.</td></tr>
      <tr><td><strong>1‑WIRE (top right)</strong></td><td><code>+5V</code>, <code>D</code>, <code>GND</code></td><td>1‑Wire bus (logic domain)</td><td>For DS18B20; not isolated from logic.</td></tr>
      <tr><td><strong>SENSOR POWER (bottom right)</strong></td><td><code>+5 V ISO</code>, <code>+12 V ISO</code>, <code>GND_ISO</code></td><td>Isolated sensor rails</td><td>For <strong>sensors only</strong>; fused; no actuators.</td></tr>
      <tr><td><strong>USB‑C (front)</strong></td><td>—</td><td>Web‑Serial config</td><td>ESD‑protected; not a field power source.</td></tr>
    </tbody>
  </table>

  <h5>5.7 Mechanical Details</h5>
  <ul>
    <li><strong>Mounting:</strong> DIN rail EN 50022, 35 mm</li>
    <li><strong>Enclosure:</strong> PC/ABS, V‑0, light gray/black, matte</li>
    <li><strong>Terminals:</strong> 5.08 mm pitch; 26–12 AWG (to 2.5 mm²); <strong>0.5–0.6 Nm</strong> torque</li>
  </ul>

  <h5>5.8 Environmental &amp; Compliance</h5>
  <ul>
    <li><strong>Operating temperature:</strong> 0…40 °C; <strong>Humidity:</strong> ≤95 % RH (non‑condensing)</li>
    <li><strong>Ingress / Safety class:</strong> <strong>IP20</strong>; <strong>Operation Type 1</strong></li>
    <li><strong>Impulse / Altitude / Pollution:</strong> 2.5 kV rated impulse (digital output), max altitude 2000 m, Pollution degree 2</li>
    <li><strong>Installation:</strong> SELV only; by qualified personnel per local codes</li>
  </ul>

  <hr>

  <a id="6-modbus-rtu-communication"></a>
  <h4>6. Modbus RTU Communication</h4>
  <p>The WLD‑521‑R1 communicates as a <strong>Modbus RTU slave</strong> over <strong>RS‑485</strong>, exposing its digital inputs, counters, flow data, heat metrics, relays, LEDs, irrigation state, and 1‑Wire temperatures.</p>

  <h5>6.1 Modbus Basics</h5>
  <table>
    <thead><tr><th>Parameter</th><th>Value</th></tr></thead>
    <tbody>
      <tr><td><strong>Interface</strong></td><td>RS‑485 (half‑duplex)</td></tr>
      <tr><td><strong>Baudrate</strong></td><td>9600–115200 (default: <strong>19200</strong>)</td></tr>
      <tr><td><strong>Address</strong></td><td>1–255 (default: <strong>3</strong>)</td></tr>
      <tr><td><strong>Parity</strong></td><td>8N1</td></tr>
      <tr><td><strong>Role</strong></td><td>Slave (responds to master requests)</td></tr>
      <tr><td><strong>Supported FCs</strong></td><td><code>0x01</code> Read Coils, <code>0x02</code> Read Discrete Inputs, <code>0x03</code> Read Holding, <code>0x04</code> Read Input, <code>0x05/0x0F</code> Write Coils, <code>0x06/0x10</code> Write Holding</td></tr>
    </tbody>
  </table>
  <p class="note">Address and baudrate are configured via USB‑C using WebConfig.</p>

  <h5>6.2 Address Map Overview</h5>
  <table>
    <thead><tr><th>Function</th><th>Range</th><th>Description</th></tr></thead>
    <tbody>
      <tr><td><strong>Coils</strong> (FC01/05)</td><td><code>200–399</code></td><td>Control commands: relay ON/OFF, irrigation, reset</td></tr>
      <tr><td><strong>Discrete Inputs</strong> (FC02)</td><td><code>1–103</code></td><td>Real-time state of DI, relays, LEDs, buttons</td></tr>
      <tr><td><strong>Holding Registers</strong> (FC03/16)</td><td><code>1100+</code></td><td>Flow, temperature, energy, configuration</td></tr>
      <tr><td><strong>Input Registers</strong> (FC04)</td><td><em>mirror of Holding</em></td><td>Read‑only copy (if enabled)</td></tr>
    </tbody>
  </table>

  <h5>6.3 Coils (Write – Single/Multiple)</h5>
  <table>
    <thead><tr><th>Coil Address</th><th>Description</th></tr></thead>
    <tbody>
      <tr><td>200–201</td><td><strong>Relay ON</strong> (Relay 1/2)</td></tr>
      <tr><td>210–211</td><td><strong>Relay OFF</strong> (Relay 1/2)</td></tr>
      <tr><td>300–304</td><td>Enable DI1…DI5</td></tr>
      <tr><td>320–324</td><td>Disable DI1…DI5</td></tr>
      <tr><td>340–344</td><td><strong>Reset DI counter</strong></td></tr>
      <tr><td>360</td><td><code>CMD_TIME_MIDNIGHT</code> (pulse at 00:00 to sync time)</td></tr>
      <tr><td>370–371</td><td>Irrigation <strong>START</strong> Z1/Z2</td></tr>
      <tr><td>380–381</td><td>Irrigation <strong>STOP</strong> Z1/Z2</td></tr>
      <tr><td>390–391</td><td>Irrigation <strong>RESET</strong> Z1/Z2</td></tr>
    </tbody>
  </table>
  <p class="note">Coils are <strong>pulse‑operated</strong> (write <code>TRUE</code>, then <code>FALSE</code>). Manual <strong>overrides</strong> may block Modbus control until cleared.</p>

  <h5>6.4 Discrete Inputs (Read‑only Flags)</h5>
  <table>
    <thead><tr><th>Address</th><th>Bit</th><th>Function</th></tr></thead>
    <tbody>
      <tr><td>1–5</td><td>1–5</td><td>DI1…DI5 (debounced)</td></tr>
      <tr><td>60–61</td><td>—</td><td>Relay 1/2 state</td></tr>
      <tr><td>90–93</td><td>—</td><td>LED1…LED4 (mapped source ON)</td></tr>
      <tr><td>100–103</td><td>—</td><td>BTN1…BTN4 (pressed = 1)</td></tr>
    </tbody>
  </table>

  <h5>6.5 Holding Registers (Read/Write)</h5>

  <h6>📊 Input / Flow / Energy Registers</h6>
  <table>
    <thead><tr><th>Address</th><th>Description</th><th>Format</th><th>Unit</th><th>Notes</th></tr></thead>
    <tbody>
      <tr><td>1100</td><td>Minute of day</td><td>U16</td><td>min (0–1439)</td><td>Local module clock</td></tr>
      <tr><td>1101</td><td>Day index</td><td>U16</td><td>days</td><td>Increments daily</td></tr>
    </tbody>
  </table>

  <h6>Flow Rate &amp; Totals (per DI1–5)</h6>
  <table>
    <thead><tr><th>Address</th><th>Description</th><th>Format</th><th>Notes</th></tr></thead>
    <tbody>
      <tr><td>1120–1129</td><td>Flow rate (L/min ×1000)</td><td>U32 ×5</td><td>2 registers each</td></tr>
      <tr><td>1140–1149</td><td>Flow total (L ×1000)</td><td>U32 ×5</td><td>2 registers each</td></tr>
    </tbody>
  </table>

  <h6>Heat Energy (if enabled)</h6>
  <table>
    <thead><tr><th>Address</th><th>Description</th><th>Format</th><th>Notes</th></tr></thead>
    <tbody>
      <tr><td>1200–1209</td><td>Power (W)</td><td>S32 ×5</td><td>ΔT × cp × ρ × flow</td></tr>
      <tr><td>1220–1229</td><td>Energy (Wh ×1000)</td><td>U32 ×5</td><td>Accumulator</td></tr>
      <tr><td>1240–1249</td><td>ΔT (°C ×1000)</td><td>S32 ×5</td><td>TA–TB</td></tr>
    </tbody>
  </table>

  <h6>🌱 Irrigation Zones (Z1 / Z2)</h6>
  <table>
    <thead><tr><th>Address</th><th>Description</th><th>Format</th></tr></thead>
    <tbody>
      <tr><td>1300–1301</td><td>Zone state (0=idle, 1=run, 2=alarm)</td><td>U16</td></tr>
      <tr><td>1310–1313</td><td>Accumulated liters</td><td>U32</td></tr>
      <tr><td>1320–1323</td><td>Elapsed time (s)</td><td>U32</td></tr>
      <tr><td>1330–1333</td><td>Flow rate (L/min ×1000)</td><td>U32</td></tr>
      <tr><td>1340–1341</td><td>Window Open flag</td><td>U16</td></tr>
      <tr><td>1342–1343</td><td>Sensors OK flag</td><td>U16</td></tr>
    </tbody>
  </table>

  <h6>🌡 1‑Wire Temperatures</h6>
  <table>
    <thead><tr><th>Address</th><th>Description</th><th>Format</th><th>Notes</th></tr></thead>
    <tbody>
      <tr><td>1500–1519</td><td>Temp #1…#10 (°C ×1000)</td><td>S32</td><td>2 regs per sensor</td></tr>
    </tbody>
  </table>

  <h5>6.6 Register Use Examples</h5>
  <ul>
    <li><strong>Read DI1 flow total</strong> — Read <code>HREG 1140/1141</code> (U32) and divide by 1000 → Liters</li>
    <li><strong>Reset DI3 pulse counter</strong> — Write <code>TRUE</code> to coil <code>343</code>, then <code>FALSE</code></li>
    <li><strong>Start irrigation on Zone 1</strong> — Pulse <strong>coil 370</strong></li>
    <li><strong>Sync module time at midnight</strong> — Write <code>0</code> to <code>HREG 1100</code> then pulse <strong>coil 360</strong></li>
  </ul>

  <h5>6.7 Polling Recommendations</h5>
  <table>
    <thead><tr><th>Data Type</th><th>Suggested Rate</th><th>Notes</th></tr></thead>
    <tbody>
      <tr><td>DI / Relay / LED / Button</td><td>1 s</td><td>Coils, discrete inputs</td></tr>
      <tr><td>Flow / Counters</td><td>2–5 s</td><td>Holding or input regs</td></tr>
      <tr><td>1‑Wire Temps</td><td>10–20 s</td><td>Poll less frequently</td></tr>
      <tr><td>Irrigation state</td><td>1–2 s</td><td>For controller‑driven automation</td></tr>
      <tr><td>Heat power/energy</td><td>5–10 s</td><td>Internal logic updates per cycle</td></tr>
    </tbody>
  </table>

  <h5>6.8 Full Register Summary</h5>
  <pre><code>Discrete Inputs (FC02)
00001–00005: DI1–DI5 state
00060–00061: Relay 1/2 mirrors
00090–00093: LED1–LED4 mirrors
00100–00103: BTN1–BTN4 pressed

Coils (FC01/05)
00200–00201: Relay ON (R1–R2)
00210–00211: Relay OFF (R1–R2)
00300–00304: Enable DI (1–5)
00320–00324: Disable DI (1–5)
00340–00344: Reset DI counter (1–5)
00360: CMD_TIME_MIDNIGHT
00370–00371: Irrigation START (Z1–Z2)
00380–00381: Irrigation STOP (Z1–Z2)
00390–00391: Irrigation RESET (Z1–Z2)

Holding/Input Registers (FC03/04)
01100–01101: Clock (minute of day / day index)
01120–01129: Flow rates (L/min ×1000)
01140–01149: Flow totals (L ×1000)
01200–01209: Heat power (W)
01220–01229: Heat energy (Wh ×1000)
01240–01249: ΔT (°C ×1000)
01300–01301: Irrigation state
01310–01313: Irrigation liters
01320–01323: Irrigation elapsed (s)
01330–01333: Irrigation flow (×1000)
01340–01343: Window &amp; sensor flags
01500–01519: 1‑Wire temperatures (×1000)</code></pre>
  <p class="note">All scaling uses ×1000 for flow, temperature, and energy. Convert to engineering units in your controller/ESPHome.</p>

  <hr>

  <a id="7-esphome-integration-guide"></a>
  <h4>7. ESPHome Integration Guide</h4>
  <p>The WLD‑521‑R1 works seamlessly with <strong>ESPHome</strong> through the HomeMaster MiniPLC/MicroPLC (Modbus master). The module exposes all I/O and telemetry via <strong>Modbus RTU</strong>, which ESPHome maps into <strong>entities</strong> for Home Assistant.</p>

  <h5>7.1 ESPHome YAML Setup</h5>
  <pre><code>uart:
  id: uart_modbus
  tx_pin: 17
  rx_pin: 16
  baud_rate: 19200
  parity: NONE
  stop_bits: 1

modbus:
  id: modbus_bus
  uart_id: uart_modbus

packages:
  wld1:
    url: https://github.com/isystemsautomation/HOMEMASTER
    ref: main
    files:
      - path: WLD-521-R1/Firmware/default_wld_521_r1_plc/default_wld_521_r1_plc.yaml
        vars:
          wld_prefix: "WLD#1"
          wld_id: wld_1
          wld_address: 4     # Match this with WebConfig address
    refresh: 1d</code></pre>
  <p class="note">Replace <code>wld_address</code> with your module's actual Modbus ID (default is <code>3</code>). Add more modules by duplicating the package block with unique IDs.</p>

  <h5>7.2 Exposed Entities (via ESPHome)</h5>
  <ul>
    <li><strong>Binary Sensors:</strong> DI1–DI5; Relay mirrors; Buttons; Irrigation flags</li>
    <li><strong>Sensors:</strong> Flow rate &amp; total per DI; 1‑Wire temperatures; ΔT, Power, Energy; Irrigation elapsed/time/flow</li>
    <li><strong>Switches:</strong> Relay 1/2; (optionally) override toggles; irrigation start/stop helpers</li>
  </ul>

  <h5>7.3 Home Assistant Tips</h5>
  <ul>
    <li>Use an HA automation at <strong>00:00</strong> to pulse <strong>coil 360</strong> for daily sync.</li>
    <li>Alert on <strong>leak detection</strong>; shut‑off via R1 override and notify.</li>
    <li>Stop irrigation if <strong>flow drops to 0</strong> while zone is running.</li>
  </ul>

  <h5>7.4 Troubleshooting</h5>
  <table>
    <thead><tr><th>Problem</th><th>Fix</th></tr></thead>
    <tbody>
      <tr><td>No entities show</td><td>Check RS‑485 wiring, A/B polarity, COM ground</td></tr>
      <tr><td>Coil writes fail</td><td>Ensure relay isn’t overridden or owned by local logic</td></tr>
      <tr><td>Midnight reset missing</td><td>Add HA automation to pulse coil <code>360</code></td></tr>
      <tr><td>Flow stuck at 0</td><td>Configure DI as <em>Water counter</em>, set PPL, verify pulses</td></tr>
      <tr><td>1‑Wire not found</td><td>Check +5V/D/GND wiring and bus length/pull‑up</td></tr>
    </tbody>
  </table>

  <hr>

  <a id="8-programming--customization"></a>
  <h4>8. Programming &amp; Customization</h4>

  <h5>8.1 Supported Languages</h5>
  <ul>
    <li>Arduino</li>
    <li>C++</li>
    <li>MicroPython</li>
  </ul>

  <h5>8.2 Flashing</h5>
  <ol>
    <li><strong>Connect via USB‑C</strong> to a computer using Chrome/Edge browser or a serial flasher.</li>
    <li>To enter <strong>bootloader mode</strong>, press and hold <strong>Buttons 1+2</strong>, then release while connecting power.</li>
    <li>To trigger a <strong>hardware reset</strong>, press and hold <strong>Buttons 3+4</strong> for 3 seconds.</li>
    <li>Use <strong>PlatformIO</strong> or <strong>Arduino IDE</strong> with appropriate RP2040/RP2350 board profile.</li>
  </ol>

  <h5>8.3 Arduino / PlatformIO Notes</h5>
  <ul>
    <li><strong>Board config</strong>: Generic RP2040/RP2350 or RP2 family, QSPI flash</li>
    <li><strong>Flash size</strong>: 2 MB Flash (Sketch: 1MB, FS: 1MB)</li>
    <li><strong>Required Libraries</strong>:
      <ul>
        <li><code>Arduino.h</code></li>
        <li><code>ModbusSerial.h</code></li>
        <li><code>SimpleWebSerial.h</code></li>
        <li><code>Arduino_JSON.h</code></li>
        <li><code>LittleFS.h</code></li>
        <li><code>OneWire.h</code></li>
        <li><code>hardware/watchdog.h</code></li>
      </ul>
    </li>
    <li><strong>Pin Mapping</strong> aligns with RP2350 definitions; see schematic for GPIO layout.</li>
  </ul>

  <h5>8.4 Firmware Updates</h5>
  <ul>
    <li>Use <strong>WebConfig</strong> or USB‑C to re‑flash firmware with the appropriate boot/reset combination.</li>
    <li>Configuration is stored in persistent flash (retained across firmware upgrades).</li>
    <li>If a flash fails, enter BOOT mode manually and retry via browser uploader or PlatformIO CLI.</li>
    <li>WebConfig can restore base config with default values if corrupted.</li>
  </ul>

  <hr>

  <a id="9-maintenance--troubleshooting"></a>
  <h4>9. Maintenance &amp; Troubleshooting</h4>

  <h5>9.1 Status LED Meanings</h5>
  <table>
    <thead><tr><th>LED</th><th>Meaning</th></tr></thead>
    <tbody>
      <tr><td><strong>PWR</strong></td><td>Steady ON = power OK</td></tr>
      <tr><td><strong>TX/RX</strong></td><td>Blink on RS‑485 activity</td></tr>
      <tr><td><strong>USB</strong></td><td>Lit when WebConfig is connected</td></tr>
      <tr><td><strong>LED1–4</strong></td><td>Mapped per UI config (DI/Relay/Irrigation/Override)</td></tr>
    </tbody>
  </table>

  <h5>9.2 Reset Methods</h5>
  <ul>
    <li><strong>Soft reset:</strong> WebConfig → <em>Reset Device</em></li>
    <li><strong>Hard reset:</strong> hold <strong>Buttons 3 + 4</strong> for ~3 s</li>
    <li><strong>Bootloader:</strong> hold <strong>Buttons 1 + 2</strong> while powering the device</li>
  </ul>

  <h5>9.3 Common Issues</h5>
  <table>
    <thead><tr><th>Symptom</th><th>Likely Cause → Fix</th></tr></thead>
    <tbody>
      <tr><td>No Modbus comms</td><td>A/B swapped, missing <strong>COM</strong> reference, wrong baud/address</td></tr>
      <tr><td>Relay won’t trigger</td><td>Relay in <strong>override</strong>, or <strong>Owner</strong> set to <em>None/Logic</em></td></tr>
      <tr><td>Flow stays 0</td><td>DI not set to <em>Water counter</em>, wrong PPL, no pulses</td></tr>
      <tr><td>1‑Wire not found</td><td>Wiring to +5V/D/GND, long bus, or pull‑up issue</td></tr>
      <tr><td>WebConfig not connecting</td><td>Use Chrome/Edge; close other serial apps; try new cable/port</td></tr>
    </tbody>
  </table>

  <hr>

  <a id="10-open-source--licensing"></a>
  <h4>10. Open Source &amp; Licensing</h4>
  <ul>
    <li><strong>Hardware:</strong> <strong>CERN‑OHL‑W v2</strong></li>
    <li><strong>Firmware:</strong> <strong>GPLv3</strong></li>
    <li><strong>Config Tools:</strong> <strong>MIT</strong></li>
  </ul>
  <p class="tip">The repository contains design files, firmware, and tools. Contributions are welcome.</p>

  <hr>

  <a id="11-downloads"></a>
  <h4>11. Downloads</h4>
  <ul>
    <li><strong>Firmware binaries</strong> — <code>Firmware/default_wld_521_r1/</code></li>
    <li><strong>ESPHome YAML configs</strong> — <code>Firmware/default_wld_521_r1_plc/</code></li>
    <li><strong>WebConfig Tool</strong> — <code>Firmware/ConfigToolPage.html</code></li>
    <li><strong>Schematics</strong> — <code>Schematics/WLD-521-R1-FieldBoard.pdf</code>, <code>Schematics/WLD-521-R1-MCUBoard.pdf</code></li>
    <li><strong>Images &amp; diagrams</strong> — <code>Images/</code></li>
    <li><strong>Datasheet</strong> — <code>Manuals/WLD-521-R1 Datasheet.pdf</code></li>
  </ul>

  <hr>

  <a id="12-support"></a>
  <h4>12. Support</h4>
  <ul>
    <li><strong>Support Portal:</strong> https://www.home-master.eu/support</li>
    <li><strong>WebConfig:</strong> https://www.home-master.eu/configtool-wld-521-r1</li>
    <li><strong>YouTube:</strong> https://youtube.com/@HomeMaster</li>
    <li><strong>Hackster:</strong> https://hackster.io/homemaster</li>
    <li><strong>Reddit:</strong> https://reddit.com/r/HomeMaster</li>
    <li><strong>Instagram:</strong> https://instagram.com/home_master.eu</li>
  </ul>

</div>
