<section style="font-family:'Segoe UI',system-ui,Roboto,Arial,sans-serif;padding:2rem;max-width:1100px;margin:auto;">
  <style>
    .layout-2col{display:grid;grid-template-columns:1fr 1fr;gap:1.25rem;}
    .span-2{grid-column:1 / -1;}
    .cards-2col{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
    @media (max-width:720px){.layout-2col{grid-template-columns:1fr}.cards-2col{grid-template-columns:1fr}section{padding:0}}
    .card{border:1px solid #ccc;border-radius:6px;padding:1rem;background:#fff}
    .card.di{background:#e6f7e8}.card.btn{background:#cbdcf7}.card.led{background:#f3f5d0}
    .label{font-size:.9rem;color:#333;margin-bottom:.25rem;display:block}.tiny{font-size:.8rem;color:#666}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin:.35rem 0}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.5rem;margin:.35rem 0}
    .pill{font-size:.85rem;padding:.15rem .5rem;border-radius:999px;border:1px solid #ddd;background:#eef;color:#223}
    .inline{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    button{cursor:pointer}
  </style>

  <div style="text-align:center;margin-bottom:2rem;">
    <img src="https://www.home-master.eu/web/image/product.image/14/image_1024/Untitled-2.webp?unique=1d6564f" alt="DIM-420-R1" style="max-width:300px;border-radius:8px;" loading="lazy">
    <h2>DIM-420-R1 Module Configuration</h2>
    <p>Configure Modbus, <strong>digital inputs (4)</strong>, <strong>dimming channels (2)</strong>, <strong>buttons (4)</strong>, and <strong>user LEDs (4)</strong> via Web Serial.</p>
  </div>

  <div style="background:#f1f5ff;padding:1rem 1.25rem;margin-bottom:2rem;border-radius:6px;border-left:4px solid #2f6fff;">
    <strong>Active Modbus Configuration</strong><br>
    Address: <span id="live-address" style="font-weight:600;">--</span> |
    Baud Rate: <span id="live-baud" style="font-weight:600;">--</span>
  </div>

  <form id="modbus-config" style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:2rem;">
    <div>
      <label for="modbus-address" class="label"><strong>Modbus Address</strong></label>
      <select id="modbus-address" style="width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;"></select>
    </div>
    <div>
      <label for="modbus-baud" class="label"><strong>Baud Rate</strong></label>
      <select id="modbus-baud" style="width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;">
        <option>9600</option><option selected="">19200</option><option>38400</option><option>57600</option><option>115200</option>
      </select>
    </div>
    <div style="grid-column:span 2;text-align:right;">
      <button id="connect-button" type="button" style="padding:.55rem .9rem;border-radius:6px;border:1px solid #2f6fff;background:#2f6fff;color:#fff;">Connect</button>
    </div>
  </form>

  <div id="log-line" style="margin-bottom:1.5rem;padding:1rem;background:#f9f9f9;border:1px solid #ccc;border-radius:6px;font-size:0.9rem;color:#333;font-family:monospace;">
    <strong>Serial Log:</strong>
    <div id="log-content" style="white-space:pre-wrap;"></div>
  </div>

  <div class="layout-2col">
    <section class="span-2">
      <h2 style="font-size:1.2rem;">Dimming Channels (2)</h2>
      <div id="channels-config" class="cards-2col"></div>
    </section>

    <section class="span-2">
      <h2 style="font-size:1.2rem;">Digital Inputs (4)</h2>
      <div id="inputs-config" class="cards-2col"></div>
    </section>

    <section class="span-2">
      <h2 style="font-size:1.2rem;">Buttons (4)</h2>
      <div id="buttons-config" class="cards-2col"></div>
      <p class="tiny" style="margin-top:.5rem;">
        <em>Hardware note:</em> On-board buttons are inverted in the schematic and handled in firmware (HIGH = pressed).
      </p>
    </section>

    <section class="span-2">
      <h2 style="font-size:1.2rem;">User LEDs (4)</h2>
      <div id="leds-config" class="cards-2col"></div>
    </section>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
  <script src="https://unpkg.com/simple-web-serial@latest/dist/simple-web-serial.min.js"></script>
  <script>
  (function () {
    // ---------- Constants & helpers ----------
    const N={DI:4,CH:2,BTN:4,LED:4}; const LOG_STORE=80, LOG_SHOW=10, DEB=200, CH_DEB=120;
    const $=id=>document.getElementById(id);
    const clamp=(a,v,b)=>Math.min(b,Math.max(a,Number(v)||0));
    const c255=v=>clamp(0,v,255), c100=v=>clamp(0,v,100), c2=v=>clamp(0,v,2), c01=v=>clamp(0,v,1);
    const on=(el,ev,fn)=>el&&el.addEventListener(ev,fn,{passive:true});
    const logBuf=[]; const log=(lbl,data)=>{const t=new Date().toLocaleTimeString(); const line=`[${t}] ${lbl}: ${typeof data==='string'?data:JSON.stringify(data)}`; logBuf.push(line); if(logBuf.length>LOG_STORE) logBuf.shift(); $("log-content").innerText=logBuf.slice(-LOG_SHOW).join("\n");};
    const asArr=(x)=> Array.isArray(x) ? x : (x && typeof x==='object' ? Object.values(x) : []);

    // ---------- Builders ----------
    const CH = i => `
      <div class="card" style="background:#f1f1f1;">
        <div style="display:flex;justify-content:space-between;align-items:center;font-weight:600;">
          <span>Channel ${i}</span><span id="on-ch${i}" style="width:12px;height:12px;background:#ccc;border-radius:50%;display:inline-block;"></span>
        </div>
        <div class="inline" style="margin:.35rem 0 .6rem;">
          <span class="tiny" style="color:#555;">AC on L–N:</span><span id="ac-badge-ch${i}" class="pill">--</span>
          <span class="tiny" style="margin-left:.5rem;color:#555;">Frequency:</span><span id="freq-badge-ch${i}" class="pill">--.-- Hz</span>
        </div>
        <label class="label"><input type="checkbox" id="enable-ch${i}"> Enabled</label>
        <div class="row">
          <label class="label">Load Type
            <select id="lt-ch${i}" style="width:100%;padding:.4rem;border-radius:6px;border:1px solid #ccc;">
              <option value="0">Lamp (log)</option><option value="1">Heater (linear)</option><option value="2">Key</option>
            </select>
          </label>
          <label class="label">Cutoff Mode
            <select id="cm-ch${i}" style="width:100%;padding:.4rem;border-radius:6px;border:1px solid #ccc;">
              <option value="0">Leading (RL)</option><option value="1">Trailing (RC)</option>
            </select>
          </label>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.2rem;">
          <label class="label" style="flex:1;">Setpoint (%)
            <input type="range" id="percent-ch${i}" min="0" max="100" step="1" value="0" style="width:100%;">
          </label>
          <div style="width:170px;margin-left:.6rem;font-size:.95rem;color:#333;display:flex;flex-direction:column;align-items:flex-end;">
            <span>Actual level: <strong id="level-val-ch${i}">0</strong></span>
            <span style="font-family:monospace;">range <span id="range-ch${i}">[20..255]</span></span>
            <span><strong id="percent-val-ch${i}">0</strong>%</span>
          </div>
        </div>
        <div class="row" style="margin-top:.6rem;">
          <label class="label">Lower threshold
            <input type="number" id="lower-ch${i}" min="0" max="255" step="1" value="20" style="width:100%;padding:.4rem;border-radius:6px;border:1px solid #ccc;">
          </label>
          <label class="label">Upper threshold
            <input type="number" id="upper-ch${i}" min="0" max="255" step="1" value="255" style="width:100%;padding:.4rem;border-radius:6px;border:1px solid #ccc;">
          </label>
        </div>
        <div class="row" style="margin-top:.6rem;grid-template-columns:1fr;">
          <label class="label">Preset level (0–255) <span class="pill">Used on Toggle</span>
            <input type="number" id="preset-ch${i}" min="0" max="255" step="1" value="200" style="width:100%;padding:.4rem;border-radius:6px;border:1px solid #ccc;">
          </label>
        </div>
      </div>`;

    const DI_ACT=[{v:0,t:'None'},{v:1,t:'Turn on'},{v:2,t:'Turn off'},{v:3,t:'Toggle output'},{v:4,t:'Increase'},{v:5,t:'Decrease'},{v:6,t:'Increase then Decrease'}];
    const DI_TGT=[{v:0,t:'None'},{v:4,t:'All channels'},{v:1,t:'Channel 1'},{v:2,t:'Channel 2'}];
    const DI_SW=[{v:0,t:'Momentary pushbutton'},{v:1,t:'Latching switch'}];
    const DI_LM=[{v:0,t:'Toggle to preset or 0'},{v:1,t:'Increase/Decrease until toggle'}];
    const opt=s=>s.map(o=>`<option value="${o.v}">${o.t}</option>`).join('');
    const DI = i => `
      <div class="card di">
        <div style="display:flex;justify-content:space-between;align-items:center;font-weight:600;margin-bottom:.4rem;">
          <span>IN${i}</span><span id="state-in${i}" style="width:12px;height:12px;background:#ccc;border-radius:50%;display:inline-block;"></span>
        </div>
        <div class="row-3">
          <label class="label"><input type="checkbox" id="enable-in${i}"> Enabled</label>
          <label class="label"><input type="checkbox" id="invert-in${i}"> Inverted</label>
          <label class="label">Switch Type
            <select id="swtype-in${i}" style="width:100%;padding:.35rem;border-radius:6px;border:1px solid #ccc;">${opt(DI_SW)}</select>
          </label>
        </div>
        <div id="momentary-wrap-in${i}" style="border:1px dashed #a6c8a6;border-radius:6px;padding:.6rem;margin-top:.4rem;">
          <div class="tiny" style="margin-bottom:.25rem;">Momentary press mappings</div>
          ${['Short','Long','DoubleShort','ShortThenLong'].map(k=>`
            <div class="row">
              <label class="label" style="margin:0;">${k} — Action
                <select id="act-${k.toLowerCase()}-in${i}" style="width:100%;padding:.35rem;border-radius:6px;border:1px solid #ccc;">${opt(DI_ACT)}</select>
              </label>
              <label class="label" style="margin:0;">${k} — Target
                <select id="tgt-${k.toLowerCase()}-in${i}" style="width:100%;padding:.35rem;border-radius:6px;border:1px solid #ccc;">${opt(DI_TGT)}</select>
              </label>
            </div>`).join('')}
        </div>
        <div id="latching-wrap-in${i}" style="border:1px dashed #a6c8a6;border-radius:6px;padding:.6rem;margin-top:.4rem;display:none;">
          <div class="tiny" style="margin-bottom:.25rem;">Latching toggle behavior</div>
          <div class="row">
            <label class="label">Latch Mode
              <select id="lmode-in${i}" style="width:100%;padding:.35rem;border-radius:6px;border:1px solid #ccc;">${opt(DI_LM)}</select>
            </label>
            <label class="label">Latch Target
              <select id="ltgt-in${i}" style="width:100%;padding:.35rem;border-radius:6px;border:1px solid #ccc;">${opt(DI_TGT)}</select>
            </label>
          </div>
        </div>
      </div>`;

    const BTN_ACT=[{v:0,t:'None'},{v:1,t:'Toggle CH1'},{v:2,t:'Toggle CH2'},{v:3,t:'Step Up CH1'},{v:4,t:'Step Down CH1'},{v:5,t:'Step Up CH2'},{v:6,t:'Step Down CH2'}];
    const BTN = i => `<div class="card btn"><div style="font-weight:600;">Button ${i}<span id="state-button${i}" style="width:12px;height:12px;background:#ccc;border-radius:50%;display:inline-block;float:right;"></span></div><label class="label">Action:<select id="action-button${i}" style="width:100%;padding:6px;border-radius:4px;border:1px solid #ccc;">${opt(BTN_ACT)}</select></label></div>`;
    const LED = i => `<div class="card led"><div style="font-weight:600;">User LED ${i}<span id="state-led${i}" style="width:12px;height:12px;background:#ccc;border-radius:50%;display:inline-block;float:right;"></span></div><label class="label">Mode:<select id="mode-led${i}" style="width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;"><option value="0">Steady (active)</option><option value="1">Blink (active)</option></select></label><br><label class="label">Source:<select id="source-led${i}" style="width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;"><option value="0">None</option><option value="1">Channel 1</option><option value="2">Channel 2</option></select></label></div>`;

    (function mount(){
      const addrSel=$('modbus-address'); for(let i=1;i<=247;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent=String(i); addrSel.appendChild(o); }
      const ch=$('channels-config'); for(let i=1;i<=N.CH;i++) ch.insertAdjacentHTML('beforeend', CH(i));
      const di=$('inputs-config');   for(let i=1;i<=N.DI;i++) di.insertAdjacentHTML('beforeend', DI(i));
      const bt=$('buttons-config');  for(let i=1;i<=N.BTN;i++) bt.insertAdjacentHTML('beforeend', BTN(i));
      const ld=$('leds-config');     for(let i=1;i<=N.LED;i++) ld.insertAdjacentHTML('beforeend', LED(i));
    })();

    // ---------- Serial ----------
    const conn=SimpleWebSerial.setupSerialConnection({requestAccessOnPageLoad:false, requestElement:'connect-button'});
    const isOpen=()=>{ try{return typeof conn.isOpen==='function'?conn.isOpen():!!conn.port;}catch{return false;} };
    const send=(t,p)=>{ if(isOpen()) try{ conn.send(t,p); }catch(e){} };

    conn.on('open', ()=>{ pingValues(); });
    conn.on('close', ()=>{ /* no reset handling */ });
    conn.on('message', msg=> log('DIM-420-R1', msg));
    conn.on('config', cfg => applyConfig(cfg));

    // Modbus -> values
    const pingValues=()=> {
      const addr = Number($('modbus-address').value||3);
      const baud = Number($('modbus-baud').value||19200);
      send('values',{mb_address:addr, mb_baud:baud});
    };
    on($('modbus-address'),'change', pingValues);
    on($('modbus-baud'),'change', pingValues);

    // ---------- Debounced send ----------
    const timers={}; let echoGuard=false;
    const schedule=(key,fn,ms=DEB)=>{ if(!isOpen()||echoGuard) return; clearTimeout(timers[key]); timers[key]=setTimeout(fn,ms); };
    const acBadge=(id,on)=>{ const b=$(id); if(!b) return; if(on){ b.textContent='ON'; b.style.background='#d4edda'; b.style.color='#155724'; b.style.borderColor='#c3e6cb'; } else { b.textContent='OFF'; b.style.background='#fdecea'; b.style.color='#b71c1c'; b.style.borderColor='#f5c6cb'; } };

    // ---------- Channels (senders) ----------
    function chList(){
      const list=[];
      for(let i=1;i<=N.CH;i++){
        list.push({
          enabled:$('enable-ch'+i).checked,
          lower:c255($('lower-ch'+i).value), upper:c255($('upper-ch'+i).value),
          loadType:c2($('lt-ch'+i).value),   cutMode:c01($('cm-ch'+i).value),
          percent:c100($('percent-ch'+i).value), preset:c255($('preset-ch'+i).value)
        });
        const r=$('range-ch'+i); if(r) r.textContent=`[${c255($('lower-ch'+i).value)}..${c255($('upper-ch'+i).value)}]`;
      }
      return list;
    }
    const chSend=()=> send('Config',{t:'channels',list:chList()});
    function chBind(i){
      on($('percent-ch'+i),'input',()=>{ $('percent-val-ch'+i).textContent=String(c100($('percent-ch'+i).value)); schedule('ch',chSend,CH_DEB); });
      ['enable','lt','cm','lower','upper','preset'].forEach(k=>{
        const id=(k==='enable')?'enable-ch':(k==='lt')?'lt-ch':(k==='cm')?'cm-ch':(k+'-ch');
        const ev=(k==='lower'||k==='upper'||k==='preset')?'input':'change';
        on($(id+i),ev,()=>schedule('ch',chSend,CH_DEB));
      });
    }
    for(let i=1;i<=N.CH;i++) chBind(i);

    // ---------- DI (senders) ----------
    const diShow=()=>{ for(let i=1;i<=N.DI;i++){ const sw=parseInt(($('swtype-in'+i)?.value)||'0',10); $('momentary-wrap-in'+i).style.display=(sw===0)?'':'none'; $('latching-wrap-in'+i).style.display=(sw===1)?'':'none'; } };
    for(let i=1;i<=N.DI;i++){
      on($('enable-in'+i),'change',()=> schedule('di-en', ()=> send('Config',{t:'inputEnable', list:[...Array(N.DI)].map((_,k)=>$('enable-in'+(k+1)).checked)})));
      on($('invert-in'+i),'change',()=> schedule('di-inv',()=> send('Config',{t:'inputInvert', list:[...Array(N.DI)].map((_,k)=>$('invert-in'+(k+1)).checked)})));
      on($('swtype-in'+i),'change',()=>{ diShow(); schedule('di-sw', ()=> send('Config',{t:'inputSwitchType', list:[...Array(N.DI)].map((_,k)=>parseInt($('swtype-in'+(k+1)).value||'0',10))})); });

      const pair = (key,selMaker) => schedule('di-'+key, ()=> send('Config',{ t:key, list:[...Array(N.DI)].map((_,k)=>parseInt(selMaker(k+1).value||'0',10)) }));
      [['short','Short'],['long','Long'],['doubleshort','DoubleShort'],['shortthenlong','ShortThenLong']]
        .forEach(([k,K])=>{
          on($('act-'+k+'-in'+i),'change',()=> pair('inputPressAction'+K, j=>$('act-'+k+'-in'+j)));
          on($('tgt-'+k+'-in'+i),'change',()=> pair('inputPressTarget'+K, j=>$('tgt-'+k+'-in'+j)));
        });

      on($('lmode-in'+i),'change',()=> schedule('di-lmode',()=> send('Config',{t:'inputLatchMode', list:[...Array(N.DI)].map((_,k)=>parseInt($('lmode-in'+(k+1)).value||'0',10))})));
      on($('ltgt-in'+i),'change', ()=> schedule('di-ltgt', ()=> send('Config',{t:'inputLatchTarget', list:[...Array(N.DI)].map((_,k)=>parseInt($('ltgt-in'+(k+1)).value||'0',10))})));
    }

    // ---------- Buttons (senders) ----------
    for(let i=1;i<=N.BTN;i++){
      on($('action-button'+i),'change',()=>{
        if(!isOpen()) return;
        const list=[]; for(let j=1;j<=N.BTN;j++) list.push({action:parseInt(($('action-button'+j).value)||'0',10)});
        send('Config',{t:'buttons',list});
      });
    }

    // ---------- LEDs (senders) ----------
    const ledSend=()=>{ if(!isOpen()) return; const list=[]; for(let j=1;j<=N.LED;j++) list.push({mode:parseInt(($('mode-led'+j).value)||'0',10), source:parseInt(($('source-led'+j).value)||'0',10)}); send('Config',{t:'leds',list}); };
    for(let i=1;i<=N.LED;i++){ on($('mode-led'+i),'change',ledSend); on($('source-led'+i),'change',ledSend); }

    // ---------- Apply quiet-firmware snapshots ----------
    function applyConfig(cfg){
      if(!cfg) return;

      const mb = cfg.mb || {};
      $('live-address').textContent = (mb.address!=null)? String(mb.address) : '--';
      $('live-baud').textContent    = (mb.baud!=null)? String(mb.baud) : '--';
      echoGuard=true;
      try{
        if(mb.address!=null) $('modbus-address').value=String(mb.address);
        if(mb.baud!=null)    $('modbus-baud').value=String(mb.baud);
      }finally{ echoGuard=false; }

      const chA = asArr(cfg.ch);
      chA.forEach((c,idx)=>{
        const i=idx+1; if(!c) return;
        echoGuard=true;
        try{
          const en=$('enable-ch'+i), lo=$('lower-ch'+i), hi=$('upper-ch'+i), lt=$('lt-ch'+i), cm=$('cm-ch'+i), pr=$('preset-ch'+i), pc=$('percent-ch'+i);
          if(en) en.checked=!!c.enabled;
          if(lo) lo.value=String(c255(c.lower));
          if(hi) hi.value=String(c255(c.upper));
          if(lt) lt.value=String(c2(c.loadType));
          if(cm) cm.value=String(c01(c.cutMode));
          if(pr) pr.value=String(c255(c.preset));
          if(pc){ const p=c100(c.percent); pc.value=String(p); const pv=$('percent-val-ch'+i); if(pv) pv.textContent=String(p); }
          const r=$('range-ch'+i); if(r) r.textContent=`[${c255(c.lower)}..${c255(c.upper)}]`;
        }finally{ echoGuard=false; }
        const lvl = Number(c.level||0);
        $('level-val-ch'+i).textContent=String(lvl);
        $('on-ch'+i).style.background=(lvl>0)?'#4caf50':'#ccc';
        acBadge('ac-badge-ch'+i, !!c.zc_ok);
        const f=$('freq-badge-ch'+i); if(f) f.textContent=((Number(c.freq_x100||0)/100).toFixed(2)+' Hz');
      });

      const diA = asArr(cfg.di);
      echoGuard=true;
      try{
        diA.forEach((d,idx)=>{
          const i=idx+1; if(!d) return;
          const en=$('enable-in'+i), inv=$('invert-in'+i), sw=$('swtype-in'+i);
          if(en) en.checked=!!d.enabled;
          if(inv) inv.checked=!!d.invert;
          if(sw)  sw.value=String(d.switchType||0);
          const setPair=(key,p)=>{ const a=$('act-'+key+'-in'+i), t=$('tgt-'+key+'-in'+i); if(a&&p) a.value=String(p.action||0); if(t&&p) t.value=String(p.target||0); };
          setPair('short', d.press?.short); setPair('long', d.press?.long);
          setPair('doubleshort', d.press?.doubleShort); setPair('shortthenlong', d.press?.shortThenLong);
          const lm=$('lmode-in'+i), lt=$('ltgt-in'+i);
          if(lm) lm.value=String(d.latchMode||0);
          if(lt) lt.value=String(d.latchTarget||0);

          // NEW: live DI state bubble
          const st=$('state-in'+i);
          if(st && typeof d.state!=='undefined'){ st.style.background=d.state ? '#4caf50' : '#ccc'; }
        });
      }finally{ echoGuard=false; }
      diShow();

      const btnA=asArr(cfg.btn);
      echoGuard=true;
      try{
        btnA.forEach((b,idx)=>{ const i=idx+1; const sel=$('action-button'+i), st=$('state-button'+i); if(sel&&b) sel.value=String(b.action||0); if(st&&b) st.style.background=b.state?'#4caf50':'#ccc'; });
      }finally{ echoGuard=false; }

      const ledA=asArr(cfg.led);
      echoGuard=true;
      try{
        ledA.forEach((L,idx)=>{ const i=idx+1; const m=$('mode-led'+i), s=$('source-led'+i), st=$('state-led'+i); if(m&&L) m.value=String(L.mode||0); if(s&&L) s.value=String(L.source||0); if(st&&L) st.style.background=L.state?'#ffb300':'#ccc'; });
      }finally{ echoGuard=false; }
    }
  })();
  </script>
</section>