<section style="font-family:'Segoe UI',sans-serif;padding:2rem;max-width:960px;margin:auto;">
  <div style="text-align:center;margin-bottom:2rem;">
    <img src="https://www.home-master.eu/web/image/product.image/14/image_1024/Untitled-2.webp?unique=1d6564f"
         alt="AIO-422-R1" style="max-width:300px;border-radius:8px;" loading="lazy">
    <h2>AIO-422-R1 Module Configuration</h2>
    <p>
      Configure Modbus address, baud rate, and monitor
      <strong>analog inputs (4)</strong>, <strong>analog outputs (2)</strong>,
      <strong>RTD inputs (2)</strong>, <strong>buttons (4)</strong>,
      <strong>user LEDs (4)</strong>, and <strong>4× PID controllers</strong>
      via Web Serial.
    </p>
  </div>

  <!-- Active Modbus status -->
  <div style="background:#f1f1f1;padding:1rem 1.5rem;margin-bottom:2rem;border-radius:6px;border-left:4px solid #007bff;">
    <strong>Active Modbus Configuration</strong><br>
    Address: <span id="live-address" style="font-weight:600;">--</span> |
    Baud Rate: <span id="live-baud" style="font-weight:600;">--</span>
  </div>

  <!-- Modbus config + connect -->
  <form id="modbus-config"
        style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:2rem;">
    <div>
      <label for="modbus-address"><strong>Modbus Address</strong></label>
      <select id="modbus-address" style="width:100%;padding:10px;border-radius:4px;"></select>
    </div>
    <div>
      <label for="modbus-baud"><strong>Baud Rate</strong></label>
      <select id="modbus-baud" style="width:100%;padding:10px;border-radius:4px;">
        <option>9600</option>
        <option selected>19200</option>
        <option>38400</option>
        <option>57600</option>
        <option>115200</option>
      </select>
    </div>
    <div style="grid-column:span 2;text-align:right;">
      <button id="connect-button" type="button"
              style="padding:10px 20px;background:#007bff;color:#fff;border:none;border-radius:4px;">
        Connect
      </button>
      <button id="reset-button" type="button"
              style="padding:10px 20px;background:#dc3545;color:#fff;border:none;border-radius:4px;margin-left:0.75rem;"
              disabled>
        Reset Device
      </button>
    </div>
  </form>

  <!-- Serial log -->
  <div id="log-line"
       style="margin-bottom:1.5rem;padding:1rem;background:#f9f9f9;border:1px solid #ccc;border-radius:6px;font-size:0.9rem;color:#333;font-family:monospace;">
    <strong>Serial Log:</strong>
    <div id="log-content" style="white-space:pre-wrap;"></div>
  </div>

  <!-- Live sections -->
  <section>
    <h2 style="font-size:1.2rem;">Analog Inputs (4 × 0–10&nbsp;V)</h2>
    <p style="margin-top:-.25rem;color:#555;font-size:.9rem;">
      Firmware reports field voltage in millivolts (0–10000&nbsp;mV). Voltage is calculated directly.
    </p>
    <div id="ai-cards"
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;"></div>
  </section>

  <section style="margin-top:2rem;">
    <h2 style="font-size:1.2rem;">Analog Outputs (2 × 0–10&nbsp;V)</h2>
    <p style="margin-top:-.25rem;color:#555;font-size:.9rem;">
      DAC raw value is 0..4095 (MCP4725). 4095 ≈ 10&nbsp;V at the terminal.
    </p>
    <div id="dac-cards"
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;"></div>
  </section>

  <section style="margin-top:2rem;">
    <h2 style="font-size:1.2rem;">RTD Inputs (2 × PT100)</h2>
    <div id="rtd-cards"
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;"></div>
  </section>

  <section style="margin-top:2rem;">
    <h2 style="font-size:1.2rem;">Buttons (4)</h2>
    <p style="margin-top:-.25rem;color:#555;font-size:.9rem;">
      Button states are read directly from the device.
    </p>
    <div id="buttons-cards"
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;"></div>
  </section>

  <section style="margin-top:2rem;">
    <h2 style="font-size:1.2rem;">User LEDs (4)</h2>
    <div id="leds-cards"
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;"></div>
  </section>

  <!-- PID Controllers -->
  <section style="margin-top:2rem;">
    <h2 style="font-size:1.2rem;">PID Controllers (4)</h2>
    <p style="margin-top:-.25rem;color:#555;font-size:.9rem;">
      Each PID works internally in <strong>0–100%</strong> (PV, SP, OUT). Scaling is configured here in raw units.
      Modbus still uses raw values only.
    </p>
    <div id="pid-cards"
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;margin-bottom:0.75rem;"></div>
    <div style="text-align:right;">
      <button id="pid-apply-all" type="button"
              style="padding:8px 16px;background:#28a745;color:#fff;border:none;border-radius:4px;">
        Apply PID Configuration
      </button>
    </div>
  </section>

  <!-- Scripts -->
  <script src="https://unpkg.com/simple-web-serial@latest/dist/simple-web-serial.min.js"></script>
  <script>
    (function () {
      const NUM_AI  = 4;
      const NUM_DAC = 2;
      const NUM_BTN = 4;
      const NUM_LED = 4;
      const NUM_PID = 4;

      const LOG_MAX = 4;
      const logBuffer = [];
      const $ = (id) => document.getElementById(id);

      const dacValues = [0, 0];

      // PID config buffers
      const pidSp     = [0, 0, 0, 0];  // SP raw
      const pidEn     = [0, 0, 0, 0];  // 0/1
      const pidPvSrc  = [0, 0, 0, 0];  // 0,1..4,5,6
      const pidSpSrc  = [0, 0, 0, 0];  // 0..4
      const pidOutSel = [0, 0, 0, 0];  // 0..2
      const pidKp     = [0, 0, 0, 0];  // real gains
      const pidKi     = [0, 0, 0, 0];
      const pidKd     = [0, 0, 0, 0];

      // Scaling buffers (RAW units)
      const pidPvMin  = [0, 0, 0, 0];
      const pidPvMax  = [10000, 10000, 10000, 10000];
      const pidOutMin = [0, 0, 0, 0];
      const pidOutMax = [4095, 4095, 4095, 4095];

      // per-PID editing lock
      const pidEditing = [false, false, false, false];

      const toList = (v) => {
        if (Array.isArray(v)) return v;
        if (v && typeof v === "object") {
          return Object.keys(v).sort((a,b)=>Number(a)-Number(b)).map(k => v[k]);
        }
        return [];
      };

      function appendLog(label, data) {
        const logEl = $("log-content");
        if (!logEl) return;
        const time = new Date().toLocaleTimeString();
        const line = `[${time}] ${label}: ` + (typeof data === "string" ? data : JSON.stringify(data));
        logBuffer.unshift(line);
        if (logBuffer.length > LOG_MAX) logBuffer.pop();
        logEl.textContent = logBuffer.join("\n");
      }

      // Populate Modbus addresses 1..255
      (function populateAddresses() {
        const addrSelect = $("modbus-address");
        if (!addrSelect) return;
        for (let i = 1; i <= 255; i++) {
          const opt = document.createElement("option");
          opt.value = i;
          opt.textContent = i;
          if (i === 3) opt.selected = true;
          addrSelect.appendChild(opt);
        }
      })();

      // WebSerial setup
      const connection = SimpleWebSerial.setupSerialConnection({
        requestAccessOnPageLoad: false,
        requestElement: "connect-button"
      });

      function updateResetEnabled() {
        const btn = $("reset-button");
        if (!btn) return;
        let isOpen = false;
        try {
          if (typeof connection.isOpen === "function") {
            isOpen = connection.isOpen();
          } else if ("port" in connection) {
            isOpen = !!connection.port;
          }
        } catch (e) {
          isOpen = false;
        }
        btn.disabled = !isOpen;
      }

      // Status handler
      connection.on("status", (modbus) => {
        $("live-address").textContent = modbus?.address ?? "--";
        $("live-baud").textContent = modbus?.baud ?? "--";
        if (modbus.address) $("modbus-address").value = modbus.address;
        if (modbus.baud) $("modbus-baud").value = modbus.baud;
        updateResetEnabled();
      });

      connection.on("open", () => {
        updateResetEnabled();
      });
      connection.on("close", updateResetEnabled);
      connection.on("message", (msg) => appendLog("AIO-422-R1", msg));

      // Modbus config update
      $("modbus-address").addEventListener("input", updateModbus);
      $("modbus-baud").addEventListener("input", updateModbus);

      async function updateModbus() {
        await connection.send("values", {
          mb_address: parseInt($("modbus-address").value, 10),
          mb_baud: parseInt($("modbus-baud").value, 10)
        });
      }

      async function doReset() {
        try {
          await connection.send("command", { action: "reset" });
          appendLog("System", "Reset command sent");
          $("reset-button").disabled = true;
          setTimeout(updateResetEnabled, 3000);
        } catch (err) {
          appendLog("Error", err.message || err);
        }
      }

      (function setupResetButton() {
        const resetBtn = $("reset-button");
        if (!resetBtn) return;
        resetBtn.addEventListener("click", () => {
          if (resetBtn.disabled) {
            appendLog("System", "Connect to the device before resetting.");
            return;
          }
          if (confirm("Are you sure you want to reset the module?")) {
            doReset();
          }
        });
      })();

      // Build Analog Input cards
      (function buildAICards() {
        const container = $("ai-cards");
        if (!container) return;
        for (let i = 0; i < NUM_AI; i++) {
          const card = document.createElement("div");
          card.innerHTML = `
            <div style="border:1px solid #ccc;border-radius:6px;background:#e6f7e8;padding:1rem;">
              <div style="display:flex;justify-content:space-between;font-weight:600;">
                AI${i + 1}
                <span id="ai-dot-${i}"
                      style="width:10px;height:10px;border-radius:50%;background:#ccc;display:inline-block;"></span>
              </div>
              <div style="margin-top:.5rem;font-size:.9rem;">
                Raw mV: <span id="ai-raw-${i}">--</span><br>
                Voltage: <span id="ai-volts-${i}">--</span> V
              </div>
            </div>`;
          container.appendChild(card);
        }
      })();

      // Build DAC cards
      (function buildDacCards() {
        const container = $("dac-cards");
        if (!container) return;
        for (let i = 0; i < NUM_DAC; i++) {
          const card = document.createElement("div");
          card.innerHTML = `
            <div style="border:1px solid #ccc;border-radius:6px;background:#f1f1f1;padding:1rem;">
              <div style="font-weight:600;margin-bottom:.5rem;">
                AO${i + 1}
              </div>
              <input type="range" min="0" max="4095" value="0"
                     id="dac-slider-${i}"
                     style="width:100%;">
              <div style="display:flex;justify-content:space-between;font-size:.9rem;margin-top:.25rem;">
                <span>Raw: <span id="dac-raw-${i}">0</span></span>
                <span>≈ <span id="dac-volts-${i}">0.00</span> V</span>
              </div>
            </div>`;
          container.appendChild(card);
        }
      })();

      // Build RTD cards
      (function buildRtdCards() {
        const container = $("rtd-cards");
        if (!container) return;
        for (let i = 0; i < 2; i++) {
          const card = document.createElement("div");
          card.innerHTML = `
            <div style="border:1px solid #ccc;border-radius:6px;background:#fff3e0;padding:1rem;">
              <div style="font-weight:600;margin-bottom:.5rem;">
                RTD${i + 1}
              </div>
              <div style="font-size:.95rem;">
                Temperature: <span id="rtd-temp-${i}">--</span> °C
              </div>
            </div>`;
          container.appendChild(card);
        }
      })();

      // Build Button cards
      (function buildButtonCards() {
        const container = $("buttons-cards");
        if (!container) return;
        for (let i = 0; i < NUM_BTN; i++) {
          const card = document.createElement("div");
          card.innerHTML = `
            <div style="border:1px solid #ccc;border-radius:6px;background:#cbdcf7;padding:1rem;">
              <div style="font-weight:600;">
                Button ${i + 1}
                <span id="btn-dot-${i}"
                      style="width:12px;height:12px;border-radius:50%;background:#ccc;display:inline-block;float:right;"></span>
              </div>
            </div>`;
          container.appendChild(card);
        }
      })();

      // Build LED cards
      (function buildLedCards() {
        const container = $("leds-cards");
        if (!container) return;
        for (let i = 0; i < NUM_LED; i++) {
          const card = document.createElement("div");
          card.innerHTML = `
            <div style="border:1px solid #ccc;border-radius:6px;background:#f3f5d0;padding:1rem;">
              <div style="font-weight:600;">
                LED ${i + 1}
                <span id="led-dot-${i}"
                      style="width:12px;height:12px;border-radius:50%;background:#ccc;display:inline-block;float:right;"></span>
              </div>
            </div>`;
          container.appendChild(card);
        }
      })();

      function markPidEditing(index, editing) {
        pidEditing[index] = editing;
      }

      // ---------------- PID cards ----------------
      (function buildPidCards() {
        const container = $("pid-cards");
        if (!container) return;

        for (let i = 0; i < NUM_PID; i++) {
          const idx = i + 1;
          const card = document.createElement("div");
          card.innerHTML = `
            <div style="border:1px solid #ccc;border-radius:6px;background:#eef8ff;padding:1rem;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;">
                <span style="font-weight:600;">PID ${idx}</span>
                <div style="font-size:.85rem;">
                  <label for="pid-en-${i}" style="margin-right:4px;">State</label>
                  <select id="pid-en-${i}"
                          style="padding:4px 6px;border-radius:4px;border:1px solid #ccc;">
                    <option value="0">Disabled</option>
                    <option value="1">Enabled</option>
                  </select>
                </div>
              </div>

              <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;">
                <div style="grid-column:span 2;">
                  <label style="font-size:.85rem;">Setpoint SP${idx} (raw)</label>
                  <input type="number" id="pid-sp-${i}"
                         style="width:100%;padding:4px 6px;border-radius:4px;border:1px solid #ccc;"
                         value="0" step="1">
                  <div style="font-size:.75rem;color:#777;margin-top:2px;">
                    Raw units (mV for AI sources, °C×10 for RTD sources).
                  </div>
                </div>

                <div style="grid-column:span 2;">
                  <label style="font-size:.85rem;">PV Source</label>
                  <select id="pid-pv-${i}"
                          style="width:100%;padding:4px 6px;border-radius:4px;border:1px solid #ccc;">
                    <option value="0">None</option>
                    <option value="1">AI1 (mV)</option>
                    <option value="2">AI2 (mV)</option>
                    <option value="3">AI3 (mV)</option>
                    <option value="4">AI4 (mV)</option>
                    <option value="5">RTD1 (°C×10)</option>
                    <option value="6">RTD2 (°C×10)</option>
                  </select>
                </div>

                <div>
                  <label style="font-size:.85rem;">SP Source</label>
                  <select id="pid-spsrc-${i}"
                          style="width:100%;padding:4px 6px;border-radius:4px;border:1px solid #ccc;">
                    <option value="0">Manual SP</option>
                    <option value="1">SP1 (Modbus)</option>
                    <option value="2">SP2 (Modbus)</option>
                    <option value="3">SP3 (Modbus)</option>
                    <option value="4">SP4 (Modbus)</option>
                  </select>
                </div>

                <div>
                  <label style="font-size:.85rem;">Output Target</label>
                  <select id="pid-out-${i}"
                          style="width:100%;padding:4px 6px;border-radius:4px;border:1px solid #ccc;">
                    <option value="0">None</option>
                    <option value="1">AO1</option>
                    <option value="2">AO2</option>
                  </select>
                </div>

                <div>
                  <label style="font-size:.85rem;">Kp</label>
                  <input type="number" id="pid-kp-${i}"
                         style="width:100%;padding:4px 6px;border-radius:4px;border:1px solid:#ccc;"
                         value="0" step="0.01">
                </div>
                <div>
                  <label style="font-size:.85rem;">Ki</label>
                  <input type="number" id="pid-ki-${i}"
                         style="width:100%;padding:4px 6px;border-radius:4px;border:1px solid:#ccc;"
                         value="0" step="0.01">
                </div>
                <div>
                  <label style="font-size:.85rem;">Kd</label>
                  <input type="number" id="pid-kd-${i}"
                         style="width:100%;padding:4px 6px;border-radius:4px;border:1px solid:#ccc;"
                         value="0" step="0.01">
                </div>

                <!-- Scaling block -->
                <div style="grid-column:span 2;border-top:1px dashed #ccc;margin-top:.5rem;padding-top:.5rem;font-size:.8rem;">
                  <div style="font-weight:600;margin-bottom:.25rem;">Scaling (raw → 0–100%)</div>
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:.25rem;">
                    <div>
                      <label style="font-size:.8rem;">PV min</label>
                      <input type="number" id="pid-pvmin-${i}"
                             style="width:100%;padding:3px 5px;border-radius:4px;border:1px solid #ccc;"
                             value="0" step="1">
                    </div>
                    <div>
                      <label style="font-size:.8rem;">PV max</label>
                      <input type="number" id="pid-pvmax-${i}"
                             style="width:100%;padding:3px 5px;border-radius:4px;border:1px solid #ccc;"
                             value="10000" step="1">
                    </div>
                    <div>
                      <label style="font-size:.8rem;">OUT min</label>
                      <input type="number" id="pid-outmin-${i}"
                             style="width:100%;padding:3px 5px;border-radius:4px;border:1px solid #ccc;"
                             value="0" step="1">
                    </div>
                    <div>
                      <label style="font-size:.8rem;">OUT max</label>
                      <input type="number" id="pid-outmax-${i}"
                             style="width:100%;padding:3px 5px;border-radius:4px;border:1px solid #ccc;"
                             value="4095" step="1">
                    </div>
                  </div>
                </div>

                <!-- Internal % display -->
                <div style="grid-column:span 2;margin-top:.25rem;font-size:.8rem;background:#ffffff;border-radius:4px;padding:.4rem .5rem;">
                  <div>
                    PV: <span id="pid-pv-pct-${i}">--</span> % &nbsp; | &nbsp;
                    SP: <span id="pid-sp-pct-${i}">--</span> % &nbsp; | &nbsp;
                    OUT: <span id="pid-out-pct-${i}">--</span> %
                  </div>
                </div>
              </div>
            </div>`;
          container.appendChild(card);
        }

        // wire DOM to buffers and editing lock
        for (let i = 0; i < NUM_PID; i++) {
          const controls = [
            $("pid-en-" + i),
            $("pid-sp-" + i),
            $("pid-pv-" + i),
            $("pid-spsrc-" + i),
            $("pid-out-" + i),
            $("pid-kp-" + i),
            $("pid-ki-" + i),
            $("pid-kd-" + i),
            $("pid-pvmin-" + i),
            $("pid-pvmax-" + i),
            $("pid-outmin-" + i),
            $("pid-outmax-" + i)
          ];

          controls.forEach((el) => {
            if (!el) return;
            el.addEventListener("focus", () => markPidEditing(i, true));
            el.addEventListener("blur", () => {
              markPidEditing(i, false);
              sendPidConfig(); // send updated state after editing
            });
          });

          const enEl     = $("pid-en-" + i);
          const spEl     = $("pid-sp-" + i);
          const pvEl     = $("pid-pv-" + i);
          const spSrcEl  = $("pid-spsrc-" + i);
          const outEl    = $("pid-out-" + i);
          const kpEl     = $("pid-kp-" + i);
          const kiEl     = $("pid-ki-" + i);
          const kdEl     = $("pid-kd-" + i);
          const pvMinEl  = $("pid-pvmin-" + i);
          const pvMaxEl  = $("pid-pvmax-" + i);
          const outMinEl = $("pid-outmin-" + i);
          const outMaxEl = $("pid-outmax-" + i);

          if (enEl)    enEl.addEventListener("change", () => { pidEn[i]     = parseInt(enEl.value, 10) || 0; });
          if (spEl)    spEl.addEventListener("change", () => { pidSp[i]     = parseInt(spEl.value, 10) || 0; });
          if (pvEl)    pvEl.addEventListener("change", () => { pidPvSrc[i]  = parseInt(pvEl.value, 10) || 0; });
          if (spSrcEl) spSrcEl.addEventListener("change", () => { pidSpSrc[i]= parseInt(spSrcEl.value, 10) || 0; });
          if (outEl)   outEl.addEventListener("change", () => { pidOutSel[i]= parseInt(outEl.value, 10) || 0; });
          if (kpEl)    kpEl.addEventListener("change", () => { pidKp[i]     = parseFloat(kpEl.value) || 0; });
          if (kiEl)    kiEl.addEventListener("change", () => { pidKi[i]     = parseFloat(kiEl.value) || 0; });
          if (kdEl)    kdEl.addEventListener("change", () => { pidKd[i]     = parseFloat(kdEl.value) || 0; });

          if (pvMinEl) pvMinEl.addEventListener("change", () => { pidPvMin[i]  = parseFloat(pvMinEl.value)  || 0; });
          if (pvMaxEl) pvMaxEl.addEventListener("change", () => { pidPvMax[i]  = parseFloat(pvMaxEl.value)  || 0; });
          if (outMinEl)outMinEl.addEventListener("change", () => { pidOutMin[i] = parseFloat(outMinEl.value) || 0; });
          if (outMaxEl)outMaxEl.addEventListener("change", () => { pidOutMax[i] = parseFloat(outMaxEl.value) || 0; });
        }

        const applyBtn = $("pid-apply-all");
        if (applyBtn) {
          applyBtn.addEventListener("click", sendPidConfig);
        }
      })();

      // send current PID buffers to controller
      async function sendPidConfig() {
        try {
          const spArr     = [];
          const enArr     = [];
          const pvArr     = [];
          const spSrcArr  = [];
          const outArr    = [];
          const kpArr     = [];
          const kiArr     = [];
          const kdArr     = [];
          const pvMinArr  = [];
          const pvMaxArr  = [];
          const outMinArr = [];
          const outMaxArr = [];

          for (let i = 0; i < NUM_PID; i++) {
            // refresh from DOM just before send
            const enEl     = $("pid-en-" + i);
            const spEl     = $("pid-sp-" + i);
            const pvEl     = $("pid-pv-" + i);
            const spSrcEl  = $("pid-spsrc-" + i);
            const outEl    = $("pid-out-" + i);
            const kpEl     = $("pid-kp-" + i);
            const kiEl     = $("pid-ki-" + i);
            const kdEl     = $("pid-kd-" + i);
            const pvMinEl  = $("pid-pvmin-" + i);
            const pvMaxEl  = $("pid-pvmax-" + i);
            const outMinEl = $("pid-outmin-" + i);
            const outMaxEl = $("pid-outmax-" + i);

            pidEn[i]     = enEl     ? (parseInt(enEl.value, 10) || 0)   : pidEn[i];
            pidSp[i]     = spEl     ? (parseInt(spEl.value, 10) || 0)   : pidSp[i];
            pidPvSrc[i]  = pvEl     ? (parseInt(pvEl.value, 10) || 0)   : pidPvSrc[i];
            pidSpSrc[i]  = spSrcEl  ? (parseInt(spSrcEl.value, 10) || 0): pidSpSrc[i];
            pidOutSel[i] = outEl    ? (parseInt(outEl.value, 10) || 0)  : pidOutSel[i];
            pidKp[i]     = kpEl     ? (parseFloat(kpEl.value) || 0)     : pidKp[i];
            pidKi[i]     = kiEl     ? (parseFloat(kiEl.value) || 0)     : pidKi[i];
            pidKd[i]     = kdEl     ? (parseFloat(kdEl.value) || 0)     : pidKd[i];

            pidPvMin[i]  = pvMinEl  ? (parseFloat(pvMinEl.value) || 0)  : pidPvMin[i];
            pidPvMax[i]  = pvMaxEl  ? (parseFloat(pvMaxEl.value) || 0)  : pidPvMax[i];
            pidOutMin[i] = outMinEl ? (parseFloat(outMinEl.value) || 0) : pidOutMin[i];
            pidOutMax[i] = outMaxEl ? (parseFloat(outMaxEl.value) || 0) : pidOutMax[i];

            spArr.push(pidSp[i]);
            enArr.push(pidEn[i]);
            pvArr.push(pidPvSrc[i]);
            spSrcArr.push(pidSpSrc[i]);
            outArr.push(pidOutSel[i]);
            kpArr.push(Math.round(pidKp[i] * 100));
            kiArr.push(Math.round(pidKi[i] * 100));
            kdArr.push(Math.round(pidKd[i] * 100));

            pvMinArr.push(pidPvMin[i]);
            pvMaxArr.push(pidPvMax[i]);
            outMinArr.push(pidOutMin[i]);
            outMaxArr.push(pidOutMax[i]);
          }

          const payload = {
            sp:      spArr,
            en:      enArr,
            pv:      pvArr,
            sp_src:  spSrcArr,
            out:     outArr,
            kp:      kpArr,
            ki:      kiArr,
            kd:      kdArr,
            pv_min:  pvMinArr,
            pv_max:  pvMaxArr,
            out_min: outMinArr,
            out_max: outMaxArr
          };

          await connection.send("pid", payload);
          appendLog("UI", "PID config sent: " + JSON.stringify(payload));
        } catch (err) {
          appendLog("Error", err.message || err);
        }
      }

      // -------- PID state handler from firmware --------
      connection.on("pidState", (state) => {
        if (!state) return;
        const sp        = toList(state.sp);
        const en        = toList(state.en);
        const pvSel     = toList(state.pv);
        const spSrc     = toList(state.sp_src);
        const outSel    = toList(state.out);
        const kpArr     = toList(state.kp);
        const kiArr     = toList(state.ki);
        const kdArr     = toList(state.kd);
        const pvMinArr  = toList(state.pv_min || []);
        const pvMaxArr  = toList(state.pv_max || []);
        const outMinArr = toList(state.out_min || []);
        const outMaxArr = toList(state.out_max || []);
        const pvPctArr  = toList(state.pv_pct || []);
        const spPctArr  = toList(state.sp_pct || []);
        const outPctArr = toList(state.out_pct || []);

        for (let i = 0; i < NUM_PID; i++) {
          if (pidEditing[i]) continue;  // do not overwrite while editing

          const spVal      = Number(sp[i]       ?? 0);
          const enVal      = Number(en[i]       ?? 0);
          const pvVal      = Number(pvSel[i]    ?? 0);
          const spSrcVal   = Number(spSrc[i]    ?? 0);
          const outVal     = Number(outSel[i]   ?? 0);
          const kpVal      = Number(kpArr[i]    ?? 0) / 100;
          const kiVal      = Number(kiArr[i]    ?? 0) / 100;
          const kdVal      = Number(kdArr[i]    ?? 0) / 100;

          const pvMinVal   = Number(pvMinArr[i] ?? pidPvMin[i]);
          const pvMaxVal   = Number(pvMaxArr[i] ?? pidPvMax[i]);
          const outMinVal  = Number(outMinArr[i]?? pidOutMin[i]);
          const outMaxVal  = Number(outMaxArr[i]?? pidOutMax[i]);

          const pvPctVal   = Number(pvPctArr[i] ?? NaN);
          const spPctVal   = Number(spPctArr[i] ?? NaN);
          const outPctVal  = Number(outPctArr[i]?? NaN);

          pidSp[i]     = spVal;
          pidEn[i]     = enVal;
          pidPvSrc[i]  = pvVal;
          pidSpSrc[i]  = spSrcVal;
          pidOutSel[i] = outVal;
          pidKp[i]     = kpVal;
          pidKi[i]     = kiVal;
          pidKd[i]     = kdVal;

          pidPvMin[i]  = pvMinVal;
          pidPvMax[i]  = pvMaxVal;
          pidOutMin[i] = outMinVal;
          pidOutMax[i] = outMaxVal;

          const enEl      = $("pid-en-" + i);
          const spEl      = $("pid-sp-" + i);
          const pvEl      = $("pid-pv-" + i);
          const spSrcEl   = $("pid-spsrc-" + i);
          const outEl     = $("pid-out-" + i);
          const kpEl      = $("pid-kp-" + i);
          const kiEl      = $("pid-ki-" + i);
          const kdEl      = $("pid-kd-" + i);
          const pvMinEl   = $("pid-pvmin-" + i);
          const pvMaxEl   = $("pid-pvmax-" + i);
          const outMinEl  = $("pid-outmin-" + i);
          const outMaxEl  = $("pid-outmax-" + i);
          const pvPctEl   = $("pid-pv-pct-" + i);
          const spPctEl   = $("pid-sp-pct-" + i);
          const outPctEl  = $("pid-out-pct-" + i);

          if (enEl)     enEl.value    = String(enVal);
          if (spEl)     spEl.value    = String(spVal);
          if (pvEl)     pvEl.value    = String(pvVal);
          if (spSrcEl)  spSrcEl.value = String(spSrcVal);
          if (outEl)    outEl.value   = String(outVal);
          if (kpEl)     kpEl.value    = kpVal.toString();
          if (kiEl)     kiEl.value    = kiVal.toString();
          if (kdEl)     kdEl.value    = kdVal.toString();

          if (pvMinEl)  pvMinEl.value = pvMinVal.toString();
          if (pvMaxEl)  pvMaxEl.value = pvMaxVal.toString();
          if (outMinEl) outMinEl.value= outMinVal.toString();
          if (outMaxEl) outMaxEl.value= outMaxVal.toString();

          if (pvPctEl)  pvPctEl.textContent  = isNaN(pvPctVal)  ? "--" : pvPctVal.toFixed(1);
          if (spPctEl)  spPctEl.textContent  = isNaN(spPctVal)  ? "--" : spPctVal.toFixed(1);
          if (outPctEl) outPctEl.textContent = isNaN(outPctVal) ? "--" : outPctVal.toFixed(1);
        }

        appendLog("FW", "PID state + scaling synced from device");
      });

      // -------- AI handler (millivolt-based) --------
      connection.on("aiValues", (list) => {
        if (!Array.isArray(list) && !(list && typeof list === "object")) return;
        const vals = toList(list);

        vals.forEach((mv, i) => {
          const mvNum = Number(mv);
          const rawSpan = $("ai-raw-" + i);
          const vSpan   = $("ai-volts-" + i);
          const dot     = $("ai-dot-" + i);

          if (rawSpan) rawSpan.textContent = isNaN(mvNum) ? "--" : mvNum.toString();

          const volts = mvNum / 1000;
          if (vSpan && !isNaN(volts)) vSpan.textContent = volts.toFixed(3);

          if (dot) dot.style.background = volts > 0.1 ? "#4caf50" : "#ccc";
        });
      });

      // RTD handler (°C×10 from firmware)
      connection.on("rtdTemps_x10", (list) => {
        if (!Array.isArray(list) && !(list && typeof list === "object")) return;
        const vals = toList(list);
        vals.forEach((t10, i) => {
          const span = $("rtd-temp-" + i);
          const val = Number(t10);
          if (!span) return;
          span.textContent = isNaN(val) ? "--" : (val / 10).toFixed(1);
        });
      });

      // DAC handler
      connection.on("dacValues", (list) => {
        if (!Array.isArray(list) && !(list && typeof list === "object")) return;
        const vals = toList(list);
        vals.forEach((v, i) => {
          const val = Number(v) || 0;
          dacValues[i] = val;
          const slider = $("dac-slider-" + i);
          const rawEl  = $("dac-raw-" + i);
          const vEl    = $("dac-volts-" + i);
          if (slider) slider.value = val;
          if (rawEl)  rawEl.textContent = val;
          if (vEl)    vEl.textContent = (val / 4095 * 10).toFixed(2);
        });
      });

      // Button and LED handlers
      connection.on("ButtonStateList", (list) => {
        if (!Array.isArray(list) && !(list && typeof list === "object")) return;
        const vals = toList(list);
        vals.forEach((v, i) => {
          const dot = $("btn-dot-" + i);
          if (dot) dot.style.background = v ? "#4caf50" : "#ccc";
        });
      });

      connection.on("LedStateList", (list) => {
        if (!Array.isArray(list) && !(list && typeof list === "object")) return;
        const vals = toList(list);
        vals.forEach((v, i) => {
          const dot = $("led-dot-" + i);
          if (dot) dot.style.background = v ? "#ffb300" : "#ccc";
        });
      });

      // DAC slider → send
      for (let i = 0; i < NUM_DAC; i++) {
        const slider = $("dac-slider-" + i);
        if (!slider) continue;

        slider.addEventListener("input", () => {
          const val = Number(slider.value);
          dacValues[i] = val;
          const rawEl = $("dac-raw-" + i);
          const vEl   = $("dac-volts-" + i);
          if (rawEl) rawEl.textContent = val;
          if (vEl) vEl.textContent = (val / 4095 * 10).toFixed(2);
        });

        slider.addEventListener("change", async () => {
          await connection.send("dac", { list: dacValues });
          appendLog("UI", "DAC update: " + JSON.stringify(dacValues));
        });
      }
    })();
  </script>
</section>
