<section style="font-family:'Segoe UI',sans-serif;padding:2rem;max-width:960px;margin:auto;">
  <div style="text-align:center;margin-bottom:2rem;">
    <img src="https://www.home-master.eu/web/image/product.image/14/image_1024/Untitled-2.webp?unique=1d6564f"
         alt="AIO-422-R1" style="max-width:300px;border-radius:8px;" loading="lazy">
    <h2>AIO-422-R1 Module Configuration</h2>
    <p>
      Configure Modbus address, baud rate, and monitor
      <strong>analog inputs (4)</strong>, <strong>analog outputs (2)</strong>,
      <strong>RTD inputs (2)</strong>, <strong>buttons (4)</strong> and
      <strong>user LEDs (4)</strong> via Web Serial.
    </p>
  </div>

  <!-- Active Modbus status -->
  <div style="background:#f1f1f1;padding:1rem 1.5rem;margin-bottom:2rem;border-radius:6px;border-left:4px solid #007bff;">
    <strong>Active Modbus Configuration</strong><br>
    Address: <span id="live-address" style="font-weight:600;">--</span> |
    Baud Rate: <span id="live-baud" style="font-weight:600;">--</span>
  </div>

  <!-- Modbus config + connect -->
  <form id="modbus-config"
        style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:2rem;">
    <div>
      <label for="modbus-address"><strong>Modbus Address</strong></label>
      <select id="modbus-address" style="width:100%;padding:10px;border-radius:4px;"></select>
    </div>
    <div>
      <label for="modbus-baud"><strong>Baud Rate</strong></label>
      <select id="modbus-baud" style="width:100%;padding:10px;border-radius:4px;">
        <option>9600</option>
        <option selected>19200</option>
        <option>38400</option>
        <option>57600</option>
        <option>115200</option>
      </select>
    </div>
    <div style="grid-column:span 2;text-align:right;">
      <button id="connect-button" type="button"
              style="padding:10px 20px;background:#007bff;color:#fff;border:none;border-radius:4px;">
        Connect
      </button>
      <button id="reset-button" type="button"
              style="padding:10px 20px;background:#dc3545;color:#fff;border:none;border-radius:4px;margin-left:0.75rem;"
              disabled>
        Reset Device
      </button>
    </div>
  </form>

  <!-- Reset dialog -->
  <dialog id="reset-dialog"
          style="border:none;border-radius:10px;padding:0;max-width:420px;width:90%;box-shadow:0 10px 30px rgba(0,0,0,.2);">
    <form id="reset-form" method="dialog" style="padding:1rem 1.25rem;">
      <h3 style="margin:.25rem 0 .5rem;">Confirm reset</h3>
      <p style="margin:.25rem 0 1rem;color:#444;">
        Are you sure you want to reset the module? The serial connection will be temporarily interrupted.
      </p>
      <div style="display:flex;justify-content:flex-end;gap:.5rem;">
        <button id="dlg-cancel" value="cancel"
                style="padding:.5rem .9rem;border-radius:6px;border:1px solid #ccc;background:#fff;">
          Cancel
        </button>
        <button id="dlg-confirm" value="confirm"
                style="padding:.5rem .9rem;border:none;border-radius:6px;background:#dc3545;color:#fff;">
          Reset
        </button>
      </div>
    </form>
  </dialog>

  <!-- Serial log -->
  <div id="log-line"
       style="margin-bottom:1.5rem;padding:1rem;background:#f9f9f9;border:1px solid #ccc;border-radius:6px;font-size:0.9rem;color:#333;font-family:monospace;">
    <strong>Serial Log:</strong>
    <div id="log-content" style="white-space:pre-wrap;"></div>
  </div>

  <!-- Live sections -->
  <section>
    <h2 style="font-size:1.2rem;">Analog Inputs (4 × 0–10&nbsp;V)</h2>
    <p style="margin-top:-.25rem;color:#555;font-size:.9rem;">
      Firmware reports field voltage in millivolts (0–10000&nbsp;mV). Voltage is calculated directly.
    </p>
    <div id="ai-cards"
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;"></div>
  </section>

  <section style="margin-top:2rem;">
    <h2 style="font-size:1.2rem;">Analog Outputs (2 × 0–10&nbsp;V)</h2>
    <p style="margin-top:-.25rem;color:#555;font-size:.9rem;">
      DAC raw value is 0..4095 (MCP4725). 4095 ≈ 10&nbsp;V at the terminal.
    </p>
    <div id="dac-cards"
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;"></div>
  </section>

  <section style="margin-top:2rem;">
    <h2 style="font-size:1.2rem;">RTD Inputs (2 × PT100)</h2>
    <div id="rtd-cards"
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;"></div>
  </section>

  <section style="margin-top:2rem;">
    <h2 style="font-size:1.2rem;">Buttons (4)</h2>
    <p style="margin-top:-.25rem;color:#555;font-size:.9rem;">
      Button states are read directly from the device.
    </p>
    <div id="buttons-cards"
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;"></div>
  </section>

  <section style="margin-top:2rem;">
    <h2 style="font-size:1.2rem;">User LEDs (4)</h2>
    <div id="leds-cards"
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;"></div>
  </section>

  <!-- Scripts -->
  <script src="https://unpkg.com/simple-web-serial@latest/dist/simple-web-serial.min.js"></script>
  <script>
    (function () {
      const NUM_AI = 4, NUM_DAC = 2, NUM_BTN = 4, NUM_LED = 4;
      const LOG_MAX = 4;
      const logBuffer = [];
      const $ = (id) => document.getElementById(id);

      const dacValues = [0, 0];

      function appendLog(label, data) {
        const logEl = $("log-content");
        if (!logEl) return;
        const time = new Date().toLocaleTimeString();
        const line = `[${time}] ${label}: ` + (typeof data === "string" ? data : JSON.stringify(data));
        logBuffer.unshift(line);
        if (logBuffer.length > LOG_MAX) logBuffer.pop();
        logEl.textContent = logBuffer.join("\n");
      }

      // Populate Modbus addresses
      (function populateAddresses() {
        const addrSelect = $("modbus-address");
        if (!addrSelect) return;
        for (let i = 1; i <= 255; i++) {
          const opt = document.createElement("option");
          opt.value = i;
          opt.textContent = i;
          if (i === 3) opt.selected = true;
          addrSelect.appendChild(opt);
        }
      })();

      // WebSerial setup
      const connection = SimpleWebSerial.setupSerialConnection({
        requestAccessOnPageLoad: false,
        requestElement: "connect-button"
      });

      // <<< MODIFIED: make this robust even if isOpen() is missing >>>
      function updateResetEnabled() {
        const btn = $("reset-button");
        if (!btn) return;
        let isOpen = false;
        try {
          if (typeof connection.isOpen === "function") {
            isOpen = connection.isOpen();
          } else if ("port" in connection) {
            isOpen = !!connection.port;
          }
        } catch (e) {
          isOpen = false;
        }
        btn.disabled = !isOpen;
      }

      // Status handler
      connection.on("status", (modbus) => {
        $("live-address").textContent = modbus?.address ?? "--";
        $("live-baud").textContent = modbus?.baud ?? "--";
        if (modbus.address) $("modbus-address").value = modbus.address;
        if (modbus.baud) $("modbus-baud").value = modbus.baud;
        updateResetEnabled();
      });

      connection.on("open", updateResetEnabled);
      connection.on("close", updateResetEnabled);
      connection.on("message", (msg) => appendLog("AIO-422-R1", msg));

      // Modbus config update
      $("modbus-address").addEventListener("input", updateModbus);
      $("modbus-baud").addEventListener("input", updateModbus);

      async function updateModbus() {
        await connection.send("values", {
          mb_address: parseInt($("modbus-address").value),
          mb_baud: parseInt($("modbus-baud").value)
        });
      }

      async function doReset() {
        try {
          await connection.send("command", { action: "reset" });
          appendLog("System", "Reset command sent");
          $("reset-button").disabled = true;
          setTimeout(updateResetEnabled, 3000);
        } catch (err) {
          appendLog("Error", err.message || err);
        }
      }

      // <<< ADDED: simple confirm handler for reset button >>>
      (function setupResetButton() {
        const resetBtn = $("reset-button");
        if (!resetBtn) return;
        resetBtn.addEventListener("click", () => {
          if (resetBtn.disabled) {
            appendLog("System", "Connect to the device before resetting.");
            return;
          }
          if (confirm("Are you sure you want to reset the module?")) {
            doReset();
          }
        });
      })();

      // Build Analog Input cards
      (function buildAICards() {
        const container = $("ai-cards");
        for (let i = 0; i < NUM_AI; i++) {
          const card = document.createElement("div");
          card.innerHTML = `
            <div style="border:1px solid #ccc;border-radius:6px;background:#e6f7e8;padding:1rem;">
              <div style="display:flex;justify-content:space-between;font-weight:600;">
                AI${i}
                <span id="ai-dot-${i}"
                      style="width:10px;height:10px;border-radius:50%;background:#ccc;display:inline-block;"></span>
              </div>
              <div style="margin-top:.5rem;font-size:.9rem;">
                Raw: <span id="ai-raw-${i}">--</span><br>
                Voltage: <span id="ai-volts-${i}">--</span> V
              </div>
            </div>`;
          container.appendChild(card);
        }
      })();

      // <<< ADDED: build DAC, RTD, Button, LED cards >>>
      (function buildDacCards() {
        const container = $("dac-cards");
        if (!container) return;
        for (let i = 0; i < NUM_DAC; i++) {
          const card = document.createElement("div");
          card.innerHTML = `
            <div style="border:1px solid #ccc;border-radius:6px;background:#f1f1f1;padding:1rem;">
              <div style="font-weight:600;margin-bottom:.5rem;">
                AO${i}
              </div>
              <input type="range" min="0" max="4095" value="0"
                     id="dac-slider-${i}"
                     style="width:100%;">
              <div style="display:flex;justify-content:space-between;font-size:.9rem;margin-top:.25rem;">
                <span>Raw: <span id="dac-raw-${i}">0</span></span>
                <span>≈ <span id="dac-volts-${i}">0.00</span> V</span>
              </div>
            </div>`;
          container.appendChild(card);
        }
      })();

      (function buildRtdCards() {
        const container = $("rtd-cards");
        if (!container) return;
        for (let i = 0; i < 2; i++) {
          const card = document.createElement("div");
          card.innerHTML = `
            <div style="border:1px solid #ccc;border-radius:6px;background:#fff3e0;padding:1rem;">
              <div style="font-weight:600;margin-bottom:.5rem;">
                RTD${i + 1}
              </div>
              <div style="font-size:.95rem;">
                Temperature: <span id="rtd-temp-${i}">--</span> °C
              </div>
            </div>`;
          container.appendChild(card);
        }
      })();

      (function buildButtonCards() {
        const container = $("buttons-cards");
        if (!container) return;
        for (let i = 0; i < NUM_BTN; i++) {
          const card = document.createElement("div");
          card.innerHTML = `
            <div style="border:1px solid #ccc;border-radius:6px;background:#cbdcf7;padding:1rem;">
              <div style="font-weight:600;">
                Button ${i + 1}
                <span id="btn-dot-${i}"
                      style="width:12px;height:12px;border-radius:50%;background:#ccc;display:inline-block;float:right;"></span>
              </div>
            </div>`;
          container.appendChild(card);
        }
      })();

      (function buildLedCards() {
        const container = $("leds-cards");
        if (!container) return;
        for (let i = 0; i < NUM_LED; i++) {
          const card = document.createElement("div");
          card.innerHTML = `
            <div style="border:1px solid #ccc;border-radius:6px;background:#f3f5d0;padding:1rem;">
              <div style="font-weight:600;">
                LED ${i + 1}
                <span id="led-dot-${i}"
                      style="width:12px;height:12px;border-radius:50%;background:#ccc;display:inline-block;float:right;"></span>
              </div>
            </div>`;
          container.appendChild(card);
        }
      })();
      // <<< END of added builders >>>

      // -------- AI handler (millivolt-based) --------
      connection.on("aiValues", (list) => {
        if (!Array.isArray(list)) return;

        list.forEach((mv, i) => {
          const mvNum = Number(mv);

          const rawSpan = $("ai-raw-" + i);
          const vSpan = $("ai-volts-" + i);
          const dot = $("ai-dot-" + i);

          if (rawSpan) rawSpan.textContent = isNaN(mvNum) ? "--" : mvNum + " mV";

          const volts = mvNum / 1000;
          if (vSpan && !isNaN(volts)) vSpan.textContent = volts.toFixed(3);

          if (dot) dot.style.background = volts > 0.1 ? "#4caf50" : "#ccc";
        });
      });

      // RTD handler
      connection.on("rtdTemps_x10", (list) => {
        if (!Array.isArray(list)) return;
        list.forEach((t10, i) => {
          const span = $("rtd-temp-"+i);
          const val = Number(t10);
          if (!span) return;
          span.textContent = isNaN(val) ? "--" : (val/10).toFixed(1);
        });
      });

      // DAC handler
      connection.on("dacValues", (list) => {
        if (!Array.isArray(list)) return;
        list.forEach((v,i)=>{
          const val = Number(v)||0;
          dacValues[i] = val;
          const slider = $("dac-slider-"+i);
          const rawEl  = $("dac-raw-"+i);
          const vEl    = $("dac-volts-"+i);
          if (slider) slider.value = val;
          if (rawEl) rawEl.textContent = val;
          if (vEl) vEl.textContent = (val/4095*10).toFixed(2);
        });
      });

      // Button and LED handlers
      connection.on("ButtonStateList", (list) => {
        if (!Array.isArray(list)) return;
        list.forEach((v,i)=>{
          const dot = $("btn-dot-"+i);
          if (dot) dot.style.background = v ? "#4caf50" : "#ccc";
        });
      });

      connection.on("LedStateList", (list) => {
        if (!Array.isArray(list)) return;
        list.forEach((v,i)=>{
          const dot = $("led-dot-"+i);
          if (dot) dot.style.background = v ? "#ffb300" : "#ccc";
        });
      });

      // DAC slider → send
      for (let i=0;i<NUM_DAC;i++) {
        const slider = $("dac-slider-"+i);
        if (!slider) continue;
        slider.addEventListener("input", ()=>{
          const val = Number(slider.value);
          dacValues[i] = val;
          const rawEl = $("dac-raw-"+i);
          const vEl   = $("dac-volts-"+i);
          if (rawEl) rawEl.textContent = val;
          if (vEl) vEl.textContent = (val/4095*10).toFixed(2);
        });

        slider.addEventListener("change", async ()=>{
          await connection.send("dac", { list: dacValues });
          appendLog("UI", "DAC update: "+JSON.stringify(dacValues));
        });
      }
    })();
  </script>
</section>
