<section style="font-family:'Segoe UI',sans-serif;padding:2rem;max-width:960px;margin:auto;">
  <div style="text-align:center;margin-bottom:2rem;">
    <img src="https://www.home-master.eu/web/image/product.image/14/image_1024/Untitled-2.webp?unique=1d6564f"
         alt="AIO-422-R1" style="max-width:300px;border-radius:8px;" loading="lazy">
    <h2>AIO-422-R1 Module Configuration</h2>
    <p>
      Configure Modbus address, baud rate, and monitor
      <strong>analog inputs (4)</strong>, <strong>analog outputs (2)</strong>,
      <strong>RTD inputs (2)</strong>, <strong>buttons (4)</strong>,
      <strong>user LEDs (4)</strong>, and <strong>4× PID controllers</strong>
      via Web Serial.
    </p>
  </div>

  <!-- Active Modbus status -->
  <div style="background:#f1f1f1;padding:1rem 1.5rem;margin-bottom:2rem;border-radius:6px;border-left:4px solid #007bff;">
    <strong>Active Modbus Configuration</strong><br>
    Address: <span id="live-address" style="font-weight:600;">--</span> |
    Baud Rate: <span id="live-baud" style="font-weight:600;">--</span>
  </div>

  <!-- Modbus config + connect -->
  <form id="modbus-config"
        style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:2rem;">
    <div>
      <label for="modbus-address"><strong>Modbus Address</strong></label>
      <select id="modbus-address" style="width:100%;padding:10px;border-radius:4px;"></select>
    </div>
    <div>
      <label for="modbus-baud"><strong>Baud Rate</strong></label>
      <select id="modbus-baud" style="width:100%;padding:10px;border-radius:4px;">
        <option>9600</option>
        <option selected>19200</option>
        <option>38400</option>
        <option>57600</option>
        <option>115200</option>
      </select>
    </div>
    <div style="grid-column:span 2;text-align:right;">
      <button id="connect-button" type="button"
              style="padding:10px 20px;background:#007bff;color:#fff;border:none;border-radius:4px;">
        Connect
      </button>
      <button id="reset-button" type="button"
              style="padding:10px 20px;background:#dc3545;color:#fff;border:none;border-radius:4px;margin-left:0.75rem;"
              disabled>
        Reset Device
      </button>
    </div>
  </form>

  <!-- Serial log -->
  <div id="log-line"
       style="margin-bottom:1.5rem;padding:1rem;background:#f9f9f9;border:1px solid #ccc;border-radius:6px;font-size:0.9rem;color:#333;font-family:monospace;">
    <strong>Serial Log:</strong>
    <div id="log-content" style="white-space:pre-wrap;"></div>
  </div>

  <!-- Live sections -->
  <section>
    <h2 style="font-size:1.2rem;">Analog Inputs (4 × 0–10&nbsp;V)</h2>
    <p style="margin-top:-.25rem;color:#555;font-size:.9rem;">
      Firmware reports field voltage in millivolts (0–10000&nbsp;mV). Voltage is calculated directly.
    </p>
    <div id="ai-cards"
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;"></div>
  </section>

  <section style="margin-top:2rem;">
    <h2 style="font-size:1.2rem;">Analog Outputs (2 × 0–10&nbsp;V)</h2>
    <p style="margin-top:-.25rem;color:#555;font-size:.9rem;">
      DAC raw value is 0..4095 (MCP4725). 4095 ≈ 10&nbsp;V at the terminal.
    </p>
    <div id="dac-cards"
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;"></div>
  </section>

  <section style="margin-top:2rem;">
    <h2 style="font-size:1.2rem;">RTD Inputs (2 × PT100)</h2>
    <div id="rtd-cards"
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;"></div>
  </section>

  <section style="margin-top:2rem;">
    <h2 style="font-size:1.2rem;">Buttons (4)</h2>
    <p style="margin-top:-.25rem;color:#555;font-size:.9rem;">
      Button states are read directly from the device. Button action is <strong>Web-only</strong> (saved in flash).
    </p>
    <div id="buttons-cards"
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;"></div>
  </section>

  <section style="margin-top:2rem;">
    <h2 style="font-size:1.2rem;">User LEDs (4)</h2>
    <p style="margin-top:-.25rem;color:#555;font-size:.9rem;">
      Each LED can be <strong>manual</strong> (toggled by the button) or <strong>driven by a source</strong>
      (PID enabled / PID OUT 0% / PID OUT 100% / AO 0% / AO 100%).
    </p>
    <div id="leds-cards"
         style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1rem;"></div>
  </section>

  <!-- PID Controllers (4 rows: left settings, right trend) -->
  <section style="margin-top:2rem;">
    <h2 style="font-size:1.2rem;">PID Controllers (4)</h2>
    <p style="margin-top:-.25rem;color:#555;font-size:.9rem;">
      Trend is <strong>live only</strong> (no storage): PV/SP/OUT plotted in <strong>%</strong>.
      % scaling comes from your controller using PV min/max and OUT min/max (raw → 0–100%).
    </p>

    <div id="pid-rows" style="display:flex;flex-direction:column;gap:1rem;margin-bottom:.75rem;"></div>

    <div style="text-align:right;">
      <button id="pid-apply-all" type="button"
              style="padding:8px 16px;background:#28a745;color:#fff;border:none;border-radius:4px;">
        Apply PID Configuration
      </button>
    </div>
  </section>

  <!-- Scripts -->
  <script src="https://unpkg.com/simple-web-serial@latest/dist/simple-web-serial.min.js"></script>
  <script>
    (function () {
      const NUM_AI  = 4;
      const NUM_DAC = 2;
      const NUM_BTN = 4;
      const NUM_LED = 4;
      const NUM_PID = 4;

      const LOG_MAX = 4;
      const logBuffer = [];
      const $ = (id) => document.getElementById(id);

      const dacValues = [0, 0];

      // ===== Button action selection (0..6) =====
      // 0 = Manual LED toggle (legacy) (only if LED source is Manual for same index)
      // 1..4 = Toggle PID1..PID4 enable
      // 5 = Toggle AO1+AO2 to 0     (toggle 0 <-> 4095)
      // 6 = Toggle AO1+AO2 to 4095  (toggle 4095 <-> 0)
      const btnAction  = [0,0,0,0];
      const btnEditing = [false,false,false,false];

      // LED source selection buffers (0..16)
      // 0=Manual, 1..4=PID enabled, 5..8=PID out 0%, 9..12=PID out 100%, 13..16=AO thresholds
      const ledSrc = [0,0,0,0];
      const ledEditing = [false,false,false,false];

      // PID config buffers
      const pidSp     = [0, 0, 0, 0];  // SP raw
      const pidEn     = [0, 0, 0, 0];  // 0/1
      const pidPvSrc  = [0, 0, 0, 0];  // 0,1..4,5,6
      const pidSpSrc  = [0, 0, 0, 0];  // 0..8 (includes PID OUT 5..8)
      const pidOutSel = [0, 0, 0, 0];  // 0..2
      const pidKp     = [0, 0, 0, 0];  // real gains
      const pidKi     = [0, 0, 0, 0];
      const pidKd     = [0, 0, 0, 0];

      // Scaling buffers (RAW units)
      const pidPvMin  = [0, 0, 0, 0];
      const pidPvMax  = [10000, 10000, 10000, 10000];
      const pidOutMin = [0, 0, 0, 0];
      const pidOutMax = [4095, 4095, 4095, 4095];

      // Direct/Reverse mode (0=Direct, 1=Reverse)
      const pidMode   = [0, 0, 0, 0];

      // per-PID editing lock
      const pidEditing = [false, false, false, false];

      // --- Trend buffers ---
      const EXPECTED_SAMPLE_MS = 250;
      const trend = Array.from({length: NUM_PID}, () => ({
        winMin: 10,
        maxPoints: Math.floor((10 * 60 * 1000) / EXPECTED_SAMPLE_MS),
        t: [],
        pv: [],
        sp: [],
        out: [],
        lastDrawMs: 0
      }));

      function setTrendWindow(i, minutes) {
        const tr = trend[i];
        tr.winMin = minutes;
        tr.maxPoints = Math.max(10, Math.floor((minutes * 60 * 1000) / EXPECTED_SAMPLE_MS));
        tr.t.length = 0; tr.pv.length = 0; tr.sp.length = 0; tr.out.length = 0;
        drawTrend(i, true);
      }

      function pushTrend(i, pvPct, spPct, outPct) {
        const tr = trend[i];
        const now = Date.now();
        tr.t.push(now);
        tr.pv.push(pvPct);
        tr.sp.push(spPct);
        tr.out.push(outPct);

        while (tr.t.length > tr.maxPoints) {
          tr.t.shift(); tr.pv.shift(); tr.sp.shift(); tr.out.shift();
        }

        const cutoff = now - tr.winMin * 60 * 1000;
        while (tr.t.length && tr.t[0] < cutoff) {
          tr.t.shift(); tr.pv.shift(); tr.sp.shift(); tr.out.shift();
        }
      }

      const toList = (v) => {
        if (Array.isArray(v)) return v;
        if (v && typeof v === "object") {
          return Object.keys(v).sort((a,b)=>Number(a)-Number(b)).map(k => v[k]);
        }
        return [];
      };

      function appendLog(label, data) {
        const logEl = $("log-content");
        if (!logEl) return;
        const time = new Date().toLocaleTimeString();
        const line = `[${time}] ${label}: ` + (typeof data === "string" ? data : JSON.stringify(data));
        logBuffer.unshift(line);
        if (logBuffer.length > LOG_MAX) logBuffer.pop();
        logEl.textContent = logBuffer.join("\n");
      }

      // Populate Modbus addresses 1..255
      (function populateAddresses() {
        const addrSelect = $("modbus-address");
        if (!addrSelect) return;
        for (let i = 1; i <= 255; i++) {
          const opt = document.createElement("option");
          opt.value = i;
          opt.textContent = i;
          if (i === 3) opt.selected = true;
          addrSelect.appendChild(opt);
        }
      })();

      // WebSerial setup
      const connection = SimpleWebSerial.setupSerialConnection({
        requestAccessOnPageLoad: false,
        requestElement: "connect-button"
      });

      function updateResetEnabled() {
        const btn = $("reset-button");
        if (!btn) return;
        let isOpen = false;
        try {
          if (typeof connection.isOpen === "function") {
            isOpen = connection.isOpen();
          } else if ("port" in connection) {
            isOpen = !!connection.port;
          }
        } catch (e) { isOpen = false; }
        btn.disabled = !isOpen;
      }

      // Status handler
      connection.on("status", (modbus) => {
        $("live-address").textContent = modbus?.address ?? "--";
        $("live-baud").textContent = modbus?.baud ?? "--";
        if (modbus.address) $("modbus-address").value = modbus.address;
        if (modbus.baud) $("modbus-baud").value = modbus.baud;
        updateResetEnabled();
      });

      connection.on("open", () => { updateResetEnabled(); });
      connection.on("close", updateResetEnabled);
      connection.on("message", (msg) => appendLog("AIO-422-R1", msg));

      // Modbus config update
      $("modbus-address").addEventListener("input", updateModbus);
      $("modbus-baud").addEventListener("input", updateModbus);

      async function updateModbus() {
        await connection.send("values", {
          mb_address: parseInt($("modbus-address").value, 10),
          mb_baud: parseInt($("modbus-baud").value, 10)
        });
      }

      async function doReset() {
        try {
          await connection.send("command", { action: "reset" });
          appendLog("System", "Reset command sent");
          $("reset-button").disabled = true;
          setTimeout(updateResetEnabled, 3000);
        } catch (err) {
          appendLog("Error", err.message || err);
        }
      }

      (function setupResetButton() {
        const resetBtn = $("reset-button");
        if (!resetBtn) return;
        resetBtn.addEventListener("click", () => {
          if (resetBtn.disabled) {
            appendLog("System", "Connect to the device before resetting.");
            return;
          }
          if (confirm("Are you sure you want to reset the module?")) doReset();
        });
      })();

      // Build Analog Input cards
      (function buildAICards() {
        const container = $("ai-cards");
        if (!container) return;
        for (let i = 0; i < NUM_AI; i++) {
          const card = document.createElement("div");
          card.innerHTML = `
            <div style="border:1px solid #ccc;border-radius:6px;background:#e6f7e8;padding:1rem;">
              <div style="display:flex;justify-content:space-between;font-weight:600;">
                AI${i + 1}
                <span id="ai-dot-${i}"
                      style="width:10px;height:10px;border-radius:50%;background:#ccc;display:inline-block;"></span>
              </div>
              <div style="margin-top:.5rem;font-size:.9rem;">
                Raw mV: <span id="ai-raw-${i}">--</span><br>
                Voltage: <span id="ai-volts-${i}">--</span> V
              </div>
            </div>`;
          container.appendChild(card);
        }
      })();

      // Build DAC cards
      (function buildDacCards() {
        const container = $("dac-cards");
        if (!container) return;
        for (let i = 0; i < NUM_DAC; i++) {
          const card = document.createElement("div");
          card.innerHTML = `
            <div style="border:1px solid #ccc;border-radius:6px;background:#f1f1f1;padding:1rem;">
              <div style="font-weight:600;margin-bottom:.5rem;">AO${i + 1}</div>
              <input type="range" min="0" max="4095" value="0" id="dac-slider-${i}" style="width:100%;">
              <div style="display:flex;justify-content:space-between;font-size:.9rem;margin-top:.25rem;">
                <span>Raw: <span id="dac-raw-${i}">0</span></span>
                <span>≈ <span id="dac-volts-${i}">0.00</span> V</span>
              </div>
            </div>`;
          container.appendChild(card);
        }
      })();

      // Build RTD cards
      (function buildRtdCards() {
        const container = $("rtd-cards");
        if (!container) return;
        for (let i = 0; i < 2; i++) {
          const card = document.createElement("div");
          card.innerHTML = `
            <div style="border:1px solid #ccc;border-radius:6px;background:#fff3e0;padding:1rem;">
              <div style="font-weight:600;margin-bottom:.5rem;">RTD${i + 1}</div>
              <div style="font-size:.95rem;">
                Temperature: <span id="rtd-temp-${i}">--</span> °C
              </div>
            </div>`;
          container.appendChild(card);
        }
      })();

      // ===== Button actions (FULL) =====
      function markBtnEditing(i, editing) { btnEditing[i] = editing; }

      async function sendBtnCfg() {
        try {
          await connection.send("btnCfg", { action: btnAction });
          appendLog("UI", "Button actions sent: " + JSON.stringify(btnAction));
        } catch (err) {
          appendLog("Error", err.message || err);
        }
      }

      // Firmware sends this on boot + periodically (as in the firmware I sent you)
      connection.on("ButtonActionList", (list) => {
        const vals = toList(list);
        if (!vals.length) return;
        for (let i=0;i<NUM_BTN;i++) {
          const v = Number(vals[i] ?? btnAction[i]) || 0;
          btnAction[i] = Math.max(0, Math.min(6, v));
          const sel = $("btn-act-" + i);
          if (sel && !btnEditing[i]) sel.value = String(btnAction[i]);
        }
      });

      // Optional: if firmware ever echoes "btnCfg"
      connection.on("btnCfg", (data) => {
        const vals = toList(data?.action || []);
        if (!vals.length) return;
        for (let i=0;i<NUM_BTN;i++) {
          const v = Number(vals[i] ?? btnAction[i]) || 0;
          btnAction[i] = Math.max(0, Math.min(6, v));
          const sel = $("btn-act-" + i);
          if (sel && !btnEditing[i]) sel.value = String(btnAction[i]);
        }
      });

      // Build Button cards (with action select)
      (function buildButtonCards() {
        const container = $("buttons-cards");
        if (!container) return;

        const options = [
          [0, "Manual LED toggle (legacy)"],
          [1, "Toggle PID1 enable"],
          [2, "Toggle PID2 enable"],
          [3, "Toggle PID3 enable"],
          [4, "Toggle PID4 enable"],
          [5, "Toggle AO1 to 0%-100%"],
          [6, "Toggle AO2 to 0%-100"],
        ];

        for (let i = 0; i < NUM_BTN; i++) {
          const card = document.createElement("div");
          const optHtml = options.map(([v,t]) => `<option value="${v}">${t}</option>`).join("");

          card.innerHTML = `
            <div style="border:1px solid #ccc;border-radius:6px;background:#cbdcf7;padding:1rem;">
              <div style="font-weight:600;display:flex;justify-content:space-between;align-items:center;">
                <span>Button ${i + 1}</span>
                <span id="btn-dot-${i}"
                      style="width:12px;height:12px;border-radius:50%;background:#ccc;display:inline-block;"></span>
              </div>

              <div style="margin-top:.7rem;">
                <label style="font-size:.85rem;">Action</label>
                <select id="btn-act-${i}"
                        style="width:100%;padding:6px;border-radius:4px;border:1px solid #ccc;">
                  ${optHtml}
                </select>
                <div style="font-size:.75rem;color:#567;margin-top:4px;line-height:1.2;">
                  Runs on button <strong>push</strong> (rising edge). Saved in flash.
                </div>
              </div>
            </div>
          `;
          container.appendChild(card);

          const sel = $("btn-act-" + i);
          if (sel) {
            sel.value = "0";
            sel.addEventListener("focus", () => markBtnEditing(i, true));
            sel.addEventListener("blur", () => { markBtnEditing(i, false); sendBtnCfg(); });
            sel.addEventListener("change", () => {
              btnAction[i] = parseInt(sel.value, 10) || 0;
              sendBtnCfg();
            });
          }
        }
      })();

      // -------- LED Source Config (FULL) --------
      function markLedEditing(i, editing) { ledEditing[i] = editing; }

      async function sendLedCfg() {
        try {
          await connection.send("ledCfg", { src: ledSrc });
          appendLog("UI", "LED sources sent: " + JSON.stringify(ledSrc));
        } catch (err) {
          appendLog("Error", err.message || err);
        }
      }

      // Firmware sends "LedSourceList" in your firmware (preferred), but keep "ledCfg" too
      connection.on("LedSourceList", (list) => {
        const arr = toList(list);
        if (!arr.length) return;

        for (let i=0;i<NUM_LED;i++) {
          const v = Number(arr[i] ?? ledSrc[i]) || 0;
          ledSrc[i] = Math.max(0, Math.min(16, v));

          const sel = $("led-src-" + i);
          if (sel && !ledEditing[i]) sel.value = String(ledSrc[i]);
        }
      });

      connection.on("ledCfg", (data) => {
        const arr = toList(data?.src || []);
        if (!arr.length) return;

        for (let i=0;i<NUM_LED;i++) {
          const v = Number(arr[i] ?? ledSrc[i]) || 0;
          ledSrc[i] = Math.max(0, Math.min(16, v));

          const sel = $("led-src-" + i);
          if (sel && !ledEditing[i]) sel.value = String(ledSrc[i]);
        }
      });

      // Build LED cards (with source selection)
      (function buildLedCards() {
        const container = $("leds-cards");
        if (!container) return;

        const options = [
          [0,  "Manual (button toggle)"],
          [1,  "PID1 Enabled"],
          [2,  "PID2 Enabled"],
          [3,  "PID3 Enabled"],
          [4,  "PID4 Enabled"],
          [5,  "PID1 OUT = 0%"],
          [6,  "PID2 OUT = 0%"],
          [7,  "PID3 OUT = 0%"],
          [8,  "PID4 OUT = 0%"],
          [9,  "PID1 OUT = 100%"],
          [10, "PID2 OUT = 100%"],
          [11, "PID3 OUT = 100%"],
          [12, "PID4 OUT = 100%"],
          [13, "AO1 = 0%"],
          [14, "AO2 = 0%"],
          [15, "AO1 = 100%"],
          [16, "AO2 = 100%"]
        ];

        for (let i = 0; i < NUM_LED; i++) {
          const card = document.createElement("div");

          const optHtml = options.map(([v, t]) =>
            `<option value="${v}">${t}</option>`
          ).join("");

          card.innerHTML = `
            <div style="border:1px solid #ccc;border-radius:6px;background:#f3f5d0;padding:1rem;">
              <div style="display:flex;justify-content:space-between;align-items:center;font-weight:600;">
                <span>LED ${i + 1}</span>
                <span id="led-dot-${i}"
                      style="width:12px;height:12px;border-radius:50%;background:#ccc;display:inline-block;"></span>
              </div>

              <div style="margin-top:.6rem;">
                <label style="font-size:.85rem;">Source</label>
                <select id="led-src-${i}"
                        style="width:100%;padding:6px;border-radius:4px;border:1px solid #ccc;">
                  ${optHtml}
                </select>
                <div style="font-size:.75rem;color:#777;margin-top:4px;line-height:1.2;">
                  Manual: button toggles LED. Otherwise firmware forces LED from selected source.
                </div>
              </div>
            </div>
          `;
          container.appendChild(card);

          const sel = $("led-src-" + i);
          if (sel) {
            sel.value = "0";
            sel.addEventListener("focus", () => markLedEditing(i, true));
            sel.addEventListener("blur", () => { markLedEditing(i, false); sendLedCfg(); });
            sel.addEventListener("change", () => {
              ledSrc[i] = parseInt(sel.value, 10) || 0;
              sendLedCfg();
            });
          }
        }
      })();

      function markPidEditing(index, editing) { pidEditing[index] = editing; }

      // -------- Trend drawing --------
      function drawTrend(pidIndex, force=false) {
        const tr = trend[pidIndex];
        const now = Date.now();
        if (!force && (now - tr.lastDrawMs < 200)) return;
        tr.lastDrawMs = now;

        const canvas = $("pid-trend-" + pidIndex);
        if (!canvas) return;

        const ctx = canvas.getContext("2d");
        const w = canvas.width;
        const h = canvas.height;

        ctx.clearRect(0,0,w,h);
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0,0,w,h);

        ctx.strokeStyle = "#cfcfcf";
        ctx.lineWidth = 1;
        ctx.strokeRect(0.5,0.5,w-1,h-1);

        ctx.strokeStyle = "#e9e9e9";
        ctx.lineWidth = 1;
        for (let p = 0; p <= 4; p++) {
          const y = Math.round((h-1) * (p/4)) + 0.5;
          ctx.beginPath();
          ctx.moveTo(0.5, y);
          ctx.lineTo(w-0.5, y);
          ctx.stroke();
        }

        ctx.fillStyle = "#666";
        ctx.font = "11px Segoe UI, sans-serif";
        ctx.fillText("100%", 6, 12);
        ctx.fillText("0%", 6, h-6);

        const n = tr.t.length;
        if (n < 2) {
          ctx.fillStyle = "#999";
          ctx.fillText("Waiting for live data…", 10, Math.floor(h/2));
          return;
        }

        const t0 = tr.t[0];
        const t1 = tr.t[n-1];
        const span = Math.max(1, (t1 - t0));

        function xAt(i) { return ((tr.t[i] - t0) / span) * (w-1); }
        function yPct(pct) {
          const v = Math.max(0, Math.min(100, pct));
          return (h-1) - (v/100)*(h-1);
        }

        function drawSeries(arr, stroke) {
          ctx.strokeStyle = stroke;
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(xAt(0), yPct(arr[0]));
          for (let i=1;i<n;i++) ctx.lineTo(xAt(i), yPct(arr[i]));
          ctx.stroke();
        }

        drawSeries(tr.pv,  "#1f77b4");
        drawSeries(tr.sp,  "#2ca02c");
        drawSeries(tr.out, "#ff7f0e");

        ctx.font = "12px Segoe UI, sans-serif";
        ctx.fillStyle = "#1f77b4"; ctx.fillText("PV", w-110, 16);
        ctx.fillStyle = "#2ca02c"; ctx.fillText("SP", w-80, 16);
        ctx.fillStyle = "#ff7f0e"; ctx.fillText("OUT", w-45, 16);
      }

      // ---------------- PID rows (4) ----------------
      (function buildPidRows() {
        const container = $("pid-rows");
        if (!container) return;

        for (let i = 0; i < NUM_PID; i++) {
          const idx = i + 1;

          const row = document.createElement("div");
          row.innerHTML = `
            <div style="
              display:grid;
              grid-template-columns: 1fr 1fr;
              gap:1rem;
              align-items:stretch;
              overflow:hidden;
              border:1px solid #ccc;
              border-radius:8px;
              background:#eef8ff;
              padding:1rem;
              box-sizing:border-box;
            ">
              <!-- LEFT: settings -->
              <div style="background:transparent;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;">
                  <span style="font-weight:700;">PID ${idx}</span>
                  <div style="display:flex;gap:.6rem;align-items:center;font-size:.85rem;">
                    <div>
                      <label for="pid-en-${i}" style="margin-right:4px;">State</label>
                      <select id="pid-en-${i}" style="padding:4px 6px;border-radius:4px;border:1px solid #ccc;">
                        <option value="0">Disabled</option>
                        <option value="1">Enabled</option>
                      </select>
                    </div>
                    <div>
                      <label for="pid-mode-${i}" style="margin-right:4px;">Mode</label>
                      <select id="pid-mode-${i}" style="padding:4px 6px;border-radius:4px;border:1px solid #ccc;">
                        <option value="0">Direct</option>
                        <option value="1">Reverse</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;">
                  <div style="grid-column:span 2;">
                    <label style="font-size:.85rem;">Setpoint SP${idx} (raw)</label>
                    <input type="number" id="pid-sp-${i}"
                           style="width:100%;padding:6px;border-radius:4px;border:1px solid #ccc;"
                           value="0" step="1">
                    <div style="font-size:.75rem;color:#777;margin-top:2px;">
                      Raw units (mV for AI sources, °C×10 for RTD sources).
                    </div>
                  </div>

                  <div style="grid-column:span 2;">
                    <label style="font-size:.85rem;">PV Source</label>
                    <select id="pid-pv-${i}"
                            style="width:100%;padding:6px;border-radius:4px;border:1px solid #ccc;">
                      <option value="0">None</option>
                      <option value="1">AI1 (mV)</option>
                      <option value="2">AI2 (mV)</option>
                      <option value="3">AI3 (mV)</option>
                      <option value="4">AI4 (mV)</option>
                      <option value="5">RTD1 (°C×10)</option>
                      <option value="6">RTD2 (°C×10)</option>
                      <option value="7">PV1 (Modbus)</option>
                      <option value="8">PV2 (Modbus)</option>
                      <option value="9">PV3 (Modbus)</option>
                      <option value="10">PV4 (Modbus)</option>
                    </select>
                  </div>

                  <div>
                    <label style="font-size:.85rem;">SP Source</label>
                    <select id="pid-spsrc-${i}"
                            style="width:100%;padding:6px;border-radius:4px;border:1px solid #ccc;">
                      <option value="0">Manual SP</option>
                      <option value="1">SP1 (Modbus)</option>
                      <option value="2">SP2 (Modbus)</option>
                      <option value="3">SP3 (Modbus)</option>
                      <option value="4">SP4 (Modbus)</option>
                      <option value="5">PID1 OUT</option>
                      <option value="6">PID2 OUT</option>
                      <option value="7">PID3 OUT</option>
                      <option value="8">PID4 OUT</option>
                    </select>
                  </div>

                  <div>
                    <label style="font-size:.85rem;">Output Target</label>
                    <select id="pid-out-${i}"
                            style="width:100%;padding:6px;border-radius:4px;border:1px solid #ccc;">
                      <option value="0">None</option>
                      <option value="1">AO1</option>
                      <option value="2">AO2</option>
                    </select>
                  </div>

                  <div>
                    <label style="font-size:.85rem;">Kp</label>
                    <input type="number" id="pid-kp-${i}"
                           style="width:100%;padding:6px;border-radius:4px;border:1px solid #ccc;"
                           value="0" step="0.01">
                  </div>
                  <div>
                    <label style="font-size:.85rem;">Ki</label>
                    <input type="number" id="pid-ki-${i}"
                           style="width:100%;padding:6px;border-radius:4px;border:1px solid #ccc;"
                           value="0" step="0.01">
                  </div>
                  <div>
                    <label style="font-size:.85rem;">Kd</label>
                    <input type="number" id="pid-kd-${i}"
                           style="width:100%;padding:6px;border-radius:4px;border:1px solid #ccc;"
                           value="0" step="0.01">
                  </div>

                  <div style="grid-column:span 2;border-top:1px dashed #ccc;margin-top:.5rem;padding-top:.5rem;">
                    <div style="font-weight:600;margin-bottom:.25rem;font-size:.85rem;">Scaling (raw → 0–100%)</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;">
                      <div>
                        <label style="font-size:.8rem;">PV min</label>
                        <input type="number" id="pid-pvmin-${i}"
                               style="width:100%;padding:6px;border-radius:4px;border:1px solid #ccc;"
                               value="0" step="1">
                      </div>
                      <div>
                        <label style="font-size:.8rem;">PV max</label>
                        <input type="number" id="pid-pvmax-${i}"
                               style="width:100%;padding:6px;border-radius:4px;border:1px solid #ccc;"
                               value="10000" step="1">
                      </div>
                      <div>
                        <label style="font-size:.8rem;">OUT min</label>
                        <input type="number" id="pid-outmin-${i}"
                               style="width:100%;padding:6px;border-radius:4px;border:1px solid #ccc;"
                               value="0" step="1">
                      </div>
                      <div>
                        <label style="font-size:.8rem;">OUT max</label>
                        <input type="number" id="pid-outmax-${i}"
                               style="width:100%;padding:6px;border-radius:4px;border:1px solid #ccc;"
                               value="4095" step="1">
                      </div>
                    </div>
                  </div>

                  <div style="grid-column:span 2;margin-top:.25rem;font-size:.85rem;background:#fff;border-radius:6px;padding:.5rem;">
                    <div>
                      PV: <span id="pid-pv-pct-${i}">--</span> % &nbsp; | &nbsp;
                      SP: <span id="pid-sp-pct-${i}">--</span> % &nbsp; | &nbsp;
                      OUT: <span id="pid-out-pct-${i}">--</span> %
                    </div>
                  </div>
                </div>
              </div>

              <!-- RIGHT: trend -->
              <div style="
                background:#ffffff;
                border:1px solid #d8d8d8;
                border-radius:8px;
                padding:.75rem;
                height:100%;
                display:flex;
                flex-direction:column;
                box-sizing:border-box;
              ">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;flex:0 0 auto;">
                  <div style="font-weight:700;">Trend (PV / SP / OUT)</div>
                  <div style="display:flex;gap:.5rem;align-items:center;">
                    <label style="font-size:.85rem;color:#444;">Window</label>
                    <select id="pid-win-${i}" style="padding:4px 6px;border-radius:4px;border:1px solid #ccc;">
                      <option value="10" selected>10 min</option>
                      <option value="30">30 min</option>
                      <option value="60">1 hour</option>
                    </select>
                  </div>
                </div>

                <div style="font-size:.8rem;color:#666;margin-bottom:.5rem;line-height:1.25;flex:0 0 auto;">
                  PV/SP raw scale: <span id="pid-scale-pv-${i}">--</span>
                  &nbsp; | &nbsp; OUT raw scale: <span id="pid-scale-out-${i}">--</span>
                </div>

                <div style="flex:1 1 auto;min-height:0;overflow:hidden;">
                  <canvas id="pid-trend-${i}" width="420" height="380"
                          style="width:100%;height:100%;display:block;border-radius:6px;"></canvas>
                </div>

                <div style="margin-top:.4rem;font-size:.8rem;color:#666;flex:0 0 auto;">
                  Y axis: 0–100% &nbsp; (PV/SP from PV min/max, OUT from OUT min/max)
                </div>
              </div>
            </div>
          `;

          container.appendChild(row);

          const winSel = $("pid-win-" + i);
          if (winSel) {
            winSel.addEventListener("change", () => {
              setTrendWindow(i, parseInt(winSel.value, 10) || 10);
            });
          }
        }

        for (let i = 0; i < NUM_PID; i++) {
          const controls = [
            $("pid-en-" + i),
            $("pid-mode-" + i),
            $("pid-sp-" + i),
            $("pid-pv-" + i),
            $("pid-spsrc-" + i),
            $("pid-out-" + i),
            $("pid-kp-" + i),
            $("pid-ki-" + i),
            $("pid-kd-" + i),
            $("pid-pvmin-" + i),
            $("pid-pvmax-" + i),
            $("pid-outmin-" + i),
            $("pid-outmax-" + i)
          ];

          controls.forEach((el) => {
            if (!el) return;
            el.addEventListener("focus", () => markPidEditing(i, true));
            el.addEventListener("blur", () => {
              markPidEditing(i, false);
              sendPidConfig();
              sendPidMode();
            });
          });
        }

        const applyBtn = $("pid-apply-all");
        if (applyBtn) {
          applyBtn.addEventListener("click", () => {
            sendPidConfig();
            sendPidMode();
          });
        }

        for (let i=0;i<NUM_PID;i++) drawTrend(i, true);
      })();

      async function sendPidConfig() {
        try {
          const spArr     = [];
          const enArr     = [];
          const pvArr     = [];
          const spSrcArr  = [];
          const outArr    = [];
          const kpArr     = [];
          const kiArr     = [];
          const kdArr     = [];
          const pvMinArr  = [];
          const pvMaxArr  = [];
          const outMinArr = [];
          const outMaxArr = [];

          for (let i = 0; i < NUM_PID; i++) {
            const enEl     = $("pid-en-" + i);
            const spEl     = $("pid-sp-" + i);
            const pvEl     = $("pid-pv-" + i);
            const spSrcEl  = $("pid-spsrc-" + i);
            const outEl    = $("pid-out-" + i);
            const kpEl     = $("pid-kp-" + i);
            const kiEl     = $("pid-ki-" + i);
            const kdEl     = $("pid-kd-" + i);
            const pvMinEl  = $("pid-pvmin-" + i);
            const pvMaxEl  = $("pid-pvmax-" + i);
            const outMinEl = $("pid-outmin-" + i);
            const outMaxEl = $("pid-outmax-" + i);

            pidEn[i]     = enEl     ? (parseInt(enEl.value, 10) || 0)     : pidEn[i];
            pidSp[i]     = spEl     ? (parseInt(spEl.value, 10) || 0)     : pidSp[i];
            pidPvSrc[i]  = pvEl     ? (parseInt(pvEl.value, 10) || 0)     : pidPvSrc[i];
            pidSpSrc[i]  = spSrcEl  ? (parseInt(spSrcEl.value, 10) || 0)  : pidSpSrc[i];
            pidOutSel[i] = outEl    ? (parseInt(outEl.value, 10) || 0)    : pidOutSel[i];
            pidKp[i]     = kpEl     ? (parseFloat(kpEl.value) || 0)       : pidKp[i];
            pidKi[i]     = kiEl     ? (parseFloat(kiEl.value) || 0)       : pidKi[i];
            pidKd[i]     = kdEl     ? (parseFloat(kdEl.value) || 0)       : pidKd[i];

            pidPvMin[i]  = pvMinEl  ? (parseFloat(pvMinEl.value) || 0)    : pidPvMin[i];
            pidPvMax[i]  = pvMaxEl  ? (parseFloat(pvMaxEl.value) || 0)    : pidPvMax[i];
            pidOutMin[i] = outMinEl ? (parseFloat(outMinEl.value) || 0)   : pidOutMin[i];
            pidOutMax[i] = outMaxEl ? (parseFloat(outMaxEl.value) || 0)   : pidOutMax[i];

            spArr.push(pidSp[i]);
            enArr.push(pidEn[i]);
            pvArr.push(pidPvSrc[i]);
            spSrcArr.push(pidSpSrc[i]);
            outArr.push(pidOutSel[i]);

            kpArr.push(Math.round(pidKp[i] * 100));
            kiArr.push(Math.round(pidKi[i] * 100));
            kdArr.push(Math.round(pidKd[i] * 100));

            pvMinArr.push(pidPvMin[i]);
            pvMaxArr.push(pidPvMax[i]);
            outMinArr.push(pidOutMin[i]);
            outMaxArr.push(pidOutMax[i]);
          }

          const payload = {
            sp:      spArr,
            en:      enArr,
            pv:      pvArr,
            sp_src:  spSrcArr,
            out:     outArr,
            kp:      kpArr,
            ki:      kiArr,
            kd:      kdArr,
            pv_min:  pvMinArr,
            pv_max:  pvMaxArr,
            out_min: outMinArr,
            out_max: outMaxArr
          };

          await connection.send("pid", payload);
          appendLog("UI", "PID config sent");
        } catch (err) {
          appendLog("Error", err.message || err);
        }
      }

      async function sendPidMode() {
        try {
          const modeArr = [];
          for (let i = 0; i < NUM_PID; i++) {
            const modeEl = $("pid-mode-" + i);
            pidMode[i] = modeEl ? (parseInt(modeEl.value, 10) || 0) : pidMode[i];
            modeArr.push(pidMode[i] ? 1 : 0);
          }
          await connection.send("pidMode", { mode: modeArr });
        } catch (err) {
          appendLog("FW?", "pidMode not accepted (PID config still OK)");
        }
      }

      connection.on("pidState", (state) => {
        if (!state) return;

        const sp        = toList(state.sp);
        const en        = toList(state.en);
        const pvSel     = toList(state.pv);
        const spSrc     = toList(state.sp_src);
        const outSel    = toList(state.out);
        const kpArr     = toList(state.kp);
        const kiArr     = toList(state.ki);
        const kdArr     = toList(state.kd);

        const pvMinArr  = toList(state.pv_min || []);
        const pvMaxArr  = toList(state.pv_max || []);
        const outMinArr = toList(state.out_min || []);
        const outMaxArr = toList(state.out_max || []);
        const pvPctArr  = toList(state.pv_pct || []);
        const spPctArr  = toList(state.sp_pct || []);
        const outPctArr = toList(state.out_pct || []);

        const modeArr   = toList(state.mode || []);

        for (let i = 0; i < NUM_PID; i++) {
          const spVal      = Number(sp[i]       ?? 0);
          const enVal      = Number(en[i]       ?? 0);
          const pvVal      = Number(pvSel[i]    ?? 0);
          const spSrcVal   = Number(spSrc[i]    ?? 0);
          const outVal     = Number(outSel[i]   ?? 0);
          const kpVal      = Number(kpArr[i]    ?? 0) / 100;
          const kiVal      = Number(kiArr[i]    ?? 0) / 100;
          const kdVal      = Number(kdArr[i]    ?? 0) / 100;

          const pvMinVal   = Number(pvMinArr[i] ?? pidPvMin[i]);
          const pvMaxVal   = Number(pvMaxArr[i] ?? pidPvMax[i]);
          const outMinVal  = Number(outMinArr[i]?? pidOutMin[i]);
          const outMaxVal  = Number(outMaxArr[i]?? pidOutMax[i]);

          const pvPctVal   = Number(pvPctArr[i] ?? NaN);
          const spPctVal   = Number(spPctArr[i] ?? NaN);
          const outPctVal  = Number(outPctArr[i]?? NaN);

          pidSp[i]     = spVal;
          pidEn[i]     = enVal;
          pidPvSrc[i]  = pvVal;
          pidSpSrc[i]  = spSrcVal;
          pidOutSel[i] = outVal;
          pidKp[i]     = kpVal;
          pidKi[i]     = kiVal;
          pidKd[i]     = kdVal;

          pidPvMin[i]  = pvMinVal;
          pidPvMax[i]  = pvMaxVal;
          pidOutMin[i] = outMinVal;
          pidOutMax[i] = outMaxVal;

          if (!isNaN(pvPctVal) && !isNaN(spPctVal) && !isNaN(outPctVal)) {
            pushTrend(i, pvPctVal, spPctVal, outPctVal);
            drawTrend(i, false);
          }

          const pvScaleEl = $("pid-scale-pv-" + i);
          const outScaleEl = $("pid-scale-out-" + i);
          if (pvScaleEl) pvScaleEl.textContent = `${pvMinVal} .. ${pvMaxVal}`;
          if (outScaleEl) outScaleEl.textContent = `${outMinVal} .. ${outMaxVal}`;

          if (!pidEditing[i]) {
            const enEl      = $("pid-en-" + i);
            const spEl      = $("pid-sp-" + i);
            const pvEl      = $("pid-pv-" + i);
            const spSrcEl   = $("pid-spsrc-" + i);
            const outEl     = $("pid-out-" + i);
            const kpEl      = $("pid-kp-" + i);
            const kiEl      = $("pid-ki-" + i);
            const kdEl      = $("pid-kd-" + i);
            const pvMinEl   = $("pid-pvmin-" + i);
            const pvMaxEl   = $("pid-pvmax-" + i);
            const outMinEl  = $("pid-outmin-" + i);
            const outMaxEl  = $("pid-outmax-" + i);

            const pvPctEl   = $("pid-pv-pct-" + i);
            const spPctEl   = $("pid-sp-pct-" + i);
            const outPctEl  = $("pid-out-pct-" + i);

            if (enEl)     enEl.value    = String(enVal);
            if (spEl)     spEl.value    = String(spVal);
            if (pvEl)     pvEl.value    = String(pvVal);
            if (spSrcEl)  spSrcEl.value = String(spSrcVal);
            if (outEl)    outEl.value   = String(outVal);
            if (kpEl)     kpEl.value    = kpVal.toString();
            if (kiEl)     kiEl.value    = kiVal.toString();
            if (kdEl)     kdEl.value    = kdVal.toString();

            if (pvMinEl)  pvMinEl.value = pvMinVal.toString();
            if (pvMaxEl)  pvMaxEl.value = pvMaxVal.toString();
            if (outMinEl) outMinEl.value= outMinVal.toString();
            if (outMaxEl) outMaxEl.value= outMaxVal.toString();

            if (pvPctEl)  pvPctEl.textContent  = isNaN(pvPctVal)  ? "--" : pvPctVal.toFixed(1);
            if (spPctEl)  spPctEl.textContent  = isNaN(spPctVal)  ? "--" : spPctVal.toFixed(1);
            if (outPctEl) outPctEl.textContent = isNaN(outPctVal) ? "--" : outPctVal.toFixed(1);

            if (modeArr.length) {
              const modeEl = $("pid-mode-" + i);
              const m = (Number(modeArr[i] ?? 0) ? 1 : 0);
              pidMode[i] = m;
              if (modeEl) modeEl.value = String(m);
            }
          }
        }
      });

      connection.on("pidMode", (data) => {
        const modeArr = toList(data?.mode || data || []);
        if (!modeArr.length) return;
        for (let i = 0; i < NUM_PID; i++) {
          const m = (Number(modeArr[i] ?? 0) ? 1 : 0);
          pidMode[i] = m;
          const modeEl = $("pid-mode-" + i);
          if (modeEl && !pidEditing[i]) modeEl.value = String(m);
        }
      });

      // Live updates
      connection.on("aiValues", (list) => {
        const vals = toList(list);
        vals.forEach((mv, i) => {
          const mvNum = Number(mv);
          const rawSpan = $("ai-raw-" + i);
          const vSpan   = $("ai-volts-" + i);
          const dot     = $("ai-dot-" + i);
          if (rawSpan) rawSpan.textContent = isNaN(mvNum) ? "--" : mvNum.toString();
          const volts = mvNum / 1000;
          if (vSpan && !isNaN(volts)) vSpan.textContent = volts.toFixed(3);
          if (dot) dot.style.background = volts > 0.1 ? "#4caf50" : "#ccc";
        });
      });

      connection.on("rtdTemps_x10", (list) => {
        const vals = toList(list);
        vals.forEach((t10, i) => {
          const span = $("rtd-temp-" + i);
          const val = Number(t10);
          if (!span) return;
          span.textContent = isNaN(val) ? "--" : (val / 10).toFixed(1);
        });
      });

      connection.on("dacValues", (list) => {
        const vals = toList(list);
        vals.forEach((v, i) => {
          const val = Number(v) || 0;
          dacValues[i] = val;
          const slider = $("dac-slider-" + i);
          const rawEl  = $("dac-raw-" + i);
          const vEl    = $("dac-volts-" + i);
          if (slider) slider.value = val;
          if (rawEl)  rawEl.textContent = val;
          if (vEl)    vEl.textContent = (val / 4095 * 10).toFixed(2);
        });
      });

      connection.on("ButtonStateList", (list) => {
        const vals = toList(list);
        vals.forEach((v, i) => {
          const dot = $("btn-dot-" + i);
          if (dot) dot.style.background = v ? "#4caf50" : "#ccc";
        });
      });

      connection.on("LedStateList", (list) => {
        const vals = toList(list);
        vals.forEach((v, i) => {
          const dot = $("led-dot-" + i);
          if (dot) dot.style.background = v ? "#ffb300" : "#ccc";
        });
      });

      // DAC sliders send
      for (let i = 0; i < NUM_DAC; i++) {
        const slider = $("dac-slider-" + i);
        if (!slider) continue;

        slider.addEventListener("input", () => {
          const val = Number(slider.value);
          dacValues[i] = val;
          const rawEl = $("dac-raw-" + i);
          const vEl   = $("dac-volts-" + i);
          if (rawEl) rawEl.textContent = val;
          if (vEl) vEl.textContent = (val / 4095 * 10).toFixed(2);
        });

        slider.addEventListener("change", async () => {
          await connection.send("dac", { list: dacValues });
          appendLog("UI", "DAC update: " + JSON.stringify(dacValues));
        });
      }
    })();
  </script>
</section>
