<section style="font-family:var(--font, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial);padding:2rem;max-width:1160px;margin:auto;">
  <style>
    :root{
      --page:#ffffff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --muted2:#64748b;
      --border:#e2e8f0;
      --borderStrong:#cbd5e1;
      --brand:#2563eb;
      --brandHover:#1d4ed8;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow:0 1px 0 rgba(15,23,42,.05), 0 10px 22px rgba(15,23,42,.08);
      --r:16px;
      --r2:14px;
      --gap:16px;
      --font:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;

      /* Group tints */
      --tint-input-bg:#e9fbe9;
      --tint-input-br:#bfe7bf;
      --tint-button-bg:#dbe9ff;
      --tint-button-br:#b7cffc;
      --tint-led-bg:#f6f8d6;
      --tint-led-br:#e2e79e;
      --tint-relay-bg:#eef2ff;
      --tint-relay-br:#c7d2fe;
    }
    *{box-sizing:border-box}
    
    /* Inputs and forms */
    label{display:block;font-size:12px;font-weight:750;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--borderStrong);font-size:13px;color:var(--text);background:#fff;box-sizing:border-box}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,.15)}
    textarea{min-height:140px;font-family:ui-monospace,Consolas,monospace}
    .hm-input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--borderStrong);font-size:13px;color:var(--text);background:#fff;box-sizing:border-box}
    
    /* Pills and badges */
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;font-size:12px;font-weight:650;color:var(--muted);border:1px solid var(--border);border-radius:999px;background:#fff}
    .pill.mono{font-family:monospace;background:#eef6ff;border:1px solid #cfe2ff}
    .pill.pos{background:#ffe9cc;border:1px solid #ffd39b}
    .tag{font-size:11px;font-weight:750;color:#0f172a;border:1px solid var(--border);background:#f8fafc;padding:3px 8px;border-radius:999px;white-space:nowrap}
    
    /* Buttons */
    .btn{padding:8px 14px;font-size:13px;font-weight:750;border-radius:12px;border:1px solid var(--borderStrong);background:#fff;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn.primary:hover{background:var(--brandHover)}
    .btn.danger{color:var(--bad);border-color:#fecaca}
    .btn.danger:hover{background:rgba(239,68,68,.06)}
    
    /* Cards */
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow)}
    .cardheader{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .cardheader h2{margin:0;font-size:14px;font-weight:850}
    .sub{margin-top:4px;font-size:12px;color:var(--muted)}
    .cardbody{padding:14px}
    
    /* Layout */
    .grid{display:grid;gap:var(--gap);margin-top:16px}
    .grid.two{grid-template-columns:1.2fr .8fr}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    
    /* Section titles */
    .sectiontitle{margin:18px 0 10px;display:flex;justify-content:space-between;align-items:baseline;gap:12px}
    .sectiontitle h3{margin:0;font-size:14px;font-weight:900}
    .sectiontitle .hint{margin:0;font-size:12px;color:var(--muted2);font-weight:650}
    
    /* Utilities */
    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}
    .mono{font-family:ui-monospace,Consolas,monospace}
    
    /* Status dots */
    .dot{width:8px;height:8px;border-radius:50%;background:#cbd5e1}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .state-dot{width:10px;height:10px;border-radius:50%;display:inline-block;vertical-align:middle;margin-left:.4rem}
    .dot-on{background:var(--ok)}
    .dot-off{background:#bbb}
    
    /* Header */
    .appbar{display:flex;justify-content:space-between;gap:16px;padding:16px;background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);margin-bottom:var(--gap)}
    .headLeft{display:flex;gap:14px;align-items:center;min-width:300px}
    .moduleImage{width:64px;height:64px;border-radius:14px;border:1px solid var(--border);display:grid;place-items:center;overflow:hidden}
    .moduleImage img{width:100%;height:100%;object-fit:contain}
    .title h1{margin:0;font-size:18px;font-weight:800}
    .title p{margin:4px 0 0;font-size:13px;color:var(--muted)}
    .statusbar{display:flex;flex-direction:column;align-items:flex-end;gap:10px}
    .pillrow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    
    /* Log box */
    #log-box{margin-bottom:1.25rem;padding:1rem;background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);font-size:12px}
    #log-content{white-space:pre-wrap;font-family:monospace;line-height:1.25em;margin:.5rem 0 0;height:calc(1.25em * 8);overflow-y:auto;background:#fff;border:1px solid var(--border);border-radius:var(--r2);padding:.6rem}
    
    /* IO groups */
    .iogroup{display:grid;gap:var(--gap);grid-template-columns:repeat(4,1fr)}
    .iogroup.cols2{grid-template-columns:repeat(2,1fr)}
    .iogroup.cols3{grid-template-columns:repeat(3,1fr)}
    .iogroup.cols4{grid-template-columns:repeat(4,1fr)}
    .iocard{border:1px solid var(--border);border-radius:var(--r2);padding:12px;background:#fff;position:relative;overflow:hidden}
    .iocard::before{content:"";position:absolute;left:0;top:0;right:0;height:42px;background:rgba(255,255,255,.55);border-bottom:1px solid rgba(15,23,42,.06);pointer-events:none}
    .iotop{position:relative;z-index:1;display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .iocard > *:not(.iotop){position:relative;z-index:1}
    .ioid{font-size:14px;font-weight:900}
    .ioBadge{font-size:11px;font-weight:750;border:1px solid var(--border);padding:3px 8px;border-radius:999px;background:#f8fafc}
    
    /* Group tints */
    .tint-input{background:var(--tint-input-bg);border-color:var(--tint-input-br)}
    .tint-button{background:var(--tint-button-bg);border-color:var(--tint-button-br)}
    .tint-led{background:var(--tint-led-bg);border-color:var(--tint-led-br)}
    .tint-relay{background:var(--tint-relay-bg);border-color:var(--tint-relay-br)}
    .iocard.tint-input::before,
    .iocard.tint-button::before,
    .iocard.tint-led::before,
    .iocard.tint-relay::before{background:rgba(255,255,255,.50)}
    .iocard select,
    .iocard input,
    .iocard textarea{background:rgba(255,255,255,.92)}
    .checkRow{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
    .check{display:flex;align-items:center;gap:8px;font-size:12px;font-weight:700;color:var(--text)}
    .check input{width:auto}
    .split{display:grid;gap:10px}
    
    /* Inputs config - 2x2 grid layout */
    #inputs-config{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:var(--gap);
    }
    
    /* Responsive */
    @media(max-width:980px){
      .grid.two{grid-template-columns:1fr}
      .statusbar{align-items:flex-start}
      .pillrow,.actions{justify-content:flex-start}
    }
    @media(max-width:1100px){
      .iogroup.cols4{grid-template-columns:repeat(2,1fr)}
      .iogroup.cols3{grid-template-columns:repeat(2,1fr)}
    }
    @media(max-width:640px){
      .row{grid-template-columns:1fr}
      .iogroup,.iogroup.cols2,.iogroup.cols3,.iogroup.cols4{grid-template-columns:1fr}
    }
  </style>

  <!-- Header -->
  <header class="appbar">
    <div class="headLeft">
      <div class="moduleImage">
        <img src="https://raw.githubusercontent.com/isystemsautomation/HOMEMASTER/refs/heads/main/DIO-430-R1/Images/photo1.png" alt="DIO-430-R1">
      </div>
      <div class="title">
        <h1>DIO-430-R1 Module Configuration</h1>
        <p>Configure Modbus address, serial settings, digital inputs (4), relays (3), buttons (3), and LEDs (3).</p>
      </div>
    </div>
    <div class="statusbar">
      <div class="pillrow">
        <div class="pill"><span class="dot warn" id="connDot"></span>Connection: <span id="connText" style="color:var(--text)">Disconnected</span></div>
        <div class="pill">Modbus ID: <span id="live-address" style="color:var(--text)">—</span></div>
        <div class="pill">Baud: <span id="live-baud" style="color:var(--text)">—</span></div>
      </div>
      <div class="actions">
        <button class="btn primary" id="connect-button">Connect</button>
      </div>
    </div>
  </header>

  <!-- Top: Device Setup + Log -->
  <div class="grid two">
    <section class="card">
      <div class="cardheader">
        <div>
          <h2>Device Setup</h2>
          <div class="sub">Serial connection and Modbus addressing.</div>
        </div>
        <span class="tag">Step 1</span>
      </div>
      <div class="cardbody">
        <div class="row">
          <div>
            <label for="modbus-address">Modbus Address</label>
            <select id="modbus-address"></select>
            <div class="mini" style="margin-top:8px;font-size:12px;color:var(--muted2)">Use a unique address per device on the bus.</div>
          </div>
          <div>
            <label for="modbus-baud">Baud Rate</label>
            <select id="modbus-baud">
              <option value="9600">9600</option>
              <option value="19200" selected>19200</option>
              <option value="38400">38400</option>
              <option value="57600">57600</option>
              <option value="115200">115200</option>
            </select>
            <div class="mini" style="margin-top:8px;font-size:12px;color:var(--muted2)">Must match your controller UART settings.</div>
          </div>
        </div>
      </div>
    </section>
    <section class="card">
      <div class="cardheader">
        <div>
          <h2>Serial Log</h2>
          <div class="sub">Communication messages and status updates.</div>
        </div>
      </div>
      <div class="cardbody">
        <div id="log-box">
          <div id="log-content"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- ===== Digital Inputs ===== -->
  <div class="sectiontitle">
    <h3>Digital Inputs (4)</h3>
    <p class="hint">Configure enable, invert, action, and control target.</p>
  </div>
  <section class="card">
    <div class="cardbody">
      <div id="inputs-config"></div>
    </div>
  </section>

  <!-- ===== Relays ===== -->
  <div class="sectiontitle">
    <h3>Relays (3)</h3>
    <p class="hint">Configure enable, invert, and control options.</p>
  </div>
  <section class="card">
    <div class="cardbody">
      <div class="iogroup cols3" id="relays-config"></div>
    </div>
  </section>

  <!-- ===== Buttons ===== -->
  <div class="sectiontitle">
    <h3>Buttons (3)</h3>
    <p class="hint">Map physical buttons to relay override actions.</p>
  </div>
  <section class="card">
    <div class="cardbody">
      <div class="iogroup cols3" id="buttons-config"></div>
    </div>
  </section>

  <!-- ===== LEDs ===== -->
  <div class="sectiontitle">
    <h3>User LEDs (3)</h3>
    <p class="hint">Set indicator behavior (solid, blink, follow sources).</p>
  </div>
  <section class="card">
    <div class="cardbody">
      <div class="iogroup cols3" id="leds-config"></div>
    </div>
  </section>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
  <script src="https://unpkg.com/simple-web-serial@latest/dist/simple-web-serial.min.js"></script>
  <script>
  (function(){
    const $ = id => document.getElementById(id);
    const toArray = x => (Array.isArray(x) ? x : (x && typeof x==='object' ? Object.keys(x).sort((a,b)=>(+a)-(+b)).map(k=>x[k]) : []));
    const NUM_DI = 4, NUM_RLY = 3, NUM_BTN = 3, NUM_LED = 3;

    /* === Logging === */
    const LOG_MAX=500, buf=[];
    function log(label,data){
      const el=$('log-content'); if(!el) return;
      const t=new Date().toLocaleTimeString();
      const body=(typeof data==='string')?data:JSON.stringify(data);
      buf.push(`[${t}] ${label}: ${body}`); if(buf.length>LOG_MAX) buf.shift();
      el.textContent=buf.join('\n'); el.scrollTop=el.scrollHeight;
    }
    window.addEventListener('error', e=>log('JS Error', e.message||e));
    window.addEventListener('unhandledrejection', e=>{
      const err = e.reason;
      const errMsg = err?.message || String(err || '');
      if(errMsg.includes('NetworkError') || errMsg.includes('device has been lost')){
        lastDataReceived = 0;
        updateConnectionStatus();
      }
      log('Unhandled Rejection', errMsg);
    });
    function logTx(channel, packet){ try{ log('TX', {channel, ...packet}); }catch{ log('TX', String(channel)+' '+String(packet)); } }

    if(!('serial' in navigator)){
      log('System','This browser does not support the Web Serial API. Use Chrome/Edge over HTTPS.');
    }
    (function(){ const sel=$('modbus-address'); if(!sel) return; for(let i=1;i<=255;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; sel.appendChild(o); } sel.value='3'; })();

    let conn;
    try{
      conn = SimpleWebSerial.setupSerialConnection({ requestAccessOnPageLoad:false, requestElement:'connect-button' });
    }catch(e){
      log('Error','SimpleWebSerial init failed: '+(e?.message||e));
      conn = { on:()=>{}, isOpen:()=>false, send:()=>Promise.reject(new Error('SWS not ready')) };
    }
    const isOpen = ()=>{ try{ return (typeof conn.isOpen==='function') ? conn.isOpen() : !!conn.port; }catch{ return false; } };

    // Connection status monitoring
    let lastDataReceived = 0;
    let connectionCheckInterval = null;
    const DATA_TIMEOUT_MS = 3000;

    function markDataReceived(){
      lastDataReceived = Date.now();
      const connDot = $('connDot');
      const connText = $('connText');
      if(connDot && connText){
        connDot.className = 'dot ok';
        connText.textContent = 'Connected';
      }
    }

    function updateConnectionStatus(){
      const now = Date.now();
      const connDot = $('connDot');
      const connText = $('connText');
      if(!connDot || !connText) return;
      const timeSinceLastData = lastDataReceived > 0 ? (now - lastDataReceived) : Infinity;
      if(timeSinceLastData <= DATA_TIMEOUT_MS){
        connDot.className = 'dot ok';
        connText.textContent = 'Connected';
      } else {
        connDot.className = 'dot warn';
        connText.textContent = 'Disconnected';
      }
    }

    function startConnectionMonitoring(){
      if(connectionCheckInterval) clearInterval(connectionCheckInterval);
      connectionCheckInterval = setInterval(updateConnectionStatus, 500);
      updateConnectionStatus();
    }

    function stopConnectionMonitoring(){
      if(connectionCheckInterval){
        clearInterval(connectionCheckInterval);
        connectionCheckInterval = null;
      }
      lastDataReceived = 0;
      updateConnectionStatus();
    }

    if(conn.on){
      conn.on('open', ()=>{ 
        log('port','open'); 
        lastDataReceived = 0;
        startConnectionMonitoring();
      });
      conn.on('close',()=>{ 
        log('port','close'); 
        lastDataReceived = 0;
        stopConnectionMonitoring();
      });
      conn.on('message', m=>{
        log('log', m);
        markDataReceived();
      });
      conn.on('status',  st=>{
        markDataReceived();
        $('live-address').textContent = (st&&st.address!=null)?st.address:'--';
        $('live-baud').textContent    = (st&&st.baud!=null)?st.baud:'--';
        if(st&&st.address!=null) $('modbus-address').value=String(st.address);
        if(st&&st.baud!=null)    $('modbus-baud').value   =String(st.baud);
      });
    }

    function pushModbus(){
      const mb_address=parseInt($('modbus-address')?.value||'3',10);
      const mb_baud   =parseInt($('modbus-baud')?.value||'19200',10);
      const packet = {mb_address,mb_baud};
      logTx('values', packet);
      conn.send('values', packet).catch(()=>log('Error','Failed to send Modbus values'));
    }
    $('modbus-address')?.addEventListener('input', pushModbus);
    $('modbus-baud')?.addEventListener('input',    pushModbus);

    // Build UI
    (function buildInputs(){
      const c=$('inputs-config'); if(!c) return;
      const actionOpts = [{v:0,l:'None'},{v:1,l:'Toggle'},{v:2,l:'Pulse'}].map(o=>`<option value="${o.v}">${o.l}</option>`).join('');
      const targetOpts = [{v:4,l:'None'},{v:0,l:'Control all'},{v:1,l:'Control relay 1'},{v:2,l:'Control relay 2'},{v:3,l:'Control relay 3'}].map(o=>`<option value="${o.v}">${o.l}</option>`).join('');
      for(let i=1;i<=NUM_DI;i++){
        const d=document.createElement('div');
        d.className='iocard tint-input';
        d.innerHTML = `
          <div class="iotop">
            <span class="ioid">IN${i}</span>
            <span class="ioBadge badgeState"><span id="state-in${i}" class="state-dot dot-off"></span></span>
          </div>
          <div class="checkRow">
            <label class="check"><input type="checkbox" id="enable-in${i}"> Enabled</label>
            <label class="check"><input type="checkbox" id="invert-in${i}"> Inverted</label>
          </div>
          <div class="split">
            <div>
              <label for="action-in${i}">Action</label>
              <select id="action-in${i}">${actionOpts}</select>
            </div>
            <div>
              <label for="target-in${i}">Control Target</label>
              <select id="target-in${i}">${targetOpts}</select>
            </div>
          </div>`;
        c.appendChild(d);
      }
    })();

    (function buildRelays(){
      const c=$('relays-config'); if(!c) return;
      for(let i=1;i<=NUM_RLY;i++){
        const d=document.createElement('div');
        d.className='iocard tint-relay';
        d.innerHTML = `
          <div class="iotop">
            <span class="ioid">Relay ${i}</span>
            <span class="ioBadge badgeState"><span id="state-relay${i}" class="state-dot dot-off"></span></span>
          </div>
          <div class="checkRow">
            <label class="check"><input type="checkbox" id="enable-relay${i}"> Enabled</label>
            <label class="check"><input type="checkbox" id="invert-relay${i}"> Inverted</label>
          </div>`;
        c.appendChild(d);
      }
    })();

    (function buildLEDsAndButtons(){
      const LC=$('leds-config'), BC=$('buttons-config'); if(!LC||!BC) return;

      const ledModeOpts = [{v:0,l:'Solid'},{v:1,l:'Blink'}].map(o=>`<option value="${o.v}">${o.l}</option>`).join('');
      const ledSrcOpts = [{v:0,l:'(none)'},{v:5,l:'Overridden Relay 1'},{v:6,l:'Overridden Relay 2'},{v:7,l:'Overridden Relay 3'}].map(o=>`<option value="${o.v}">${o.l}</option>`).join('');

      for(let i=1;i<=NUM_LED;i++){
        const d=document.createElement('div');
        d.className='iocard tint-led';
        d.innerHTML=`
          <div class="iotop">
            <span class="ioid">User LED ${i}</span>
            <span class="ioBadge badgeState"><span id="state-led${i}" class="state-dot dot-off"></span></span>
          </div>
          <div>
            <label for="mode-led${i}">Mode</label>
            <select id="mode-led${i}">${ledModeOpts}</select>
          </div>
          <div style="margin-top:10px;">
            <label for="source-led${i}">Source</label>
            <select id="source-led${i}">${ledSrcOpts}</select>
          </div>`;
        LC.appendChild(d);
      }

      const btnActOpts = [{v:0,l:'None'},{v:5,l:'Relay 1 override (toggle)'},{v:6,l:'Relay 2 override (toggle)'},{v:7,l:'Relay 3 override (toggle)'}].map(o=>`<option value="${o.v}">${o.l}</option>`).join('');

      for(let i=1;i<=NUM_BTN;i++){
        const d=document.createElement('div');
        d.className='iocard tint-button';
        d.innerHTML=`
          <div class="iotop">
            <span class="ioid">Button ${i}</span>
            <span class="ioBadge badgeState"><span id="state-button${i}" class="state-dot dot-off"></span></span>
          </div>
          <div>
            <label for="action-button${i}">Action (on press)</label>
            <select id="action-button${i}">${btnActOpts}</select>
          </div>`;
        BC.appendChild(d);
      }
    })();

    // Event handlers
    function sendInputEnable(){ const l=[]; for(let i=1;i<=NUM_DI;i++) l.push(!!$('enable-in'+i).checked); const packet={t:'inputEnable',list:l}; logTx('Config',packet); conn.send('Config',packet); }
    function sendInputInvert(){ const l=[]; for(let i=1;i<=NUM_DI;i++) l.push(!!$('invert-in'+i).checked); const packet={t:'inputInvert',list:l}; logTx('Config',packet); conn.send('Config',packet); }
    function sendInputAction(){ const l=[]; for(let i=1;i<=NUM_DI;i++) l.push(parseInt($('action-in'+i).value||'0',10)); const packet={t:'inputAction',list:l}; logTx('Config',packet); conn.send('Config',packet); }
    function sendInputTarget(){ const l=[]; for(let i=1;i<=NUM_DI;i++) l.push(parseInt($('target-in'+i).value||'0',10)); const packet={t:'inputTarget',list:l}; logTx('Config',packet); conn.send('Config',packet); }
    for(let i=1;i<=NUM_DI;i++){
      $('enable-in'+i)?.addEventListener('change', sendInputEnable);
      $('invert-in'+i)?.addEventListener('change', sendInputInvert);
      $('action-in'+i)?.addEventListener('change', sendInputAction);
      $('target-in'+i)?.addEventListener('change', sendInputTarget);
    }

    function sendRelayCfg(){
      const l=[];
      for(let i=1;i<=NUM_RLY;i++){
        l.push({
          enabled:$('enable-relay'+i).checked,
          inverted:$('invert-relay'+i).checked
        });
      }
      const packet={t:'relays',list:l};
      logTx('Config',packet);
      conn.send('Config',packet);
    }
    for(let i=1;i<=NUM_RLY;i++){
      $('enable-relay'+i)?.addEventListener('change', sendRelayCfg);
      $('invert-relay'+i)?.addEventListener('change', sendRelayCfg);
    }

    function sendLedCfg(){
      const list=[];
      for(let i=1;i<=NUM_LED;i++){
        const m=parseInt(($('mode-led'+i)?.value||'0'),10);
        const s=parseInt(($('source-led'+i)?.value||'0'),10);
        list.push({mode: (Number.isFinite(m)?m:0), source: (Number.isFinite(s)?s:0)});
      }
      const packet={t:'leds', list};
      logTx('Config', packet);
      conn.send('Config', packet).catch(err=>log('Error','LED config failed: '+(err?.message||err)));
    }
    for(let i=1;i<=NUM_LED;i++){
      $('mode-led'+i)?.addEventListener('change', sendLedCfg);
      $('source-led'+i)?.addEventListener('change', sendLedCfg);
    }

    function sendBtnCfg(){
      const list=[];
      for(let i=1;i<=NUM_BTN;i++){
        const v=parseInt(($('action-button'+i)?.value||'0'),10);
        list.push(Number.isFinite(v)?v:0);
      }
      const packet={t:'buttons', list};
      logTx('Config', packet);
      conn.send('Config', packet).catch(err=>log('Error','Buttons config failed: '+(err?.message||err)));
    }
    for(let i=1;i<=NUM_BTN;i++){ $('action-button'+i)?.addEventListener('change', sendBtnCfg); }

    // Receive data from device
    conn.on('inputs', list=>{ markDataReceived(); toArray(list).forEach((v,i)=>{ const el=$('state-in'+(i+1)); if(el) el.className='state-dot '+(v?'dot-on':'dot-off'); }); });
    conn.on('enableList', list=>{ markDataReceived(); toArray(list).forEach((v,i)=>{ const el=$('enable-in'+(i+1)); if(el) el.checked=!!v; }); });
    conn.on('invertList', list=>{ markDataReceived(); toArray(list).forEach((v,i)=>{ const el=$('invert-in'+(i+1)); if(el) el.checked=!!v; }); });
    conn.on('inputActionList', list=>{ markDataReceived(); toArray(list).forEach((v,i)=>{ const el=$('action-in'+(i+1)); if(el && el!==document.activeElement) el.value=String(v||0); }); });
    conn.on('inputTargetList', list=>{ markDataReceived(); toArray(list).forEach((v,i)=>{ const el=$('target-in'+(i+1)); if(el && el!==document.activeElement) el.value=String(typeof v === 'number' ? v : 0); }); });

    conn.on('relayStateList', list=>{ markDataReceived(); toArray(list).forEach((v,i)=>{ const el=$('state-relay'+(i+1)); if(el) el.className='state-dot '+(v?'dot-on':'dot-off'); }); });
    conn.on('relayEnableList', list=>{ markDataReceived(); toArray(list).forEach((v,i)=>{ const el=$('enable-relay'+(i+1)); if(el) el.checked=!!v; }); });
    conn.on('relayInvertList', list=>{ markDataReceived(); toArray(list).forEach((v,i)=>{ const el=$('invert-relay'+(i+1)); if(el) el.checked=!!v; }); });

    conn.on('ButtonStateList', list=>{ markDataReceived(); toArray(list).forEach((v,i)=>{ const el=$('state-button'+(i+1)); if(el) el.className='state-dot '+(v?'dot-on':'dot-off'); }); });
    conn.on('ButtonGroupList', list=>{ markDataReceived(); toArray(list).forEach((v,i)=>{ const el=$('action-button'+(i+1)); if(el && el!==document.activeElement) el.value=String(v||0); }); });

    conn.on('LedConfigList', list=>{ markDataReceived(); toArray(list).forEach((obj,i)=>{ const m=$('mode-led'+(i+1)), s=$('source-led'+(i+1)); if(m && obj && typeof obj.mode !== 'undefined' && m!==document.activeElement) m.value=String(obj.mode); if(s && obj && typeof obj.source !== 'undefined' && s!==document.activeElement) s.value=String(obj.source); }); });
    conn.on('LedStateList', list=>{ markDataReceived(); toArray(list).forEach((v,i)=>{ const el=$('state-led'+(i+1)); if(el) el.className='state-dot '+(v?'dot-on':'dot-off'); }); });
  })();
  </script>
</section>
