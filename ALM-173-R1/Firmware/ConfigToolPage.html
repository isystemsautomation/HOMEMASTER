<section style="font-family:'Segoe UI',sans-serif;padding:2rem;max-width:960px;margin:auto;">
  <div style="text-align:center;margin-bottom:2rem;">
    <img src="https://www.home-master.eu/web/image/product.product/719/image_1024/ALM-173-R1%20Module%20for%20Alarm%20Systems?unique=f079b61" alt="ALM-173-R1" style="max-width:300px;border-radius:8px;" loading="lazy">
    <h2>ALM-173-R1 Module Configuration</h2>
    <p>Configure Modbus address, baud rate, inputs, relays, <strong>buttons</strong>, user LEDs, and <strong>alarm modes</strong> via Web Serial.</p>
  </div>

  <div style="background:#f1f1f1;padding:1rem 1.5rem;margin-bottom:2rem;border-radius:6px;border-left:4px solid #007bff;">
    <strong>Active Modbus Configuration</strong><br>
    Address: <span id="live-address" style="font-weight:600;">--</span> |
    Baud Rate: <span id="live-baud" style="font-weight:600;">--</span>
  </div>

  <form id="modbus-config" style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:2rem;">
    <div>
      <label for="modbus-address"><strong>Modbus Address</strong></label>
      <select id="modbus-address" style="width:100%;padding:10px;border-radius:4px;"></select>
    </div>
    <div>
      <label for="modbus-baud"><strong>Baud Rate</strong></label>
      <select id="modbus-baud" style="width:100%;padding:10px;border-radius:4px;">
        <option>9600</option><option>19200</option><option>38400</option><option>57600</option><option>115200</option>
      </select>
    </div>
    <div style="grid-column:span 2;text-align:right;">
      <button id="connect-button" type="button" style="padding:10px 20px;background:#007bff;color:#fff;border:none;border-radius:4px;">Connect</button>
    </div>
  </form>

  <div id="log-line" style="margin-bottom:1.5rem;padding:1rem;background:#f9f9f9;border:1px solid #ccc;border-radius:6px;font-size:0.9rem;color:#333;font-family:monospace;">
    <strong>Serial Log:</strong>
    <div id="log-content" style="white-space:pre-wrap;"></div>
  </div>
  
  <section style="margin-bottom:2rem;">
    <h2 style="font-size:1.2rem;">Alarm Status &amp; Modes</h2>

    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1rem;margin-bottom:1rem;">
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <strong>Any Alarm</strong>
        <span id="alarm-any" style="float:right;width:12px;height:12px;border-radius:50%;display:inline-block;background:#ccc;"></span>
      </div>
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <strong>Group 1</strong>
        <span id="alarm-g1" style="float:right;width:12px;height:12px;border-radius:50%;display:inline-block;background:#ccc;"></span>
      </div>
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <strong>Group 2</strong>
        <span id="alarm-g2" style="float:right;width:12px;height:12px;border-radius:50%;display:inline-block;background:#ccc;"></span>
      </div>
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <strong>Group 3</strong>
        <span id="alarm-g3" style="float:right;width:12px;height:12px;border-radius:50%;display:inline-block;background:#ccc;"></span>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;">
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <label for="alarm-mode-g1"><strong>Mode – Group 1</strong></label>
        <select id="alarm-mode-g1" style="width:100%;padding:10px;border-radius:4px;">
          <option value="0">None</option>
          <option value="1">Active while condition is active (non-latched)</option>
          <option value="2">Latched until acknowledged</option>
        </select>
      </div>
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <label for="alarm-mode-g2"><strong>Mode – Group 2</strong></label>
        <select id="alarm-mode-g2" style="width:100%;padding:10px;border-radius:4px;">
          <option value="0">None</option>
          <option value="1">Active while condition is active (non-latched)</option>
          <option value="2">Latched until acknowledged</option>
        </select>
      </div>
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <label for="alarm-mode-g3"><strong>Mode – Group 3</strong></label>
        <select id="alarm-mode-g3" style="width:100%;padding:10px;border-radius:4px;">
          <option value="0">None</option>
          <option value="1">Active while condition is active (non-latched)</option>
          <option value="2">Latched until acknowledged</option>
        </select>
      </div>
    </div>
  </section>

  <section>
    <h2 style="font-size:1.2rem;">Digital Inputs (17)</h2>
    <div id="inputs-config" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:1rem;"></div>
  </section>

  <section>
    <h2 style="font-size:1.2rem;">Relays (3)</h2>
    <div id="relays-config" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:1rem;"></div>
  </section>

  <section>
    <h2 style="font-size:1.2rem;">Buttons (4)</h2>
    <div id="buttons-config" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:1rem;"></div>
  </section>

  <section>
    <h2 style="font-size:1.2rem;">User LEDs (4)</h2>
    <div id="leds-config" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:1rem;"></div>
  </section>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
  <script src="https://unpkg.com/simple-web-serial@latest/dist/simple-web-serial.min.js"></script>

  <script>
    // -------- Utilities --------
    const LOG_MAX = 3;               // keep only the last 3 log messages
    const logBuffer = [];            // newest first

    function appendLog(label, data) {
      const logEl = document.getElementById("log-content");
      const time = new Date().toLocaleTimeString();
      const line = `[${time}] ${label}: ${typeof data === 'string' ? data : JSON.stringify(data)}`;
      logBuffer.unshift(line);
      if (logBuffer.length > LOG_MAX) logBuffer.pop();
      logEl.innerText = logBuffer.join('\n');
    }

    function setDot(id, active, onColor='#e53935') {
      const el = document.getElementById(id);
      if (el) el.style.background = active ? onColor : '#ccc';
    }

    // Fill Modbus address dropdown
    const addrSelect = document.getElementById('modbus-address');
    for (let i = 1; i <= 255; i++) {
      const opt = document.createElement('option'); opt.value = i; opt.textContent = i; addrSelect.appendChild(opt);
    }

    // WebSerial setup
    const connection = SimpleWebSerial.setupSerialConnection({
      requestAccessOnPageLoad: false,
      requestElement: 'connect-button'
    });

    connection.on('status', modbus => {
      document.getElementById('live-address').textContent = modbus.address ?? '--';
      document.getElementById('live-baud').textContent = modbus.baud ?? '--';
      if (modbus.address) document.getElementById('modbus-address').value = modbus.address;
      if (modbus.baud) document.getElementById('modbus-baud').value = String(modbus.baud);
    });
    connection.on('message', msg => appendLog("Arduino", msg));

    // Modbus values
    document.getElementById('modbus-address').addEventListener('input', updateModbus);
    document.getElementById('modbus-baud').addEventListener('input', updateModbus);
    async function updateModbus() {
      const mb_address = parseInt(document.getElementById('modbus-address').value || "1");
      const mb_baud = parseInt(document.getElementById('modbus-baud').value || "19200");
      await connection.send("values", { mb_address, mb_baud });
    }

    // ===== Alarm: send/receive via unified channel =====
    const amEls = [
      document.getElementById('alarm-mode-g1'),
      document.getElementById('alarm-mode-g2'),
      document.getElementById('alarm-mode-g3')
    ];
    amEls.forEach(el => el.addEventListener('change', sendAlarmModes));
    async function sendAlarmModes() {
      const list = amEls.map(el => parseInt(el.value || "0"));
      await connection.send("Config", { t: "alarms", list });
    }
    connection.on('AlarmModeList', list => {
      if (!Array.isArray(list)) return;
      list.slice(0,3).forEach((v,i) => { if (typeof v !== 'undefined' && amEls[i]) amEls[i].value = String(v); });
    });
    connection.on('AlarmState', obj => {
      if (!obj) return;
      setDot('alarm-any', !!obj.any);
      const groups = Array.isArray(obj.groups) ? obj.groups : [];
      setDot('alarm-g1', !!groups[0]);
      setDot('alarm-g2', !!groups[1]);
      setDot('alarm-g3', !!groups[2]);
    });

    // ===== Build Inputs UI =====
    const inputsContainer = document.getElementById('inputs-config');
    for (let i = 1; i <= 17; i++) {
      const div = document.createElement('div');
      div.innerHTML = `
        <div style="border:1px solid #ccc;border-radius:6px;background:#e6f7e8;padding:1rem;">
          <div style="display:flex;justify-content:space-between;font-weight:600;">
            IN${i}
            <span id="state-in${i}" style="width:12px;height:12px;background:#ccc;border-radius:50%;display:inline-block;"></span>
          </div>
          <label><input type="checkbox" id="enable-in${i}"> Enabled</label><br>
          <label><input type="checkbox" id="invert-in${i}"> Inverted</label><br>
          <label>Alarm Group:
            <select id="group-in${i}" style="width:100%;padding:6px;border-radius:4px;">
              <option value="0">None</option><option value="1">Group 1</option><option value="2">Group 2</option><option value="3">Group 3</option>
            </select>
          </label>
        </div>`;
      inputsContainer.appendChild(div);
    }

    // ===== Build Relays UI =====
    const relaysContainer = document.getElementById('relays-config');
    for (let i = 1; i <= 3; i++) {
      const div = document.createElement('div');
      div.innerHTML = `
        <div style="border:1px solid #ccc;border-radius:6px;background:#f1f1f1;padding:1rem;">
          <div style="font-weight:600;">
            Relay ${i}
            <span style="float:right;">
              <input type="checkbox" id="state-relay${i}" disabled>
            </span>
          </div>
          <label><input type="checkbox" id="enable-relay${i}"> Enabled</label><br>
          <label><input type="checkbox" id="invert-relay${i}"> Inverted</label><br>
          <label>Alarm Group:
            <select id="group-relay${i}" style="width:100%;padding:6px;border-radius:4px;">
              <option value="0">None</option><option value="1">Group 1</option><option value="2">Group 2</option><option value="3">Group 3</option>
            </select>
          </label>
        </div>`;
      relaysContainer.appendChild(div);
    }

    // ===== Build Buttons UI (uses unified channel) =====
    const buttonsContainer = document.getElementById('buttons-config');
    const BUTTON_ACTIONS = [
      {value:0,label:'None'},
      {value:1,label:'All alarm acknowledge'},
      {value:2,label:'Alarm group 1 acknowledge'},
      {value:3,label:'Alarm group 2 acknowledge'},
      {value:4,label:'Alarm group 3 acknowledge'},
      {value:5,label:'Relay 1 override (manual)'},
      {value:6,label:'Relay 2 override (manual)'},
      {value:7,label:'Relay 3 override (manual)'},
    ];
    for (let i = 1; i <= 4; i++) {
      const options = BUTTON_ACTIONS.map(a => `<option value="${a.value}">${a.label}</option>`).join('');
      const div = document.createElement('div');
      div.innerHTML = `
        <div style="border:1px solid #ccc;border-radius:6px;background:#cbdcf7;padding:1rem;">
          <div style="font-weight:600;">
            Button ${i}
            <span id="state-button${i}" style="width:12px;height:12px;background:#ccc;border-radius:50%;display:inline-block;float:right;"></span>
          </div>
          <label>Action:
            <select id="action-button${i}" style="width:100%;padding:6px;border-radius:4px;">
              ${options}
            </select>
          </label>
        </div>`;
      buttonsContainer.appendChild(div);
    }

    // ===== Build LEDs UI =====
    const ledsContainer = document.getElementById('leds-config');
    const LED_MODE = [
      {value:0,label:'Steady (when active)'},
      {value:1,label:'Blink (when active)'},
    ];
    const LED_SOURCE = [
      {value:0,label:'None'},
      {value:1,label:'Any alarm'},
      {value:2,label:'Alarm group 1'},
      {value:3,label:'Alarm group 2'},
      {value:4,label:'Alarm group 3'},
      {value:5,label:'Relay 1 overridden'},
      {value:6,label:'Relay 2 overridden'},
      {value:7,label:'Relay 3 overridden'},
    ];
    for (let i = 1; i <= 4; i++) {
      const modeOpts = LED_MODE.map(a => `<option value="${a.value}">${a.label}</option>`).join('');
      const srcOpts  = LED_SOURCE.map(a => `<option value="${a.value}">${a.label}</option>`).join('');
      const div = document.createElement('div');
      div.innerHTML = `
        <div style="border:1px solid #ccc;border-radius:6px;background:#f3f5d0;padding:1rem;">
          <div style="font-weight:600;">
            User LED ${i}
            <span id="state-led${i}" style="width:12px;height:12px;background:#ccc;border-radius:50%;display:inline-block;float:right;"></span>
          </div>
          <label>Mode:
            <select id="mode-led${i}" style="width:100%;padding:6px;border-radius:4px;">${modeOpts}</select>
          </label><br>
          <label>Trigger source:
            <select id="source-led${i}" style="width:100%;padding:6px;border-radius:4px;">${srcOpts}</select>
          </label>
        </div>`;
      ledsContainer.appendChild(div);
    }

    // ===== RECEIVE: Inputs =====
    connection.on('inputs', list => {
      list.forEach((v, i) => {
        const dot = document.getElementById(`state-in${i+1}`);
        if (dot) dot.style.background = v ? '#4caf50' : '#ccc';
      });
    });
    connection.on('enableList', list => list.forEach((v,i) => {
      const el = document.getElementById(`enable-in${i+1}`); if (el) el.checked = !!v;
    }));
    connection.on('invertList', list => list.forEach((v,i) => {
      const el = document.getElementById(`invert-in${i+1}`); if (el) el.checked = !!v;
    }));
    connection.on('groupList', list => list.forEach((v,i) => {
      const el = document.getElementById(`group-in${i+1}`); if (el) el.value = String(v || 0);
    }));

    // ===== RECEIVE: Relays =====
    connection.on('relayStateList', list => list.forEach((v,i) => {
      const el = document.getElementById(`state-relay${i+1}`); if (el) el.checked = !!v;
    }));
    connection.on('relayEnableList', list => list.forEach((v,i) => {
      const el = document.getElementById(`enable-relay${i+1}`); if (el) el.checked = !!v;
    }));
    connection.on('relayInvertList', list => list.forEach((v,i) => {
      const el = document.getElementById(`invert-relay${i+1}`); if (el) el.checked = !!v;
    }));
    connection.on('relayGroupList', list => list.forEach((v,i) => {
      const el = document.getElementById(`group-relay${i+1}`); if (el) el.value = String(v || 0);
    }));

    // ===== RECEIVE: Buttons =====
    connection.on('ButtonStateList', list => list.forEach((v,i) => {
      const dot = document.getElementById(`state-button${i+1}`);
      if (dot) dot.style.background = v ? '#4caf50' : '#ccc';
    }));
    connection.on('ButtonGroupList', list => list.forEach((v,i) => {
      const el = document.getElementById(`action-button${i+1}`);
      if (el) el.value = String(v || 0);
    }));

    // ===== RECEIVE: LEDs =====
    connection.on('LedConfigList', list => list.forEach((obj,i) => {
      const modeEl = document.getElementById(`mode-led${i+1}`);
      const srcEl  = document.getElementById(`source-led${i+1}`);
      if (modeEl && typeof obj?.mode !== 'undefined') modeEl.value = String(obj.mode);
      if (srcEl  && typeof obj?.source !== 'undefined') srcEl.value = String(obj.source);
    }));
    connection.on('LedStateList', list => list.forEach((v,i) => {
      const dot = document.getElementById(`state-led${i+1}`);
      if (dot) dot.style.background = v ? '#ffb300' : '#ccc';
    }));

    // ===== CHANGE HANDLERS -> unified sends =====
    for (let i = 1; i <= 17; i++) {
      document.getElementById(`enable-in${i}`).addEventListener('change', sendInputEnable);
      document.getElementById(`invert-in${i}`).addEventListener('change', sendInputInvert);
      document.getElementById(`group-in${i}`).addEventListener('change',  sendInputGroup);
    }
    for (let i = 1; i <= 3; i++) {
      document.getElementById(`enable-relay${i}`).addEventListener('change', sendRelayConfig);
      document.getElementById(`invert-relay${i}`).addEventListener('change', sendRelayConfig);
      document.getElementById(`group-relay${i}`).addEventListener('change',  sendRelayConfig);
    }
    for (let i = 1; i <= 4; i++) {
      document.getElementById(`action-button${i}`).addEventListener('change', sendButtonConfig);
      document.getElementById(`mode-led${i}`).addEventListener('change',    sendLedConfig);
      document.getElementById(`source-led${i}`).addEventListener('change',  sendLedConfig);
    }

    // ===== Unified senders =====
    async function sendInputEnable() {
      const list = [];
      for (let i = 1; i <= 17; i++) list.push(!!document.getElementById(`enable-in${i}`).checked);
      await connection.send("Config", { t: "inputEnable", list });
    }
    async function sendInputInvert() {
      const list = [];
      for (let i = 1; i <= 17; i++) list.push(!!document.getElementById(`invert-in${i}`).checked);
      await connection.send("Config", { t: "inputInvert", list });
    }
    async function sendInputGroup() {
      const list = [];
      for (let i = 1; i <= 17; i++) list.push(parseInt(document.getElementById(`group-in${i}`).value || "0"));
      await connection.send("Config", { t: "inputGroup", list });
    }
    async function sendRelayConfig() {
      const list = [];
      for (let i = 1; i <= 3; i++) {
        list.push({
          enabled:  document.getElementById(`enable-relay${i}`).checked,
          inverted: document.getElementById(`invert-relay${i}`).checked,
          group:    parseInt(document.getElementById(`group-relay${i}`).value || "0")
        });
      }
      await connection.send("Config", { t: "relays", list });
    }
    async function sendButtonConfig() {
      const list = [];
      for (let i = 1; i <= 4; i++) list.push({ action: parseInt(document.getElementById(`action-button${i}`).value || "0") });
      await connection.send("Config", { t: "buttons", list });
    }
    async function sendLedConfig() {
      const list = [];
      for (let i = 1; i <= 4; i++) {
        list.push({
          mode:   parseInt(document.getElementById(`mode-led${i}`).value || "0"),
          source: parseInt(document.getElementById(`source-led${i}`).value || "0")
        });
      }
      await connection.send("Config", { t: "leds", list });
    }
  </script>
</section>