<section style="font-family:'Segoe UI',sans-serif;padding:2rem;max-width:1200px;margin:auto;">
  <style>
    .enm-input{padding:6px 8px;border:1px solid #ccc;border-radius:4px;width:100%;box-sizing:border-box}
    .al-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:1rem}
    .al-card{border:1px solid #ddd;border-radius:8px;padding:1rem;background:#fff}
    .al-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
    .al-led{width:10px;height:10px;border-radius:50%;background:#ccc;display:inline-block}
    .al-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:.25rem 0}
    .al-row .lbl{flex:0 0 70px;font-weight:600}
    .al-row .en{flex:0 0 110px;display:flex;align-items:center;gap:.4rem}
    .al-row .metric{flex:1 1 220px;min-width:180px}
    .al-row .min,.al-row .max{flex:1 1 160px;min-width:140px}
    .al-hint{color:#666;font-size:.85rem;margin-top:-.15rem}
    #relays-config{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:1rem}
    .rly-card{border:1px solid #ccc;border-radius:8px;background:#f8f9fa;padding:1rem}
    .rly-row{display:flex;gap:.5rem;align-items:center;margin:.35rem 0;flex-wrap:wrap}
    .rly-row label{margin-right:.35rem}
    .rly-alarm{border:1px dashed #ccc;border-radius:6px;padding:.5rem .75rem;background:#fff}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.75rem;background:#e9ecef}
    @media (max-width:900px){.al-grid,#relays-config{grid-template-columns:1fr}}
    @media (max-width:560px){.al-row .lbl{flex:1 1 100%;order:-1}}
    .lock-badge{font-size:.75rem;color:#0d6efd;margin-left:.35rem;display:none}
    .locked+.lock-badge{display:inline}

    /* Calibration cards */
    .cal-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:1rem}
    .cal-card{border:1px solid #ddd;border-radius:8px;background:#fff;padding:1rem}
    .cal-row{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
    @media (max-width:1000px){.cal-grid{grid-template-columns:1fr}}

    /* Live cards */
    .card{border:1px solid #ddd;border-radius:8px;background:#fff;padding:1rem}
    .kv{display:grid;grid-template-columns:1fr auto;gap:.35rem .75rem;font-size:.95rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:1rem}
    .energy-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:1rem}
    .muted{color:#666}

    /* small UX additions */
    .toast{position:fixed;right:18px;bottom:18px;max-width:420px;background:#111827;color:#fff;
      padding:10px 12px;border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,.18);opacity:0;
      transform:translateY(8px);transition:.2s;z-index:99999;font-size:.9rem}
    .toast.show{opacity:1;transform:translateY(0)}
    .badge{display:inline-block;font-size:.75rem;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3}

    /* RAW tables */
    .raw-wrap{background:#f7f7f7;padding:1rem 1.5rem;margin-top:1.25rem;border-radius:8px;border-left:4px solid #6c757d;}
    .raw-box{background:#fff;border:1px solid #e6e6e6;border-radius:8px;overflow:hidden;}
    .raw-head{padding:.6rem .8rem;border-bottom:1px solid #eee;font-weight:600;display:flex;justify-content:space-between;gap:1rem;align-items:center;flex-wrap:wrap;}
    .raw-scroll{overflow:auto;max-height:420px;}
    .raw-table{width:100%;border-collapse:collapse;font-size:.92rem;}
    .raw-table thead{position:sticky;top:0;background:#fafafa;border-bottom:1px solid #eee;}
    .raw-table th{ text-align:left;padding:.45rem .6rem; }
    .raw-table td{ padding:.42rem .6rem; border-bottom:1px solid #f0f0f0; }
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;}
    .raw-changed{background:#fff3cd;}

    /* ChipCfg */
    .chipcfg-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;margin-top:1rem}
    .chipcfg-card{border:1px solid #e6e6e6;border-radius:10px;background:#fff;padding:1rem}
    .chipcfg-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
    .chipcfg-mini{font-size:.85rem;color:#6b7280}
    .chipcfg-kv{display:grid;grid-template-columns:1fr auto;gap:.35rem .75rem}
  </style>

  <div style="text-align:center;margin-bottom:2rem;">
    <h2 style="margin:.5rem 0 0;">ENM-223-R1 Module Configuration</h2>
    <p style="margin:.25rem 0 0;color:#333;">
      Live config every 1s from device. Edit a field and press <b>Enter</b> to send.
      While editing, that field won’t auto-update.
      <span id="conn-pill" class="badge" style="margin-left:.5rem;display:none">connected</span>
    </p>
  </div>

  <div style="background:#f1f1f1;padding:1rem 1.5rem;margin-bottom:1.25rem;border-radius:6px;border-left:4px solid #007bff;">
    <strong>Active Modbus Configuration</strong><br>
    Address: <span id="live-address" style="font-weight:600;">--</span> |
    Baud Rate: <span id="live-baud" style="font-weight:600;">--</span>
  </div>

  <form id="modbus-config" style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:.75rem;">
    <div><label><strong>Modbus Address</strong></label><select id="modbus-address" class="enm-input"></select></div>
    <div>
      <label><strong>Baud Rate</strong></label>
      <select id="modbus-baud" class="enm-input">
        <option>9600</option><option selected="">19200</option><option>38400</option><option>57600</option><option>115200</option>
      </select>
    </div>
    <div style="grid-column:span 2;display:flex;justify-content:flex-end;gap:.5rem;flex-wrap:wrap">
      <button id="connect-button" type="button" style="padding:10px 20px;background:#007bff;color:#fff;border:none;border-radius:4px;">Connect</button>
      <button id="req-sync" type="button" style="padding:10px 14px;background:#6c757d;color:#fff;border:none;border-radius:6px;">Request Sync</button>
    </div>
  </form>

  <div id="log-line" style="margin-bottom:1.25rem;padding:1rem;background:#f9f9f9;border:1px solid #ccc;border-radius:6px;font-size:0.9rem;color:#333;">
    <strong>Serial Log:</strong>
    <pre id="log-content" style="white-space:pre-wrap;font-family:monospace;line-height:1.25em;margin:0;margin-top:.5rem;height:calc(1.25em * 6);overflow-y:auto;background:#fff;border:1px solid #e5e5e5;border-radius:4px;padding:.5rem;"></pre>
  </div>

  <section style="margin-bottom:1.25rem;">
    <h2 style="font-size:1.2rem;margin-bottom:.75rem;">Meter Options</h2>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1rem;">
      <div>
        <label><strong>Line Frequency (Hz)</strong></label>
        <select id="opt-lineHz" class="enm-input">
          <option value="50" selected="">50</option><option value="60">60</option>
        </select>
      </div>
      <div>
        <label><strong>Sum Mode</strong> <small class="muted">(0=alg, 1=abs)</small></label>
        <select id="opt-sumAbs" class="enm-input">
          <option value="0">0</option><option value="1" selected="">1</option>
        </select>
      </div>
      <div>
        <label><strong>Sample Interval (ms)</strong></label>
        <input id="opt-samplems" type="number" min="10" max="5000" step="10" value="200" class="enm-input">
        <small class="lock-badge">editing… press Enter to send</small>
      </div>
    </div>
    <div class="muted" style="margin-top:.4rem;font-size:.9rem">
      Note: <b>Ucal removed</b>. Sag reference is derived from Phase-A <b>Ugain</b>.
    </div>
  </section>

  <section style="margin-bottom:1.25rem;">
    <h2 style="font-size:1.2rem;margin-bottom:.75rem;">Calibration (Phase A / B / C)</h2>
    <div id="calib-grid" class="cal-grid"></div>
    <div class="muted" style="margin-top:.5rem;font-size:.9rem;">
      Gains: 0..65535. Offsets: <b>-32768..32767</b>. Press <b>Enter</b> in a field to send. While editing, live refresh is paused for that field.
    </div>
  </section>

  <section style="margin-bottom:1.25rem;">
    <h2 style="font-size:1.2rem;margin-bottom:.75rem;">Alarms (L1, L2, L3, Totals)</h2>
    <div id="alarms-grid" class="al-grid"></div>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap;justify-content:flex-end;margin-top:.5rem;">
      <button id="ack-all" type="button" style="padding:8px 14px;background:#198754;color:#fff;border:none;border-radius:6px;">Ack All</button>
    </div>
  </section>

  <section style="margin-bottom:1.25rem;">
    <h2 style="font-size:1.2rem;margin-bottom:.75rem;">Relays (2)</h2>
    <div id="relays-config"></div>
  </section>

  <section style="margin-bottom:.75rem;">
    <h2 style="font-size:1.2rem;margin-bottom:.75rem;">Live Meter</h2>
    <div id="chan-grid" class="grid"></div>
  </section>

  <section style="margin-bottom:1.25rem;">
    <h3 style="font-size:1.1rem;margin-bottom:.5rem;">Energies</h3>
    <div id="energy-grid" class="energy-grid"></div>
    <div class="muted" style="margin-top:.3rem">Chip-sourced counters. Units: kWh / kvarh / kVAh.</div>
  </section>

  <!-- ================== ATM CHIP CONFIG (REAL READBACK) ================== -->
  <div class="raw-wrap">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
      <div>
        <strong>ATM90E32 Chip Config (Readback)</strong><br>
        <span class="muted" style="font-size:.9rem;">
          These values come from <b>reading</b> the ATM registers (calibration + key config). This is what is actually stored in the chip.
        </span>
      </div>
      <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;">
        <label style="font-size:.9rem;color:#444;">
          <input id="raw-show-hex" type="checkbox" checked style="transform:translateY(1px);"> show HEX
        </label>
        <label style="font-size:.9rem;color:#444;">
          <input id="raw-freeze" type="checkbox" style="transform:translateY(1px);"> freeze
        </label>
        <span style="font-size:.9rem;color:#444;">
          Updated: <span id="raw-last-ts" style="font-weight:600;">--</span>
        </span>
      </div>
    </div>

    <div id="chipcfg-grid" class="chipcfg-grid"></div>

    <div class="raw-box" style="margin-top:1rem;">
      <div class="raw-head">
        <span>ATM_RawReads</span>
        <span class="pill">reads</span>
      </div>
      <div class="raw-scroll">
        <table class="raw-table">
          <thead>
            <tr>
              <th>Reg</th><th>Name</th><th style="text-align:right;">Value</th>
            </tr>
          </thead>
          <tbody id="raw-reads-body"></tbody>
        </table>
      </div>
    </div>

    <div class="muted" style="margin-top:.75rem;font-size:.85rem;">
      Tip: change <b>Calibration</b> or <b>Meter Options</b> and watch the <b>readback</b> values update (chip-stored).
    </div>
  </div>

  <section style="margin-bottom:1.25rem;margin-top:1.25rem;">
    <h2 style="font-size:1.2rem;margin-bottom:.75rem;">Buttons (4)</h2>
    <div id="buttons-config" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:1rem;"></div>
  </section>

  <section style="margin-bottom:1.25rem;">
    <h2 style="font-size:1.2rem;margin-bottom:.75rem;">User LEDs (4)</h2>
    <div id="leds-config" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:1rem;"></div>
    <div class="muted" style="margin-top:.5rem;font-size:.9rem;">
      Tip: set a LED source to <b>Override R1</b> or <b>Override R2</b> to light when a relay is in button override mode.
    </div>
  </section>

  <div id="toast" class="toast"></div>
</section>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
<script src="https://unpkg.com/simple-web-serial@latest/dist/simple-web-serial.min.js"></script>

<script>
(function(){
  /* ===== Helpers ===== */
  const $ = id => document.getElementById(id);
  const LOG_MAX=300, logBuffer=[];
  function appendLog(label,data){
    const el=$("log-content"); if(!el) return;
    const time=new Date().toLocaleTimeString();
    let body=(typeof data==='string')?data:JSON.stringify(data);
    body=String(body).replace(/\r\n?|\n/g,'\n').replace(/\\r\\n|\\r|\\n/g,'\n');
    logBuffer.push(`[${time}] ${label}: ${body}`);
    if(logBuffer.length>LOG_MAX) logBuffer.shift();
    el.textContent=logBuffer.join('\n'); el.scrollTop=el.scrollHeight;
  }
  function toast(msg, ms=1600){
    const t=$('toast'); if(!t) return;
    t.textContent=msg;
    t.classList.add('show');
    clearTimeout(toast._tm);
    toast._tm=setTimeout(()=>t.classList.remove('show'), ms);
  }

  /* ===== Serial connection ===== */
  const connection = SimpleWebSerial.setupSerialConnection({
    requestAccessOnPageLoad:false,
    requestElement:'connect-button'
  });

  connection.on('open', ()=>{
    appendLog('port','open');
    const pill=$('conn-pill'); if(pill){ pill.style.display='inline-block'; pill.textContent='connected'; }
    toast('Connected');
    appendLog('sync','waiting for 1Hz pushes…');
  });

  connection.on('close', ()=>{
    appendLog('port','close');
    const pill=$('conn-pill'); if(pill){ pill.style.display='none'; }
    toast('Disconnected');
  });

  connection.on('message', (m)=>appendLog('log', m));

  /* ===== Field lock system ===== */
  const locked = new Set();
  function attachLockHandlers(input, key, sendFn){
    if(!input) return;
    input.setAttribute('data-lock-key', key);
    const hint = input.nextElementSibling && input.nextElementSibling.classList.contains('lock-badge') ? input.nextElementSibling : null;
    const lock=()=>{ locked.add(key); input.classList.add('locked'); if(hint) hint.style.display='inline'; };
    const unlock=()=>{ locked.delete(key); input.classList.remove('locked'); if(hint) hint.style.display='none'; };
    input.addEventListener('focus', lock);
    input.addEventListener('input', lock);
    input.addEventListener('keydown', (ev)=>{
      if(ev.key==='Enter'){ ev.preventDefault(); if(typeof sendFn==='function') sendFn(); unlock(); toast('Sent'); }
      else if(ev.key==='Escape'){ ev.preventDefault(); unlock(); toast('Unlocked'); }
    });
  }
  const canApply = (key)=>!locked.has(key);

  /* ===== Populate Modbus address select ===== */
  (function populateAddresses(){
    const sel=$('modbus-address'); if(!sel) return; sel.innerHTML='';
    for(let i=1;i<=255;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; sel.appendChild(o); }
    sel.value='3';
  })();

  /* ===== Build Live Meter cards ===== */
  (function buildChannelCards(){
    const grid=$('chan-grid'); if(!grid) return; grid.innerHTML='';
    const labels=['L1','L2','L3','Totals'];
    for(let ch=0; ch<4; ch++){
      const card=document.createElement('div'); card.className='card';
      const hdrBadge = ch===3?'<span class="pill">totals</span>':'';
      const bodyPhase =
        ` <div>U (V)</div><div id="u${ch}" style="text-align:right">--</div>
          <div>I (A)</div><div id="i${ch}" style="text-align:right">--</div>
          <div>P (W)</div><div id="p${ch}" style="text-align:right">--</div>
          <div>Q (var)</div><div id="q${ch}" style="text-align:right">--</div>
          <div>S (VA)</div><div id="s${ch}" style="text-align:right">--</div>
          <div>PF</div><div id="pf${ch}" style="text-align:right">--</div>
          <div>Angle (°)</div><div id="ang${ch}" style="text-align:right">--</div>`;
      const bodyTotals =
        ` <div>P (W)</div><div id="p3" style="text-align:right">--</div>
          <div>Q (var)</div><div id="q3" style="text-align:right">--</div>
          <div>S (VA)</div><div id="s3" style="text-align:right">--</div>
          <div>PF (tot)</div><div id="pft" style="text-align:right">--</div>
          <div>Freq (Hz)</div><div id="f" style="text-align:right">--</div>
          <div>Temp (°C)</div><div id="t" style="text-align:right">--</div>`;
      card.innerHTML =
        `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;">
           <strong>${labels[ch]}</strong>${hdrBadge}
         </div>
         <div class="kv">
           ${ch<3 ? bodyPhase : bodyTotals}
         </div>`;
      grid.appendChild(card);
    }
  })();

  /* ===== Energy cards ===== */
  (function buildEnergyCards(){
    const grid=$('energy-grid'); if(!grid) return; grid.innerHTML='';
    const labels=['Phase A','Phase B','Phase C','Totals'];
    for(let i=0;i<4;i++){
      const card=document.createElement('div'); card.className='card';
      card.innerHTML =
        `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;">
          <strong>${labels[i]}</strong>
        </div>
        <div class="kv">
          <div>Active + (kWh)</div><div id="e-ap-${i}" style="text-align:right">--</div>
          <div>Active − (kWh)</div><div id="e-an-${i}" style="text-align:right">--</div>
          <div>Reactive + (kvarh)</div><div id="e-rp-${i}" style="text-align:right">--</div>
          <div>Reactive − (kvarh)</div><div id="e-rn-${i}" style="text-align:right">--</div>
          <div>Apparent (kVAh)</div><div id="e-s-${i}" style="text-align:right">--</div>
        </div>`;
      grid.appendChild(card);
    }
  })();

  /* ===== Calibration UI ===== */
  function buildCalibrationUI(){
    const grid=$('calib-grid'); if(!grid) return; grid.innerHTML='';
    const PH=['A','B','C'];
    for(let ch=0; ch<3; ch++){
      const card=document.createElement('div'); card.className='cal-card';
      card.innerHTML =
        `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;">
          <strong>Phase ${PH[ch]}</strong>
          <span class="chipcfg-mini">Press Enter to write → chip readback updates</span>
        </div>
        <div class="cal-row">
          <div>
            <label><strong>Ugain</strong></label>
            <input id="cal-ugain-${ch}" class="enm-input" type="number" min="0" max="65535" step="1" placeholder="0..65535">
            <small class="lock-badge">editing… Enter</small>
          </div>
          <div>
            <label><strong>Igain</strong></label>
            <input id="cal-igain-${ch}" class="enm-input" type="number" min="0" max="65535" step="1" placeholder="0..65535">
            <small class="lock-badge">editing… Enter</small>
          </div>
        </div>
        <div class="cal-row" style="margin-top:.5rem">
          <div>
            <label><strong>Uoffset</strong> <span class="muted">(signed)</span></label>
            <input id="cal-uoff-${ch}" class="enm-input" type="number" min="-32768" max="32767" step="1" placeholder="-32768..32767">
            <small class="lock-badge">editing… Enter</small>
          </div>
          <div>
            <label><strong>Ioffset</strong> <span class="muted">(signed)</span></label>
            <input id="cal-ioff-${ch}" class="enm-input" type="number" min="-32768" max="32767" step="1" placeholder="-32768..32767">
            <small class="lock-badge">editing… Enter</small>
          </div>
        </div>`;
      grid.appendChild(card);

      const sendCh=()=>sendCalibCh(ch);
      attachLockHandlers($('cal-ugain-'+ch), 'cal-ugain-'+ch, sendCh);
      attachLockHandlers($('cal-igain-'+ch), 'cal-igain-'+ch, sendCh);
      attachLockHandlers($('cal-uoff-'+ch),  'cal-uoff-'+ch,  sendCh);
      attachLockHandlers($('cal-ioff-'+ch),  'cal-ioff-'+ch,  sendCh);
    }
  }
  buildCalibrationUI();

  function collectCalibCh(ch){
    const ug=+$('cal-ugain-'+ch)?.value || 0;
    const ig=+$('cal-igain-'+ch)?.value || 0;
    const uo=+$('cal-uoff-'+ch )?.value || 0;
    const io=+$('cal-ioff-'+ch )?.value || 0;
    return { Ug: ug, Ig: ig, Uo: uo, Io: io };
  }
  function sendCalibCh(ch){
    const cfg=collectCalibCh(ch);
    connection.send("CalibCfg",{ ph: ch, cfg });
    appendLog("CalibCfg",{ ph: ch, cfg });
  }
  function applyCalibCh(ch, obj){
    if(!obj || typeof obj!=='object') return;
    const Ug = (obj.Ug ?? obj.Ugain);
    const Ig = (obj.Ig ?? obj.Igain);
    const Uo = (obj.Uo ?? obj.Uoffset);
    const Io = (obj.Io ?? obj.Ioffset);
    if(Ug !== undefined && canApply('cal-ugain-'+ch)) $('cal-ugain-'+ch).value = String(Ug);
    if(Ig !== undefined && canApply('cal-igain-'+ch)) $('cal-igain-'+ch).value = String(Ig);
    if(Uo !== undefined && canApply('cal-uoff-'+ch))  $('cal-uoff-'+ch).value  = String(Uo);
    if(Io !== undefined && canApply('cal-ioff-'+ch))  $('cal-ioff-'+ch).value  = String(Io);
  }

  /* ===== Alarms UI ===== */
  const AK_LABELS=['Alarm','Warning','Event'];
  const CH_LABELS=['L1','L2','L3','Totals'];
  const METRICS=[
    {v:0,l:'Voltage (Urms)', hint:'Urms (0.01 V)'},
    {v:1,l:'Current (Irms)', hint:'Irms (0.001 A)'},
    {v:2,l:'Active power P', hint:'W'},
    {v:3,l:'Reactive power Q', hint:'var'},
    {v:4,l:'Apparent power S', hint:'VA'},
    {v:5,l:'Frequency', hint:'0.01 Hz'}
  ];
  function metricOptionsHTML(sel){ return METRICS.map(m=>`<option value="${m.v}" ${String(sel)==String(m.v)?'selected':''}>${m.l}</option>`).join(''); }
  function unitForMetric(m){ return ({0:'V',1:'A',2:'W',3:'var',4:'VA',5:'Hz'}[+m]||''); }

  function buildAlarmsUI(){
    const grid=$('alarms-grid'); if(!grid) return; grid.innerHTML='';
    for(let ch=0; ch<4; ch++){
      const card=document.createElement('div'); card.className='al-card';
      const rows = AK_LABELS.map((lbl, ak)=>{
        const metricSelId='al-met-'+ch+'-'+ak;
        return `
          <div class="al-row">
            <div class="lbl">${lbl}</div>
            <label class="en"><input type="checkbox" id="al-en-${ch}-${ak}"> <span>Enabled</span></label>
            <div class="metric"><select id="${metricSelId}" class="enm-input">${metricOptionsHTML(4)}</select></div>
            <div class="min"><input id="al-min-${ch}-${ak}" type="number" step="1" placeholder="min" class="enm-input"><small class="lock-badge">editing… Enter</small></div>
            <div class="max"><input id="al-max-${ch}-${ak}" type="number" step="1" placeholder="max" class="enm-input"><small class="lock-badge">editing… Enter</small></div>
          </div>
          <div id="al-hint-${ch}-${ak}" class="al-hint"></div>`;
      }).join('');
      card.innerHTML =
        `<div class="al-top">
          <div><strong>${CH_LABELS[ch]}</strong></div>
          <div style="display:flex;gap:.3rem;align-items:center;">
            <span id="al-led-${ch}-0" class="al-led" title="Alarm"></span>
            <span id="al-led-${ch}-1" class="al-led" title="Warning"></span>
            <span id="al-led-${ch}-2" class="al-led" title="Event"></span>
          </div>
        </div>
        <label style="display:flex;align-items:center;gap:.4rem;margin-bottom:.5rem;"><input type="checkbox" id="al-ackreq-${ch}"> <span> Ack required</span></label>
        <div style="border-top:1px dashed #ddd;margin:.5rem 0;"></div>
        ${rows}
        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.6rem;">
          <button type="button" id="al-ack-${ch}" style="padding:6px 10px;background:#198754;border:none;border-radius:6px;color:#fff;">Ack ${CH_LABELS[ch]}</button>
        </div>`;
      grid.appendChild(card);
    }

    for(let ch=0; ch<4; ch++){
      for(let ak=0; ak<3; ak++){
        const s=$('al-met-'+ch+'-'+ak);
        const upd=()=>{
          const m=s?s.value:4, unit=unitForMetric(m);
          const meta=METRICS.find(x=>String(x.v)==String(m));
          const mn=$('al-min-'+ch+'-'+ak), mx=$('al-max-'+ch+'-'+ak), h=$('al-hint-'+ch+'-'+ak);
          if(mn) mn.placeholder='min '+unit;
          if(mx) mx.placeholder='max '+unit;
          if(h)  h.textContent='Metric: '+(meta?.l||'')+' — '+(meta?.hint||'')+'.';
        };
        if(s){ s.addEventListener('change', ()=>{ sendChannelCfg(ch); upd(); }); upd(); }

        const sendFn=()=>sendChannelCfg(ch);
        attachLockHandlers($('al-min-'+ch+'-'+ak), `al-min-${ch}-${ak}`, sendFn);
        attachLockHandlers($('al-max-'+ch+'-'+ak), `al-max-${ch}-${ak}`, sendFn);

        const en=$('al-en-'+ch+'-'+ak); if(en){ en.addEventListener('change', ()=>sendChannelCfg(ch)); }
      }
      const ackReq=$('al-ackreq-'+ch); if(ackReq){ ackReq.addEventListener('change', ()=>sendChannelCfg(ch)); }
      const ackBtn=$('al-ack-'+ch);   if(ackBtn){ ackBtn.addEventListener('click', ()=>{ connection.send("AlarmsAck",{ch}); appendLog("AlarmsAck",{ch}); toast('Ack '+CH_LABELS[ch]); }); }
    }
  }
  buildAlarmsUI();

  function collectChannelCfg(ch){
    const chO={ ack: !!$('al-ackreq-'+ch)?.checked };
    for(let ak=0; ak<3; ak++){
      const enEl=$('al-en-'+ch+'-'+ak), mnEl=$('al-min-'+ch+'-'+ak), mxEl=$('al-max-'+ch+'-'+ak), mtEl=$('al-met-'+ch+'-'+ak);
      chO[ak]={
        enabled:!!(enEl?.checked),
        min: +(mnEl?.value ?? 0),
        max: +(mxEl?.value ?? 0),
        metric:+(mtEl?.value ?? 4)
      };
    }
    return chO;
  }
  function sendChannelCfg(ch){
    const cfg=collectChannelCfg(ch);
    connection.send("AlarmsCfg",{ch, cfg});
    appendLog("AlarmsCfg",{ch,cfg});
  }
  function applyChannelCfg(ch, obj){
    if(typeof obj!=='object') return;
    const ackEl=$('al-ackreq-'+ch); if(ackEl && obj.hasOwnProperty('ack')) ackEl.checked=!!obj.ack;
    for(let ak=0; ak<3; ak++){
      const r=obj[ak]||{};
      const en=$('al-en-'+ch+'-'+ak), mn=$('al-min-'+ch+'-'+ak), mx=$('al-max-'+ch+'-'+ak), met=$('al-met-'+ch+'-'+ak);
      if(en && r.hasOwnProperty('enabled')) en.checked=!!r.enabled;
      if(mn && r.hasOwnProperty('min') && canApply(`al-min-${ch}-${ak}`)) mn.value=r.min;
      if(mx && r.hasOwnProperty('max') && canApply(`al-max-${ch}-${ak}`)) mx.value=r.max;
      if(met && r.hasOwnProperty('metric')) met.value=String(r.metric);

      const s=$('al-met-'+ch+'-'+ak);
      if(s){
        const meta=METRICS.find(x=>String(x.v)==String(s.value));
        const h=$('al-hint-'+ch+'-'+ak);
        if(h) h.textContent='Metric: '+(meta?.l||'')+' — '+(meta?.hint||'')+'.';
        if(mn) mn.placeholder='min '+unitForMetric(s.value);
        if(mx) mx.placeholder='max '+unitForMetric(s.value);
      }
    }
  }
  function updateAlarmsState(state){
    for(let ch=0; ch<4; ch++){
      for(let ak=0; ak<3; ak++){
        const dot=$('al-led-'+ch+'-'+ak);
        const e=state && state[ch] && state[ch][ak];
        const on=e && !!e.active;
        if(dot) dot.style.background = on ? (ak===0?'#dc3545':ak===1?'#fd7e14':'#0dcaf0') : '#ccc';
      }
    }
  }

  /* ===== Relays ===== */
  function buildRelays(){
    const container=$('relays-config'); if(!container) return; container.innerHTML='';
    const MODE_OPTS=[{v:0,l:'None'},{v:1,l:'Modbus Controlled'},{v:2,l:'Alarm Controlled'}];
    const CH_OPTS=[{v:0,l:'L1'},{v:1,l:'L2'},{v:2,l:'L3'},{v:3,l:'Totals'}];
    const selectHTML=(opts,val)=>'<select class="enm-input rly-mode">'+opts.map(o=>'<option value="'+o.v+'"'+(String(val)==String(o.v)?' selected':'')+'>'+o.l+'</option>').join('')+'</select>';
    const chanHTML=(val)=>'<select class="enm-input rly-ch">'+CH_OPTS.map(o=>'<option value="'+o.v+'"'+(String(val)==String(o.v)?' selected':'')+'>'+o.l+'</option>').join('')+'</select>';

    for(let i=1;i<=2;i++){
      const card=document.createElement('div'); card.className='rly-card';
      card.innerHTML =
        '<div style="display:flex;justify-content:space-between;align-items:center">'
      + '  <div style="font-weight:600">Relay '+i+'</div>'
      + '  <label style="display:flex;align-items:center;gap:.4rem;"><span>State</span><input type="checkbox" id="state-relay'+i+'" disabled></label>'
      + '</div>'
      + '<div class="rly-row"><label><input type="checkbox" id="enable-relay'+i+'"> Enabled at power-on</label></div>'
      + '<div class="rly-row"><label><input type="checkbox" id="invert-relay'+i+'"> Inverted (active-low)</label> <span class="pill">applies to both relays</span></div>'
      + '<div class="rly-row"><label style="min-width:80px">Mode:</label>'+selectHTML(MODE_OPTS,1)+'</div>'
      + '<div class="rly-row rly-alarm" id="alarm-box-'+i+'" style="display:none">'
      + '  <div class="rly-row" style="margin:0"><label style="min-width:80px">Channel:</label>'+chanHTML(3)+'</div>'
      + '  <div class="rly-row" style="margin:.35rem 0 0 0"><label>Kinds:</label>'
      + '    <label><input type="checkbox" class="rly-kind-al" checked> Alarm</label>'
      + '    <label><input type="checkbox" class="rly-kind-wa"> Warning</label>'
      + '    <label><input type="checkbox" class="rly-kind-ev"> Event</label>'
      + '  </div>'
      + '</div>'
      + '<div class="rly-row" style="justify-content:flex-end;margin-top:.5rem;">'
      + '  <button type="button" id="toggle-relay'+i+'" style="padding:6px 10px;background:#0d6efd;border:none;border-radius:6px;color:#fff;">Toggle</button>'
      + '</div>'
      + '<small class="muted">In <b>Alarm</b> mode the relay follows selected alarm(s). Direct writes may be blocked by firmware.</small>';
      container.appendChild(card);

      ((idx)=>{
        const root=card; const modeSel=root.querySelector('.rly-mode'); const alarmBox=$('alarm-box-'+idx);
        const updateVis=()=>{ if(modeSel.value==='2') alarmBox.style.display='block'; else alarmBox.style.display='none'; };
        const sendCfg=()=>{
          const active_low=(($('invert-relay1')?.checked||$('invert-relay2')?.checked)?1:0);
          const modes=[...document.querySelectorAll('.rly-mode')].map(s=>s.value|0);
          const chsel=[...document.querySelectorAll('.rly-ch')].map(s=>s.value|0);
          const maskFor=(i)=>
            ((document.querySelectorAll('.rly-kind-al')[i]?.checked?1:0)
            |(document.querySelectorAll('.rly-kind-wa')[i]?.checked?2:0)
            |(document.querySelectorAll('.rly-kind-ev')[i]?.checked?4:0));
          const cfg={
            active_low,
            def0:!!$('enable-relay1')?.checked,
            def1:!!$('enable-relay2')?.checked,
            mode:[modes[0]|0, modes[1]|0],
            alarm:[ {ch:(chsel[0]??3)|0, mask:maskFor(0)}, {ch:(chsel[1]??3)|0, mask:maskFor(1)} ]
          };
          connection.send("RelaysCfg", cfg); appendLog("RelaysCfg", cfg); toast('Relays updated');
        };
        modeSel.addEventListener('change', ()=>{ sendCfg(); updateVis(); });
        updateVis();
        ['enable-relay'+idx,'invert-relay'+idx].forEach(id=>{ const el=$(id); if(el) el.addEventListener('change', sendCfg); });
        ['.rly-ch','.rly-kind-al','.rly-kind-wa','.rly-kind-ev'].forEach(sel=>{ const el=root.querySelector(sel); if(el) el.addEventListener('change', sendCfg); });
        $('toggle-relay'+idx)?.addEventListener('click', ()=>{ connection.send("RelaysSet",{idx:(idx-1),toggle:true}); appendLog("RelaysSet",{idx:(idx-1),toggle:true}); toast('Relay toggled'); });
      })(i);
    }
  }
  buildRelays();

  /* ===== Buttons ===== */
  function buildButtons(){
    const container=$('buttons-config'); if(!container) return; container.innerHTML='';
    const ACTIONS=[
      {value:0,label:'None'},{value:1,label:'Toggle Relay 1'},{value:2,label:'Toggle Relay 2'},
      {value:3,label:'Toggle LED1'},{value:4,label:'Toggle LED2'},{value:5,label:'Toggle LED3'},{value:6,label:'Toggle LED4'},
      {value:7,label:'Override Relay 1 (hold 3s)'},{value:8,label:'Override Relay 2 (hold 3s)'}
    ];
    const options=ACTIONS.map(a=>`<option value="${a.value}">${a.label}</option>`).join('');
    for(let i=1;i<=4;i++){
      const card=document.createElement('div');
      card.innerHTML =
        '<div class="card" style="background:#cbdcf7;">'
      + '  <div style="font-weight:600;">Button '+i+'<span id="state-button'+i+'" style="width:12px;height:12px;background:#ccc;border-radius:50%;display:inline-block;float:right;"></span></div>'
      + '  <label>Action:<select id="action-button'+i+'" class="enm-input">'+options+'</select></label>'
      + '</div>';
      container.appendChild(card);
    }
    function sendButtons(){
      const list=[];
      for(let j=1;j<=4;j++){
        const el = $('action-button'+j);
        list.push({ action: +(el?.value ?? 0) });
      }
      connection.send("Config",{t:"buttons",list});
      appendLog("Config.buttons", list);
      toast('Buttons updated');
    }
    for(let i=1;i<=4;i++){
      $('action-button'+i)?.addEventListener('change', sendButtons);
    }
  }
  buildButtons();

  /* ===== LEDs ===== */
  function buildLEDs(){
    const container=$('leds-config'); if(!container) return; container.innerHTML='';
    const LED_MODE=[{value:0,label:'Steady (when active)'},{value:1,label:'Blink (when active)'}];
    const LED_SOURCE=[
      {value:0,label:'None'},{value:8,label:'Override R1'},{value:9,label:'Override R2'},
      {value:10,label:'Alarm L1'},{value:11,label:'Alarm L2'},{value:12,label:'Alarm L3'},{value:13,label:'Alarm Totals'},
      {value:14,label:'Warning L1'},{value:15,label:'Warning L2'},{value:16,label:'Warning L3'},{value:17,label:'Warning Totals'},
      {value:18,label:'Event L1'},{value:19,label:'Event L2'},{value:20,label:'Event L3'},{value:21,label:'Event Totals'},
      {value:22,label:'Any (A|W|E) L1'},{value:23,label:'Any (A|W|E) L2'},{value:24,label:'Any (A|W|E) L3'},{value:25,label:'Any (A|W|E) Totals'}
    ];
    const modeOpts=LED_MODE.map(a=>`<option value="${a.value}">${a.label}</option>`).join('');
    const srcOpts=LED_SOURCE.map(a=>`<option value="${a.value}">${a.label}</option>`).join('');
    for(let i=1;i<=4;i++){
      const card=document.createElement('div');
      card.innerHTML =
        '<div class="card" style="background:#f3f5d0;">'
      + '  <div style="font-weight:600;">User LED '+i+'<span id="state-led'+i+'" style="width:12px;height:12px;background:#ccc;border-radius:50%;display:inline-block;float:right;"></span></div>'
      + '  <label>Mode:<select id="mode-led'+i+'" class="enm-input">'+modeOpts+'</select></label><br>'
      + '  <label>Source:<select id="source-led'+i+'" class="enm-input">'+srcOpts+'</select></label>'
      + '</div>';
      container.appendChild(card);
    }
    const sendLEDs=()=>{
      const list=[];
      for(let j=1;j<=4;j++){
        const m=$('mode-led'+j), s=$('source-led'+j);
        list.push({ mode:+(m?.value ?? 0), source:+(s?.value ?? 0) });
      }
      connection.send("Config",{t:"leds",list});
      appendLog("Config.leds", list);
      toast('LEDs updated');
    };
    for(let i=1;i<=4;i++){
      $('mode-led'+i)?.addEventListener('change', sendLEDs);
      $('source-led'+i)?.addEventListener('change', sendLEDs);
    }
  }
  buildLEDs();

  /* ===== Meter Options send ===== */
  function sendMeterCfg(partial){
    connection.send("Config",{t:"meter", cfg: partial});
    appendLog("Config.meter", partial);
  }
  $('opt-lineHz')?.addEventListener('change', ()=>{ sendMeterCfg({lineHz:+$('opt-lineHz').value}); toast('Meter option sent'); });
  $('opt-sumAbs')?.addEventListener('change', ()=>{ sendMeterCfg({sumAbs:+$('opt-sumAbs').value}); toast('Meter option sent'); });
  attachLockHandlers($('opt-samplems'), 'opt-samplems', ()=>sendMeterCfg({sample_ms:+$('opt-samplems').value}));

  /* ===== Modbus live push on change ===== */
  function pushModbus(){
    const mb_address=parseInt($('modbus-address')?.value||"3",10);
    const mb_baud   =parseInt($('modbus-baud')?.value||"19200",10);
    connection.send("values",{mb_address,mb_baud}); appendLog("values",{mb_address,mb_baud});
    toast('Modbus sent');
  }
  $('modbus-address')?.addEventListener('input', pushModbus);
  $('modbus-baud')?.addEventListener('input', pushModbus);

  /* ===== Request Sync ===== */
  $('req-sync')?.addEventListener('click', ()=>{
    appendLog("sync","requested (device pushes every 1s)");
    toast('Sync: waiting 1s');
  });

  /* ===== RAW + CHIPCFG RENDERING ===== */
  const rawPrevReads = new Map();

  function fmtVal(v, showHex){
    if(!showHex) return String(v);
    const u=(Number(v)>>>0)&0xFFFF;
    return "0x"+u.toString(16).toUpperCase().padStart(4,"0")+" ("+u+")";
  }
  function setUpdatedTs(){
    const ts=new Date();
    const pad2=n=>String(n).padStart(2,"0");
    $('raw-last-ts').textContent=`${pad2(ts.getHours())}:${pad2(ts.getMinutes())}:${pad2(ts.getSeconds())}`;
  }
  function renderRawTable(tbodyId, arr, prevMap){
    const freeze = $('raw-freeze')?.checked;
    if(freeze) return;
    const showHex = $('raw-show-hex')?.checked;
    const tbody = $(tbodyId);
    if(!tbody || !Array.isArray(arr)) return;

    let html="";
    for(const o of arr){
      const reg=String(o.reg ?? "");
      const name=String(o.name ?? "");
      const val=Number(o.val ?? 0);
      const prev=prevMap.get(reg);
      const changed=(prev!==undefined && prev!==val);
      html += `
        <tr class="${changed?'raw-changed':''}">
          <td class="mono">${reg}</td>
          <td>${name}</td>
          <td class="mono" style="text-align:right;">${fmtVal(val, showHex)}</td>
        </tr>`;
      prevMap.set(reg,val);
    }
    tbody.innerHTML=html;
    setUpdatedTs();
  }

  function ensureChipCfgCards(){
    const grid=$('chipcfg-grid'); if(!grid) return;
    if(grid.dataset.built) return;
    grid.dataset.built="1";
    const mk=(id,title,subtitle,rowsHtml)=>`
      <div class="chipcfg-card" id="${id}">
        <div class="chipcfg-title">
          <div><strong>${title}</strong><div class="chipcfg-mini">${subtitle||''}</div></div>
          <span class="pill">readback</span>
        </div>
        <div class="chipcfg-kv">${rowsHtml}</div>
      </div>`;
    const kv=(k,id)=>`<div>${k}</div><div class="mono" id="${id}" style="text-align:right">--</div>`;

    grid.innerHTML =
      mk("chipcalA","Phase A","U/I gains + offsets",  kv("Ugain","ccA-Ug")+kv("Igain","ccA-Ig")+kv("Uoffset","ccA-Uo")+kv("Ioffset","ccA-Io")) +
      mk("chipcalB","Phase B","U/I gains + offsets",  kv("Ugain","ccB-Ug")+kv("Igain","ccB-Ig")+kv("Uoffset","ccB-Uo")+kv("Ioffset","ccB-Io")) +
      mk("chipcalC","Phase C","U/I gains + offsets",  kv("Ugain","ccC-Ug")+kv("Igain","ccC-Ig")+kv("Uoffset","ccC-Uo")+kv("Ioffset","ccC-Io")) +
      mk("chipmodes","Modes / Constants","Key config registers",
        kv("MMode0","cc-M0")+kv("MMode1","cc-M1")+kv("PLconstH","cc-PLH")+kv("PLconstL","cc-PLL")+
        kv("SagPeakDetCfg","cc-SPD")+kv("SagTh","cc-STH")+kv("FreqHiTh","cc-FHH")+kv("FreqLoTh","cc-FHL")+kv("ZXConfig","cc-ZXC")
      );
  }

  function setMono(id, val){
    const el=$(id); if(!el) return;
    const showHex=$('raw-show-hex')?.checked;
    if(typeof val!=='number') { el.textContent='--'; return; }
    el.textContent = showHex ? fmtVal(val,true) : String(val);
  }

  /* ===== Incoming firmware pushes ===== */

  connection.on('status', function(st){
    $('live-address').textContent=(st&&st.address!==undefined)?st.address:'--';
    $('live-baud').textContent=(st&&st.baud!==undefined)?st.baud:'--';
    if(st && st.address!==undefined) $('modbus-address').value=String(st.address);
    if(st && st.baud!==undefined) $('modbus-baud').value=String(st.baud);
  });

  connection.on('MeterOptions', function(mo){
    if(!mo) return;
    if(mo.lineHz!==undefined) $('opt-lineHz').value=String(mo.lineHz);
    if(mo.sumAbs!==undefined) $('opt-sumAbs').value=String(mo.sumAbs);
    if(mo.sample_ms!==undefined && canApply('opt-samplems')) $('opt-samplems').value=String(mo.sample_ms);
  });

  // CalibCfg (FS config echo)
  connection.on('CalibCfg', function(payload){
    try{
      if(Array.isArray(payload)){
        for(let ch=0; ch<3 && ch<payload.length; ch++) applyCalibCh(ch, payload[ch]||{});
      }
    }catch(e){}
  });

  // ATM_ChipCfg (REAL CHIP READBACK)
  connection.on('ATM_ChipCfg', function(cfg){
    try{
      ensureChipCfgCards();
      if(!cfg || typeof cfg!=='object') return;

      const ph = cfg.phase || cfg.ph || cfg.phases;
      if(ph){
        const A=ph[0]||ph.A||ph.a, B=ph[1]||ph.B||ph.b, C=ph[2]||ph.C||ph.c;
        if(A){ setMono("ccA-Ug", +A.Ugain); setMono("ccA-Ig", +A.Igain); setMono("ccA-Uo", +A.Uoffset); setMono("ccA-Io", +A.Ioffset); }
        if(B){ setMono("ccB-Ug", +B.Ugain); setMono("ccB-Ig", +B.Igain); setMono("ccB-Uo", +B.Uoffset); setMono("ccB-Io", +B.Ioffset); }
        if(C){ setMono("ccC-Ug", +C.Ugain); setMono("ccC-Ig", +C.Igain); setMono("ccC-Uo", +C.Uoffset); setMono("ccC-Io", +C.Ioffset); }
      }

      const keys=[
        ["MMode0","cc-M0"],["MMode1","cc-M1"],["PLconstH","cc-PLH"],["PLconstL","cc-PLL"],
        ["SagPeakDetCfg","cc-SPD"],["SagTh","cc-STH"],["FreqHiTh","cc-FHH"],["FreqLoTh","cc-FHL"],["ZXConfig","cc-ZXC"]
      ];
      for(const [k,id] of keys){
        if(cfg[k]!==undefined) setMono(id, +cfg[k]);
      }
      setUpdatedTs();
    }catch(e){}
  });

  connection.on('LedConfigList', (list)=>{
    try{
      if(!Array.isArray(list)) return;
      for(let i=0;i<list.length&&i<4;i++){
        const o=list[i]||{};
        const mEl=$('mode-led'+(i+1)), sEl=$('source-led'+(i+1));
        if(mEl && o.mode!==undefined)   mEl.value=String(o.mode);
        if(sEl && o.source!==undefined) sEl.value=String(o.source);
      }
    }catch(e){}
  });

  connection.on('ButtonConfigList',(list)=>{
    try{
      if(!list || typeof list.length==='undefined') return;
      for(let j=0;j<4 && j<list.length;j++){
        const v = list[j];
        const el=$('action-button'+(j+1)); if(el && v!==undefined) el.value=String(v||0);
      }
    }catch(e){}
  });

  connection.on('RelaysCfg', (rc)=>{
    try{
      if(!rc||typeof rc!=='object') return;
      if(rc.active_low!==undefined){ $('invert-relay1').checked=!!rc.active_low; $('invert-relay2').checked=!!rc.active_low; }
      if(rc.def0!==undefined) $('enable-relay1').checked=!!rc.def0;
      if(rc.def1!==undefined) $('enable-relay2').checked=!!rc.def1;
      if(rc.mode && rc.mode.length>=2){
        const modes=document.querySelectorAll('.rly-mode');
        if(modes[0]) modes[0].value=String(rc.mode[0]);
        if(modes[1]) modes[1].value=String(rc.mode[1]);
        for(let k=1;k<=2;k++){ const ab=$('alarm-box-'+k); if(ab) ab.style.display=(String(rc.mode[k-1])==='2')?'block':'none'; }
      }
      if(rc.alarm && rc.alarm.length>=2){
        const chs=document.querySelectorAll('.rly-ch');
        if(chs[0]) chs[0].value=String(rc.alarm[0].ch);
        if(chs[1]) chs[1].value=String(rc.alarm[1].ch);
        const setMask=(idx,mask)=>{
          const al=document.querySelectorAll('.rly-kind-al')[idx],
                wa=document.querySelectorAll('.rly-kind-wa')[idx],
                ev=document.querySelectorAll('.rly-kind-ev')[idx];
          if(al)al.checked=!!(mask&1);
          if(wa)wa.checked=!!(mask&2);
          if(ev)ev.checked=!!(mask&4);
        };
        setMask(0, (rc.alarm[0].mask|0));
        setMask(1, (rc.alarm[1].mask|0));
      }
    }catch(e){}
  });

  connection.on('AlarmsCfg', function(payload){
    try{
      if(payload && typeof payload==='object' && !Array.isArray(payload)){
        for(const k of Object.keys(payload)){
          const ch=parseInt(k,10);
          if(!isNaN(ch) && ch>=0 && ch<4) applyChannelCfg(ch, payload[k]||{});
        }
      }
    }catch(e){}
  });

  connection.on('AlarmsState', (state)=>{ try{ updateAlarmsState(state); }catch(e){} });

  $('ack-all')?.addEventListener('click', ()=>{
    connection.send("AlarmsAck",{list:[true,true,true,true]});
    appendLog("AlarmsAck","all");
    toast('Ack all');
  });

  connection.on('RelayState', function(arr){
    const a = Array.isArray(arr) ? arr : [arr?.[0], arr?.[1]];
    for(let i=0;i<2;i++){
      const el=$('state-relay'+(i+1));
      if(el && a && a[i]!==undefined) el.checked=!!a[i];
    }
  });

  connection.on('ButtonStateList', function(list){
    if(!list||typeof list.length==='undefined') return;
    for(let i=0;i<list.length&&i<4;i++){
      const dot=$('state-button'+(i+1));
      if(dot) dot.style.background=list[i]?'#4caf50':'#ccc';
    }
  });

  connection.on('LedStateList', function(list){
    if(!list||typeof list.length==='undefined') return;
    for(let i=0;i<list.length&&i<4;i++){
      const d=$('state-led'+(i+1));
      if(d) d.style.background=list[i]?'#ffb300':'#ccc';
    }
  });

  /* =========================
     ENM_Meter (FIXED ENERGIES)
     - Supports NEW format: E_phase (array[3]) + E_tot (object)
     - Still supports OLD format: E[0],E[1],E[2],E.tot
     ========================= */
  connection.on('ENM_Meter', function(m){
    try{
      const Urms=(m&&m.Urms)||[], Irms=(m&&m.Irms)||[];
      const PW=(m&&m.P_W)||[], QV=(m&&m.Q_var)||[], SV=(m&&m.S_VA)||[];
      const PF=(m&&m.PF)||[], Ang=(m&&m.Angle_deg)||[];
      const FreqHz = m?.FreqHz, TempC = m?.TempC;

      for(let i=0;i<3;i++){
        $('u'+i) && ( $('u'+i).textContent = (typeof Urms[i]==='number') ? Urms[i].toFixed(2) : '--' );
        $('i'+i) && ( $('i'+i).textContent = (typeof Irms[i]==='number') ? Irms[i].toFixed(3) : '--' );
        $('p'+i) && ( $('p'+i).textContent = (PW[i]!==undefined) ? PW[i] : '--' );
        $('q'+i) && ( $('q'+i).textContent = (QV[i]!==undefined) ? QV[i] : '--' );
        $('s'+i) && ( $('s'+i).textContent = (SV[i]!==undefined) ? SV[i] : '--' );
        $('pf'+i) && ( $('pf'+i).textContent = (typeof PF[i]==='number') ? PF[i].toFixed(3) : '--' );
        $('ang'+i) && ( $('ang'+i).textContent = (typeof Ang[i]==='number') ? Ang[i].toFixed(1) : '--' );
      }

      $('p3') && ( $('p3').textContent = (PW[3]!==undefined) ? PW[3] : '--' );
      $('q3') && ( $('q3').textContent = (QV[3]!==undefined) ? QV[3] : '--' );
      $('s3') && ( $('s3').textContent = (SV[3]!==undefined) ? SV[3] : '--' );
      $('pft') && ( $('pft').textContent = (typeof PF?.[3]==='number') ? PF[3].toFixed(3) : '--' );
      $('f') && ( $('f').textContent = (typeof FreqHz==='number') ? FreqHz.toFixed(2) : '--' );
      $('t') && ( $('t').textContent = (TempC!==undefined) ? TempC : '--' );

      // -------- Energies (NEW + OLD compatible) --------
      const setE = (idx, src)=>{
        const set = (id,val,dec=3)=>{ const el=$(id); if(el) el.textContent = (typeof val==='number' && isFinite(val)) ? val.toFixed(dec) : '--'; };
        if(!src || typeof src!=='object') {
          set(`e-ap-${idx}`, NaN); set(`e-an-${idx}`, NaN); set(`e-rp-${idx}`, NaN); set(`e-rn-${idx}`, NaN); set(`e-s-${idx}`, NaN);
          return;
        }
        set(`e-ap-${idx}`, Number(src.AP_kWh), 3);
        set(`e-an-${idx}`, Number(src.AN_kWh), 3);
        set(`e-rp-${idx}`, Number(src.RP_kvarh), 3);
        set(`e-rn-${idx}`, Number(src.RN_kvarh), 3);
        set(`e-s-${idx}`,  Number(src.S_kVAh), 3);
      };

      if (Array.isArray(m?.E_phase) || (m?.E_tot && typeof m.E_tot === 'object')) {
        // NEW firmware format
        const Ep = Array.isArray(m.E_phase) ? m.E_phase : [];
        const Et = (m.E_tot && typeof m.E_tot === 'object') ? m.E_tot : null;
        for(let i=0;i<3;i++) setE(i, Ep[i]);
        setE(3, Et);
      } else {
        // OLD format fallback: m.E[0..2] + m.E.tot
        const E = m?.E || {};
        setE(0, E[0]);
        setE(1, E[1]);
        setE(2, E[2]);
        setE(3, E.tot);
      }

    }catch(e){}
  });

  // ATM_RawReads (single table now)
  connection.on('ATM_RawReads',  (arr)=>{ try{ renderRawTable('raw-reads-body',  arr, rawPrevReads ); }catch(e){} });

})();
</script>
