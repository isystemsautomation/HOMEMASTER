<section style="font-family:'Segoe UI',sans-serif;padding:2rem;max-width:1000px;margin:auto;">
  <div style="text-align:center;margin-bottom:2rem;">
    <img src="https://www.home-master.eu/web/image/product.product/719/image_1024/ALM-173-R1%20Module%20for%20Alarm%20Systems?unique=f079b61" alt="ENM-223-R1" style="max-width:300px;border-radius:8px;opacity:.9;" loading="lazy">
    <h2 style="margin:.5rem 0 0;">ENM-223-R1 Module Configuration</h2>
    <p style="margin:.25rem 0 0;color:#333;">Configure Modbus and meter options (line frequency / sum mode / uCal / sample interval) and view live 3‑phase data via Web Serial.</p>
  </div>

  <div style="background:#f1f1f1;padding:1rem 1.5rem;margin-bottom:2rem;border-radius:6px;border-left:4px solid #007bff;">
    <strong>Active Modbus Configuration</strong><br>
    Address: <span id="live-address" style="font-weight:600;">--</span> |
    Baud Rate: <span id="live-baud" style="font-weight:600;">--</span>
  </div>

  <form id="modbus-config" style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:.75rem;">
    <div>
      <label for="modbus-address"><strong>Modbus Address</strong></label>
      <select id="modbus-address" style="width:100%;padding:10px;border-radius:4px;"></select>
    </div>
    <div>
      <label for="modbus-baud"><strong>Baud Rate</strong></label>
      <select id="modbus-baud" style="width:100%;padding:10px;border-radius:4px;">
        <option>9600</option><option selected>19200</option><option>38400</option><option>57600</option><option>115200</option>
      </select>
    </div>
    <div style="grid-column:span 2;display:flex;justify-content:flex-end;">
      <button id="connect-button" type="button" style="padding:10px 20px;background:#007bff;color:#fff;border:none;border-radius:4px;">Connect to device</button>
    </div>
  </form>

  <!-- Fixed-height log window: exactly 5 rows (old at top, new at bottom) -->
  <div id="log-line" style="margin-bottom:1.5rem;padding:1rem;background:#f9f9f9;border:1px solid #ccc;border-radius:6px;font-size:0.9rem;color:#333;">
    <strong>Serial Log:</strong>
    <pre id="log-content" style="white-space:pre-wrap;font-family:monospace;line-height:1.25em;margin:0;margin-top:.5rem;height:calc(1.25em * 5);overflow-y:auto;background:#fff;border:1px solid #e5e5e5;border-radius:4px;padding:.5rem;"></pre>
  </div>

  <section style="margin-bottom:1.75rem;">
    <h2 style="font-size:1.2rem;margin-bottom:.75rem;">Meter Options</h2>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1rem;">
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <label for="opt-lineHz"><strong>Line Frequency (Hz)</strong></label>
        <select id="opt-lineHz" style="width:100%;padding:10px;border-radius:4px;">
          <option value="50" selected>50</option>
          <option value="60">60</option>
        </select>
      </div>
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <label for="opt-sumAbs"><strong>Sum Mode</strong> <small style="color:#666;">(0=algebraic, 1=abs)</small></label>
        <select id="opt-sumAbs" style="width:100%;padding:10px;border-radius:4px;">
          <option value="0">0</option>
          <option value="1" selected>1</option>
        </select>
      </div>
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <label for="opt-ucal"><strong>Ucal</strong> <small style="color:#666;">(gain)</small></label>
        <input id="opt-ucal" type="number" min="1" max="65535" step="1" value="25256" style="width:100%;padding:10px;border-radius:4px;border:1px solid #ccc;">
      </div>
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <label for="opt-samplems"><strong>Sample Interval (ms)</strong></label>
        <input id="opt-samplems" type="number" min="10" max="5000" step="10" value="200" style="width:100%;padding:10px;border-radius:4px;border:1px solid #ccc;">
      </div>
    </div>
    <div style="text-align:right;margin-top:.75rem;">
      <button id="apply-meter" type="button" style="padding:10px 16px;background:#0d6efd;color:#fff;border:none;border-radius:6px;" disabled>Apply Meter Options</button>
    </div>
  </section>

  <section style="margin-bottom:1.75rem;">
    <h2 style="font-size:1.2rem;margin-bottom:.75rem;">Scaling (Engineering Units)</h2>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1rem;">
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <label><strong>P scale</strong> <small style="color:#666;">mW per LSB</small></label>
        <input id="sc-p" type="number" min="0" step="1" value="1" style="width:100%;padding:10px;border-radius:4px;border:1px solid #ccc;">
      </div>
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <label><strong>Q scale</strong> <small style="color:#666;">mvar×1000 per LSB</small></label>
        <input id="sc-q" type="number" min="0" step="1" value="1" style="width:100%;padding:10px;border-radius:4px;border:1px solid #ccc;">
      </div>
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <label><strong>S scale</strong> <small style="color:#666;">mVA×1000 per LSB</small></label>
        <input id="sc-s" type="number" min="0" step="1" value="1" style="width:100%;padding:10px;border-radius:4px;border:1px solid #ccc;">
      </div>
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <label><strong>AP energy</strong> <small style="color:#666;">kWh×1e5 per CNT</small></label>
        <input id="sc-eap" type="number" min="0" step="1" value="1" style="width:100%;padding:10px;border-radius:4px;border:1px solid #ccc;">
      </div>
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <label><strong>AN energy</strong> <small style="color:#666;">kWh×1e5 per CNT</small></label>
        <input id="sc-ean" type="number" min="0" step="1" value="1" style="width:100%;padding:10px;border-radius:4px;border:1px solid #ccc;">
      </div>
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <label><strong>RP energy</strong> <small style="color:#666;">kvarh×1e5 per CNT</small></label>
        <input id="sc-erp" type="number" min="0" step="1" value="1" style="width:100%;padding:10px;border-radius:4px;border:1px solid #ccc;">
      </div>
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <label><strong>RN energy</strong> <small style="color:#666;">kvarh×1e5 per CNT</small></label>
        <input id="sc-ern" type="number" min="0" step="1" value="1" style="width:100%;padding:10px;border-radius:4px;border:1px solid #ccc;">
      </div>
      <div style="border:1px solid #ddd;border-radius:6px;padding:1rem;">
        <label><strong>S energy</strong> <small style="color:#666;">kVAh×1e5 per CNT</small></label>
        <input id="sc-es" type="number" min="0" step="1" value="1" style="width:100%;padding:10px;border-radius:4px;border:1px solid #ccc;">
      </div>
    </div>
    <div style="text-align:right;margin-top:.75rem;">
      <button id="apply-scale" type="button" style="padding:10px 16px;background:#0d6efd;color:#fff;border:none;border-radius:6px;" disabled>Apply Scales</button>
    </div>
  </section>

  <section style="margin-bottom:1.5rem;">
    <h2 style="font-size:1.2rem;margin-bottom:.75rem;">Live Meter</h2>
    <div id="chan-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:1rem;"></div>
    <small style="color:#666;">Firmware emits <code>ENM_Meter</code> via WebSerial: Urms/Irms/P/Q/S/PF/Angles/Freq/Temp/Energies.</small>
  </section>

  <section style="margin-bottom:1.5rem;">
    <h2 style="font-size:1.2rem;margin-bottom:.75rem;">Buttons (4)</h2>
    <div id="buttons-config" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:1rem;"></div>
  </section>

  <section style="margin-bottom:1.5rem;">
    <h2 style="font-size:1.2rem;margin-bottom:.75rem;">User LEDs (4)</h2>
    <div id="leds-config" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:1rem;"></div>
  </section>
</section>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
<script src="https://unpkg.com/simple-web-serial@latest/dist/simple-web-serial.min.js"></script>
<script>
(function () {
  // ---------- Helpers ----------
  var LOG_MAX = 200;
  var logBuffer = [];
  function $(id){ return document.getElementById(id); }

  // Append messages to the BOTTOM; keep exactly 5-line viewport; auto-scroll to bottom
  function appendLog(label, data) {
    var el = $("log-content"); if (!el) return;
    var time = new Date().toLocaleTimeString();
    var body = (typeof data === 'string') ? data : JSON.stringify(data);
    body = String(body).replace(/\r\n?|\n/g, '\n').replace(/\\r\\n|\\r|\\n/g, '\n');

    // push new message to the end so old messages remain at the top
    logBuffer.push("[" + time + "] " + label + ": " + body);
    if (logBuffer.length > LOG_MAX) logBuffer.shift();

    el.textContent = logBuffer.join('\n');

    // keep the view anchored to the newest line at the bottom
    el.scrollTop = el.scrollHeight;
  }

  function populateAddresses() {
    var sel = $('modbus-address'); if (!sel) return;
    sel.innerHTML = '';
    for (var i = 1; i <= 255; i++) {
      var o = document.createElement('option'); o.value = i; o.textContent = i;
      sel.appendChild(o);
    }
    sel.value = '3';
  }

  function isPortOpen() {
    try { return (typeof connection.isOpen === 'function') ? connection.isOpen() : !!connection.port; }
    catch (e) { return false; }
  }
  function setEnabled(ids, enabled) { for (var i=0;i<ids.length;i++){ var el=$(ids[i]); if (el) el.disabled = !enabled; } }

  // ---------- Channel cards (for meter) ----------
  function buildChannelCards() {
    var grid = $('chan-grid'); if (!grid) return;
    grid.innerHTML = '';
    var labels = ['L1','L2','L3','Totals'];
    for (var ch = 0; ch < 4; ch++) {
      var card = document.createElement('div');
      card.style = "border:1px solid #ddd;border-radius:8px;padding:1rem;background:#fff;";
      var inner = ''
        + '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;">'
        + '  <strong>' + labels[ch] + '</strong>'
        + '</div>'
        + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:.35rem .75rem;font-size:.95rem;">'
        + '  <div>U (V):</div><div id="u' + ch + '" style="text-align:right">--</div>'
        + '  <div>I (A):</div><div id="i' + ch + '" style="text-align:right">--</div>'
        + '  <div>P raw:</div><div id="p' + ch + '" style="text-align:right">--</div>'
        + '  <div>Q raw:</div><div id="q' + ch + '" style="text-align:right">--</div>'
        + '  <div>S raw:</div><div id="s' + ch + '" style="text-align:right">--</div>'
        + (ch<3 ? ('  <div>PF raw:</div><div id="pf' + ch + '" style="text-align:right">--</div>'
                 + '  <div>Angle (0.1°):</div><div id="ang' + ch + '" style="text-align:right">--</div>')
                : ('  <div>PF tot raw:</div><div id="pft" style="text-align:right">--</div>'
                 + '  <div>Freq (Hz):</div><div id="f" style="text-align:right">--</div>'
                 + '  <div>Temp (°C):</div><div id="t" style="text-align:right">--</div>'))
        + '</div>';
      card.innerHTML = inner;
      grid.appendChild(card);
    }
  }

  // ---------- Build Buttons & LEDs ----------
  function buildButtons() {
    var container = $('buttons-config'); if (!container) return;
    container.innerHTML = '';
    var ACTIONS = [
      {value:0,label:'None'},
      {value:1,label:'Toggle Relay 1'},
      {value:2,label:'Toggle Relay 2'},
      {value:3,label:'Toggle LED1'},
      {value:4,label:'Toggle LED2'},
      {value:5,label:'Toggle LED3'},
      {value:6,label:'Toggle LED4'},
      {value:7,label:'Save config'},
      {value:8,label:'Reset device'}
    ];
    for (var i = 1; i <= 4; i++) {
      var options = ACTIONS.map(function(a){return '<option value="'+a.value+'">'+a.label+'</option>';}).join('');
      var card = document.createElement('div');
      card.innerHTML =
        '<div style="border:1px solid #ccc;border-radius:6px;background:#cbdcf7;padding:1rem;">'
      + '  <div style="font-weight:600;">'
      + '    Button ' + i
      + '    <span id="state-button' + i + '" style="width:12px;height:12px;background:#ccc;border-radius:50%;display:inline-block;float:right;"></span>'
      + '  </div>'
      + '  <label>Action:'
      + '    <select id="action-button' + i + '" style="width:100%;padding:6px;border-radius:4px;">'
      +        options
      + '    </select>'
      + '  </label>'
      + '</div>';
      container.appendChild(card);
    }
  }
  function buildLEDs() {
    var container = $('leds-config'); if (!container) return;
    container.innerHTML = '';
    var LED_MODE = [
      {value:0,label:'Steady (when active)'},
      {value:1,label:'Blink (when active)'}
    ];
    var LED_SOURCE = [
      {value:0,label:'None'},
      {value:1,label:'Heartbeat'},
      {value:2,label:'Button 1 pressed'},
      {value:3,label:'Button 2 pressed'},
      {value:4,label:'Button 3 pressed'},
      {value:5,label:'Button 4 pressed'},
      {value:6,label:'Any button pressed'},
      {value:7,label:'Sampling tick'}
    ];
    for (var i = 1; i <= 4; i++) {
      var modeOpts = LED_MODE.map(function(a){return '<option value="'+a.value+'">'+a.label+'</option>';}).join('');
      var srcOpts  = LED_SOURCE.map(function(a){return '<option value="'+a.value+'">'+a.label+'</option>';}).join('');
      var card = document.createElement('div');
      card.innerHTML =
        '<div style="border:1px solid #ccc;border-radius:6px;background:#f3f5d0;padding:1rem;">'
      + '  <div style="font-weight:600;">'
      + '    User LED ' + i
      + '    <span id="state-led' + i + '" style="width:12px;height:12px;background:#ccc;border-radius:50%;display:inline-block;float:right;"></span>'
      + '  </div>'
      + '  <label>Mode:'
      + '    <select id="mode-led' + i + '" style="width:100%;padding:6px;border-radius:4px;">' + modeOpts + '</select>'
      + '  </label><br>'
      + '  <label>Source:'
      + '    <select id="source-led' + i + '" style="width:100%;padding:6px;border-radius:4px;">' + srcOpts + '</select>'
      + '  </label>'
      + '</div>';
      container.appendChild(card);
    }
  }

  // ---------- Init UI ----------
  populateAddresses();
  buildChannelCards();
  buildButtons();
  buildLEDs();

  // ---------- Web Serial Setup ----------
  var connection = SimpleWebSerial.setupSerialConnection({
    requestAccessOnPageLoad: false,
    requestElement: 'connect-button'
  });

  function onPortStateChange() {
    var open = isPortOpen();
    setEnabled(['apply-meter','apply-scale'], open);
  }
  connection.on('open',  onPortStateChange);
  connection.on('close', onPortStateChange);

  // Live status (from firmware)
  connection.on('status', function(modbus){
    $('live-address').textContent = (modbus && typeof modbus.address !== 'undefined') ? modbus.address : '--';
    $('live-baud').textContent    = (modbus && typeof modbus.baud    !== 'undefined') ? modbus.baud    : '--';
    if (modbus && typeof modbus.address !== 'undefined') $('modbus-address').value = modbus.address;
    if (modbus && typeof modbus.baud    !== 'undefined') $('modbus-baud').value    = String(modbus.baud);
    onPortStateChange();
  });

  // Meter options echo
  connection.on('MeterOptions', function(opts){
    if (!opts) return;
    if (typeof opts.lineHz   !== 'undefined') $('opt-lineHz').value    = String(opts.lineHz);
    if (typeof opts.sumAbs   !== 'undefined') $('opt-sumAbs').value    = String(opts.sumAbs);
    if (typeof opts.ucal     !== 'undefined') $('opt-ucal').value      = String(opts.ucal);
    if (typeof opts.sample_ms!== 'undefined') $('opt-samplems').value  = String(opts.sample_ms);
    if (typeof opts.p_mW_per_lsb          !== 'undefined') $('sc-p').value  = String(opts.p_mW_per_lsb);
    if (typeof opts.q_mvar_x1k_per_lsb    !== 'undefined') $('sc-q').value  = String(opts.q_mvar_x1k_per_lsb);
    if (typeof opts.s_mva_x1k_per_lsb     !== 'undefined') $('sc-s').value  = String(opts.s_mva_x1k_per_lsb);
    if (typeof opts.e_ap_kWh_x1e5         !== 'undefined') $('sc-eap').value= String(opts.e_ap_kWh_x1e5);
    if (typeof opts.e_an_kWh_x1e5         !== 'undefined') $('sc-ean').value= String(opts.e_an_kWh_x1e5);
    if (typeof opts.e_rp_kvarh_x1e5       !== 'undefined') $('sc-erp').value= String(opts.e_rp_kvarh_x1e5);
    if (typeof opts.e_rn_kvarh_x1e5       !== 'undefined') $('sc-ern').value= String(opts.e_rn_kvarh_x1e5);
    if (typeof opts.e_s_kVAh_x1e5         !== 'undefined') $('sc-es').value = String(opts.e_s_kVAh_x1e5);
  });

  // Serial log passthrough
  connection.on('message', function(msg){ appendLog("ENM-223-R1", msg); });

  // Live meter data
  connection.on('ENM_Meter', function(m){
    try {
      var Urms = (m && m.Urms) ? m.Urms : [];
      var Irms = (m && m.Irms) ? m.Irms : [];
      var Praw = (m && m.Praw) ? m.Praw : [];
      var Qraw = (m && m.Qraw) ? m.Qraw : [];
      var Sraw = (m && m.Sraw) ? m.Sraw : [];
      var PF   = (m && m.PFraw)? m.PFraw: [];
      var Ang  = (m && m.Ang0p1deg)? m.Ang0p1deg: [];

      for (var i=0;i<3;i++){
        var uEl=$('u'+i), iEl=$('i'+i), pEl=$('p'+i), qEl=$('q'+i), sEl=$('s'+i), pfEl=$('pf'+i), aEl=$('ang'+i);
        if (uEl) uEl.textContent  = (typeof Urms[i] === 'number') ? Urms[i].toFixed(2) : '--';
        if (iEl) iEl.textContent  = (typeof Irms[i] === 'number') ? Irms[i].toFixed(3) : '--';
        if (pEl) pEl.textContent  = (typeof Praw[i] !== 'undefined') ? Praw[i] : '--';
        if (qEl) qEl.textContent  = (typeof Qraw[i] !== 'undefined') ? Qraw[i] : '--';
        if (sEl) sEl.textContent  = (typeof Sraw[i] !== 'undefined') ? Sraw[i] : '--';
        if (pfEl)pfEl.textContent = (typeof PF[i]   !== 'undefined') ? PF[i]   : '--';
        if (aEl) aEl.textContent  = (typeof Ang[i]  !== 'undefined') ? Ang[i]  : '--';
      }
      var pt=$('p3'), qt=$('q3'), st=$('s3'), pft=$('pft'), fEl=$('f'), tEl=$('t');
      if (pt)  pt.textContent  = (typeof m.Ptot_raw !== 'undefined') ? m.Ptot_raw : '--';
      if (qt)  qt.textContent  = (typeof m.Qtot_raw !== 'undefined') ? m.Qtot_raw : '--';
      if (st)  st.textContent  = (typeof m.Stot_raw !== 'undefined') ? m.Stot_raw : '--';
      if (pft) pft.textContent = (typeof m.PFtot_raw!== 'undefined') ? m.PFtot_raw: '--';
      if (fEl) fEl.textContent = (typeof m.FreqHz   === 'number') ? m.FreqHz.toFixed(2) : (m && m.FreqHz ? m.FreqHz : '--');
      if (tEl) tEl.textContent = (typeof m.TempC    !== 'undefined') ? m.TempC : '--';
    } catch(e) {}
  });

  // Buttons receive/echo
  connection.on('ButtonConfigList', function(list){
    if (!list || typeof list.length === 'undefined') return;
    for (var i=0;i<list.length && i<4;i++){
      var el = $('action-button' + (i + 1));
      if (el) el.value = String(list[i] || 0);
    }
  });
  connection.on('ButtonStateList', function(list){
    if (!list || typeof list.length === 'undefined') return;
    for (var i=0;i<list.length && i<4;i++){
      var dot = $('state-button' + (i + 1));
      if (dot) dot.style.background = list[i] ? '#4caf50' : '#ccc';
    }
  });

  // LEDs receive/echo
  connection.on('LedConfigList', function(list){
    if (!list || typeof list.length === 'undefined') return;
    for (var i=0;i<list.length && i<4;i++){
      var obj = list[i] || {};
      var modeEl = $('mode-led' + (i + 1));
      var srcEl  = $('source-led' + (i + 1));
      if (modeEl && typeof obj.mode   !== 'undefined') modeEl.value = String(obj.mode);
      if (srcEl  && typeof obj.source !== 'undefined') srcEl.value  = String(obj.source);
    }
  });
  connection.on('LedStateList', function(list){
    if (!list || typeof list.length === 'undefined') return;
    for (var i=0;i<list.length && i<4;i++){
      var dot = $('state-led' + (i + 1));
      if (dot) dot.style.background = list[i] ? '#ffb300' : '#ccc';
    }
  });

  // ---------- Controls ----------
  // Modbus config push
  $('modbus-address').addEventListener('input', pushModbus);
  $('modbus-baud').addEventListener('input',    pushModbus);
  function pushModbus() {
    var mb_address = parseInt($('modbus-address').value || "3", 10);
    var mb_baud    = parseInt($('modbus-baud').value    || "19200", 10);
    connection.send("values", { mb_address: mb_address, mb_baud: mb_baud });
    appendLog("values", { mb_address: mb_address, mb_baud: mb_baud });
  }

  // Apply meter options
  $('apply-meter').addEventListener('click', function(){
    var cfg = {
      lineHz:    parseInt($('opt-lineHz').value   || "50", 10),
      sumAbs:    parseInt($('opt-sumAbs').value   || "1", 10),
      ucal:      parseInt($('opt-ucal').value     || "25256", 10),
      sample_ms: parseInt($('opt-samplems').value || "200", 10),
      p_mW_per_lsb:        parseInt($('sc-p').value   || "1", 10),
      q_mvar_x1k_per_lsb:  parseInt($('sc-q').value   || "1", 10),
      s_mva_x1k_per_lsb:   parseInt($('sc-s').value   || "1", 10),
      e_ap_kWh_x1e5:       parseInt($('sc-eap').value || "1", 10),
      e_an_kWh_x1e5:       parseInt($('sc-ean').value || "1", 10),
      e_rp_kvarh_x1e5:     parseInt($('sc-erp').value || "1", 10),
      e_rn_kvarh_x1e5:     parseInt($('sc-ern').value || "1", 10),
      e_s_kVAh_x1e5:       parseInt($('sc-es').value  || "1", 10)
    };
    connection.send("Config", { t:"meter", cfg: cfg });
    appendLog("Config.meter", cfg);
  });

  // Apply scales only
  $('apply-scale').addEventListener('click', function(){
    var cfg = {
      lineHz:    parseInt($('opt-lineHz').value   || "50", 10),
      sumAbs:    parseInt($('opt-sumAbs').value   || "1", 10),
      ucal:      parseInt($('opt-ucal').value     || "25256", 10),
      sample_ms: parseInt($('opt-samplems').value || "200", 10),
      p_mW_per_lsb:        parseInt($('sc-p').value   || "1", 10),
      q_mvar_x1k_per_lsb:  parseInt($('sc-q').value   || "1", 10),
      s_mva_x1k_per_lsb:   parseInt($('sc-s').value   || "1", 10),
      e_ap_kWh_x1e5:       parseInt($('sc-eap').value || "1", 10),
      e_an_kWh_x1e5:       parseInt($('sc-ean').value || "1", 10),
      e_rp_kvarh_x1e5:     parseInt($('sc-erp').value || "1", 10),
      e_rn_kWh_x1e5:       parseInt($('sc-ern').value || "1", 10),
      e_s_kVAh_x1e5:       parseInt($('sc-es').value  || "1", 10)
    };
    connection.send("Config", { t:"meter", cfg: cfg });
    appendLog("Config.scale", cfg);
  });

  // Enable buttons on connect
  onPortStateChange();
})();
</script>
